"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2016],{19:function(e,t,n){n.d(t,{$q:function(){return Jl},AK:function(){return Eh},Ab:function(){return xh},B$:function(){return Su},Bt:function(){return Th},Cf:function(){return gu},EK:function(){return q},ET:function(){return dh},Eo:function(){return _u},F8:function(){return Wu},Fc:function(){return Pu},GL:function(){return gh},IO:function(){return Dl},IX:function(){return ku},Ix:function(){return Uu},JU:function(){return xu},Jj:function(){return $u},K9:function(){return b},Ky:function(){return $},L$:function(){return Gu},Lx:function(){return Ul},Lz:function(){return ju},Me:function(){return ot},Mx:function(){return qu},PL:function(){return oh},PU:function(){return wh},Pb:function(){return zu},QT:function(){return nh},ST:function(){return Mu},TF:function(){return Bu},TQ:function(){return Pl},UQ:function(){return ah},Ub:function(){return m},W:function(){return Zl},WA:function(){return S},Wi:function(){return hu},Wu:function(){return Bl},Xb:function(){return K},Xk:function(){return ih},Xo:function(){return Rl},ar:function(){return Cl},at:function(){return vu},b9:function(){return Vl},cf:function(){return fh},e0:function(){return Ol},fH:function(){return Lu},hJ:function(){return Tu},i3:function(){return bh},iE:function(){return Du},kl:function(){return sh},l7:function(){return pt},my:function(){return Iu},nP:function(){return _h},oe:function(){return hh},pl:function(){return uh},qK:function(){return th},qY:function(){return Fu},r7:function(){return lh},sc:function(){return mh},u7:function(){return Ql},vh:function(){return Ml},vr:function(){return Sh},xU:function(){return Xl},yq:function(){return y},zN:function(){return ch}});var r=n(25816),s=n(8463),i=n(53333),o=n(74444),a=n(46640),c=n(83454);const u="@firebase/firestore";class l{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}l.UNAUTHENTICATED=new l(null),l.GOOGLE_CREDENTIALS=new l("google-credentials-uid"),l.FIRST_PARTY=new l("first-party-uid"),l.MOCK_USER=new l("mock-user");let h="9.23.0";const d=new i.Yd("@firebase/firestore");function f(){return d.logLevel}function m(e){d.setLogLevel(e)}function g(e,...t){if(d.logLevel<=i.in.DEBUG){const n=t.map(w);d.debug(`Firestore (${h}): ${e}`,...n)}}function p(e,...t){if(d.logLevel<=i.in.ERROR){const n=t.map(w);d.error(`Firestore (${h}): ${e}`,...n)}}function y(e,...t){if(d.logLevel<=i.in.WARN){const n=t.map(w);d.warn(`Firestore (${h}): ${e}`,...n)}}function w(e){if("string"==typeof e)return e;try{return t=e,JSON.stringify(t)}catch(t){return e}var t}function v(e="Unexpected state"){const t=`FIRESTORE (${h}) INTERNAL ASSERTION FAILED: `+e;throw p(t),new Error(t)}function I(e,t){e||v()}function b(e,t){e||v()}function E(e,t){return e}const T={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class S extends o.ZR{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class x{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class _{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class D{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(l.UNAUTHENTICATED)))}shutdown(){}}class N{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable((()=>t(this.token.user)))}shutdown(){this.changeListener=null}}class C{constructor(e){this.t=e,this.currentUser=l.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let n=this.i;const r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let s=new x;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new x,e.enqueueRetryable((()=>r(this.currentUser)))};const i=()=>{const t=s;e.enqueueRetryable((async()=>{await t.promise,await r(this.currentUser)}))},o=e=>{g("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((e=>o(e))),setTimeout((()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?o(e):(g("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new x)}}),0),i()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?(g("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(I("string"==typeof t.accessToken),new _(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const e=this.auth&&this.auth.getUid();return I(null===e||"string"==typeof e),new l(e)}}class A{constructor(e,t,n){this.h=e,this.l=t,this.m=n,this.type="FirstParty",this.user=l.FIRST_PARTY,this.g=new Map}p(){return this.m?this.m():null}get headers(){this.g.set("X-Goog-AuthUser",this.h);const e=this.p();return e&&this.g.set("Authorization",e),this.l&&this.g.set("X-Goog-Iam-Authorization-Token",this.l),this.g}}class k{constructor(e,t,n){this.h=e,this.l=t,this.m=n}getToken(){return Promise.resolve(new A(this.h,this.l,this.m))}start(e,t){e.enqueueRetryable((()=>t(l.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class R{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class F{constructor(e){this.I=e,this.forceRefresh=!1,this.appCheck=null,this.T=null}start(e,t){const n=e=>{null!=e.error&&g("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.T;return this.T=e.token,g("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable((()=>n(t)))};const r=e=>{g("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.I.onInit((e=>r(e))),setTimeout((()=>{if(!this.appCheck){const e=this.I.getImmediate({optional:!0});e?r(e):g("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(I("string"==typeof e.token),this.T=e.token,new R(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}function V(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let r=0;r<e;r++)n[r]=Math.floor(256*Math.random());return n}class M{static A(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length;let n="";for(;n.length<20;){const r=V(40);for(let s=0;s<r.length;++s)n.length<20&&r[s]<t&&(n+=e.charAt(r[s]%e.length))}return n}}function L(e,t){return e<t?-1:e>t?1:0}function O(e,t,n){return e.length===t.length&&e.every(((e,r)=>n(e,t[r])))}function P(e){return e+"\0"}class q{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new S(T.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new S(T.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new S(T.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new S(T.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return q.fromMillis(Date.now())}static fromDate(e){return q.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new q(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?L(this.nanoseconds,e.nanoseconds):L(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class U{constructor(e){this.timestamp=e}static fromTimestamp(e){return new U(e)}static min(){return new U(new q(0,0))}static max(){return new U(new q(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class B{constructor(e,t,n){void 0===t?t=0:t>e.length&&v(),void 0===n?n=e.length-t:n>e.length-t&&v(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===B.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof B?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),s=t.get(r);if(n<s)return-1;if(n>s)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class z extends B{construct(e,t,n){return new z(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new S(T.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter((e=>e.length>0)))}return new z(t)}static emptyPath(){return new z([])}}const G=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class K extends B{construct(e,t,n){return new K(e,t,n)}static isValidIdentifier(e){return G.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),K.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new K(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;const s=()=>{if(0===n.length)throw new S(T.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new S(T.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new S(T.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?(i=!i,r++):"."!==t||i?(n+=t,r++):(s(),r++)}if(s(),i)throw new S(T.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new K(t)}static emptyPath(){return new K([])}}class ${constructor(e){this.path=e}static fromPath(e){return new $(z.fromString(e))}static fromName(e){return new $(z.fromString(e).popFirst(5))}static empty(){return new $(z.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===z.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return z.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new $(new z(e.slice()))}}class j{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function Q(e){return e.fields.find((e=>2===e.kind))}function W(e){return e.fields.filter((e=>2!==e.kind))}j.UNKNOWN_ID=-1;class H{constructor(e,t){this.fieldPath=e,this.kind=t}}class Y{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new Y(0,Z.min())}}function X(e,t){const n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,s=U.fromTimestamp(1e9===r?new q(n+1,0):new q(n,r));return new Z(s,$.empty(),t)}function J(e){return new Z(e.readTime,e.key,-1)}class Z{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new Z(U.min(),$.empty(),-1)}static max(){return new Z(U.max(),$.empty(),-1)}}function ee(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=$.comparator(e.documentKey,t.documentKey),0!==n?n:L(e.largestBatchId,t.largestBatchId))}const te="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ne{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}async function re(e){if(e.code!==T.FAILED_PRECONDITION||e.message!==te)throw e;g("LocalStore","Unexpectedly lost primary lease")}class se{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&v(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new se(((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof se?t:se.resolve(t)}catch(e){return se.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):se.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):se.reject(t)}static resolve(e){return new se(((t,n)=>{t(e)}))}static reject(e){return new se(((t,n)=>{n(e)}))}static waitFor(e){return new se(((t,n)=>{let r=0,s=0,i=!1;e.forEach((e=>{++r,e.next((()=>{++s,i&&s===r&&t()}),(e=>n(e)))})),i=!0,s===r&&t()}))}static or(e){let t=se.resolve(!1);for(const n of e)t=t.next((e=>e?se.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,r)=>{n.push(t.call(this,e,r))})),this.waitFor(n)}static mapArray(e,t){return new se(((n,r)=>{const s=e.length,i=new Array(s);let o=0;for(let a=0;a<s;a++){const c=a;t(e[c]).next((e=>{i[c]=e,++o,o===s&&n(i)}),(e=>r(e)))}}))}static doWhile(e,t){return new se(((n,r)=>{const s=()=>{!0===e()?t().next((()=>{s()}),r):n()};s()}))}}class ie{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.v=new x,this.transaction.oncomplete=()=>{this.v.resolve()},this.transaction.onabort=()=>{t.error?this.v.reject(new ce(e,t.error)):this.v.resolve()},this.transaction.onerror=t=>{const n=fe(t.target.error);this.v.reject(new ce(e,n))}}static open(e,t,n,r){try{return new ie(t,e.transaction(r,n))}catch(e){throw new ce(t,e)}}get R(){return this.v.promise}abort(e){e&&this.v.reject(e),this.aborted||(g("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}P(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){const t=this.transaction.objectStore(e);return new le(t)}}class oe{constructor(e,t,n){this.name=e,this.version=t,this.V=n,12.2===oe.S((0,o.z$)())&&p("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return g("SimpleDb","Removing database:",e),he(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!(0,o.hl)())return!1;if(oe.C())return!0;const e=(0,o.z$)(),t=oe.S(e),n=0<t&&t<10,r=oe.N(e),s=0<r&&r<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||n||s)}static C(){var e;return"undefined"!=typeof c&&"YES"===(null===(e=c.env)||void 0===e?void 0:e.k)}static M(e,t){return e.store(t)}static S(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static N(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async $(e){return this.db||(g("SimpleDb","Opening database:",this.name),this.db=await new Promise(((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{const n=e.target.result;t(n)},r.onblocked=()=>{n(new ce(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{const r=t.target.error;"VersionError"===r.name?n(new S(T.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new S(T.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new ce(e,r))},r.onupgradeneeded=e=>{g("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);const t=e.target.result;this.V.O(t,r.transaction,e.oldVersion,this.version).next((()=>{g("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.F&&(this.db.onversionchange=e=>this.F(e)),this.db}B(e){this.F=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){const s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.$(e);const t=ie.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next((e=>(t.P(),e))).catch((e=>(t.abort(e),se.reject(e)))).toPromise();return i.catch((()=>{})),await t.R,i}catch(e){const t=e,n="FirebaseError"!==t.name&&i<3;if(g("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class ae{constructor(e){this.L=e,this.q=!1,this.U=null}get isDone(){return this.q}get K(){return this.U}set cursor(e){this.L=e}done(){this.q=!0}G(e){this.U=e}delete(){return he(this.L.delete())}}class ce extends S{constructor(e,t){super(T.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function ue(e){return"IndexedDbTransactionError"===e.name}class le{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(g("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(g("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),he(n)}add(e){return g("SimpleDb","ADD",this.store.name,e,e),he(this.store.add(e))}get(e){return he(this.store.get(e)).next((t=>(void 0===t&&(t=null),g("SimpleDb","GET",this.store.name,e,t),t)))}delete(e){return g("SimpleDb","DELETE",this.store.name,e),he(this.store.delete(e))}count(){return g("SimpleDb","COUNT",this.store.name),he(this.store.count())}j(e,t){const n=this.options(e,t);if(n.index||"function"!=typeof this.store.getAll){const e=this.cursor(n),t=[];return this.W(e,((e,n)=>{t.push(n)})).next((()=>t))}{const e=this.store.getAll(n.range);return new se(((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}}))}}H(e,t){const n=this.store.getAll(e,null===t?void 0:t);return new se(((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}}))}J(e,t){g("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.Y=!1;const r=this.cursor(n);return this.W(r,((e,t,n)=>n.delete()))}X(e,t){let n;t?n=e:(n={},t=e);const r=this.cursor(n);return this.W(r,t)}Z(e){const t=this.cursor({});return new se(((n,r)=>{t.onerror=e=>{const t=fe(e.target.error);r(t)},t.onsuccess=t=>{const r=t.target.result;r?e(r.primaryKey,r.value).next((e=>{e?r.continue():n()})):n()}}))}W(e,t){const n=[];return new se(((r,s)=>{e.onerror=e=>{s(e.target.error)},e.onsuccess=e=>{const s=e.target.result;if(!s)return void r();const i=new ae(s),o=t(s.primaryKey,s.value,i);if(o instanceof se){const e=o.catch((e=>(i.done(),se.reject(e))));n.push(e)}i.isDone?r():null===i.K?s.continue():s.continue(i.K)}})).next((()=>se.waitFor(n)))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.Y?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function he(e){return new se(((t,n)=>{e.onsuccess=e=>{const n=e.target.result;t(n)},e.onerror=e=>{const t=fe(e.target.error);n(t)}}))}let de=!1;function fe(e){const t=oe.S((0,o.z$)());if(t>=12.2&&t<13){const t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){const e=new S("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return de||(de=!0,setTimeout((()=>{throw e}),0)),e}}return e}class me{constructor(e,t){this.asyncQueue=e,this.tt=t,this.task=null}start(){this.et(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}et(e){g("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,(async()=>{this.task=null;try{g("IndexBackiller",`Documents written: ${await this.tt.nt()}`)}catch(e){ue(e)?g("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await re(e)}await this.et(6e4)}))}}class ge{constructor(e,t){this.localStore=e,this.persistence=t}async nt(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(t=>this.st(t,e)))}st(e,t){const n=new Set;let r=t,s=!0;return se.doWhile((()=>!0===s&&r>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next((t=>{if(null!==t&&!n.has(t))return g("IndexBackiller",`Processing collection: ${t}`),this.it(e,t,r).next((e=>{r-=e,n.add(t)}));s=!1})))).next((()=>t-r))}it(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next((r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next((n=>{const s=n.changes;return this.localStore.indexManager.updateIndexEntries(e,s).next((()=>this.rt(r,n))).next((n=>(g("IndexBackiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n)))).next((()=>s.size))}))))}rt(e,t){let n=e;return t.changes.forEach(((e,t)=>{const r=J(t);ee(r,n)>0&&(n=r)})),new Z(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class pe{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ot(e),this.ut=e=>t.writeSequenceNumber(e))}ot(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.ut&&this.ut(e),e}}function ye(e){return null==e}function we(e){return 0===e&&1/e==-1/0}function ve(e){return"number"==typeof e&&Number.isInteger(e)&&!we(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function Ie(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t=Ee(t)),t=be(e.get(n),t);return Ee(t)}function be(e,t){let n=t;const r=e.length;for(let s=0;s<r;s++){const t=e.charAt(s);switch(t){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=t}}return n}function Ee(e){return e+"\x01\x01"}function Te(e){const t=e.length;if(I(t>=2),2===t)return I("\x01"===e.charAt(0)&&"\x01"===e.charAt(1)),z.emptyPath();const n=t-2,r=[];let s="";for(let i=0;i<t;){const t=e.indexOf("\x01",i);switch((t<0||t>n)&&v(),e.charAt(t+1)){case"\x01":const n=e.substring(i,t);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"\x10":s+=e.substring(i,t),s+="\0";break;case"\x11":s+=e.substring(i,t+1);break;default:v()}i=t+2}return new z(r)}pe.ct=-1;const Se=["userId","batchId"];function xe(e,t){return[e,Ie(t)]}function _e(e,t,n){return[e,Ie(t),n]}const De={},Ne=["prefixPath","collectionGroup","readTime","documentId"],Ce=["prefixPath","collectionGroup","documentId"],Ae=["collectionGroup","readTime","prefixPath","documentId"],ke=["canonicalId","targetId"],Re=["targetId","path"],Fe=["path","targetId"],Ve=["collectionId","parent"],Me=["indexId","uid"],Le=["uid","sequenceNumber"],Oe=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Pe=["indexId","uid","orderedDocumentKey"],qe=["userId","collectionPath","documentId"],Ue=["userId","collectionPath","largestBatchId"],Be=["userId","collectionGroup","largestBatchId"],ze=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Ge=[...ze,"documentOverlays"],Ke=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],$e=Ke,je=[...$e,"indexConfiguration","indexState","indexEntries"];class Qe extends ne{constructor(e,t){super(),this.ht=e,this.currentSequenceNumber=t}}function We(e,t){const n=E(e);return oe.M(n.ht,t)}function He(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function Ye(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function Xe(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class Je{constructor(e,t){this.comparator=e,this.root=t||et.EMPTY}insert(e,t){return new Je(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,et.BLACK,null,null))}remove(e){return new Je(this.comparator,this.root.remove(e,this.comparator).copy(null,null,et.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push(`${t}:${n}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new Ze(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new Ze(this.root,e,this.comparator,!1)}getReverseIterator(){return new Ze(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new Ze(this.root,e,this.comparator,!0)}}class Ze{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class et{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:et.RED,this.left=null!=r?r:et.EMPTY,this.right=null!=s?s:et.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new et(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;const s=n(e,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return et.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return et.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,et.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,et.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw v();if(this.right.isRed())throw v();const e=this.left.check();if(e!==this.right.check())throw v();return e+(this.isRed()?0:1)}}et.EMPTY=null,et.RED=!0,et.BLACK=!1,et.EMPTY=new class{constructor(){this.size=0}get key(){throw v()}get value(){throw v()}get color(){throw v()}get left(){throw v()}get right(){throw v()}copy(e,t,n,r,s){return this}insert(e,t,n){return new et(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class tt{constructor(e){this.comparator=e,this.data=new Je(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new nt(this.data.getIterator())}getIteratorFrom(e){return new nt(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof tt))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new tt(this.comparator);return t.data=e,t}}class nt{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function rt(e){return e.hasNext()?e.getNext():void 0}class st{constructor(e){this.fields=e,e.sort(K.comparator)}static empty(){return new st([])}unionWith(e){let t=new tt(K.comparator);for(const n of this.fields)t=t.add(n);for(const n of e)t=t.add(n);return new st(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return O(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}class it extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}function ot(){return"undefined"!=typeof atob}class at{constructor(e){this.binaryString=e}static fromBase64String(e){const t=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new it("Invalid base64 string: "+e):e}}(e);return new at(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new at(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return L(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}at.EMPTY_BYTE_STRING=new at("");const ct=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function ut(e){if(I(!!e),"string"==typeof e){let t=0;const n=ct.exec(e);if(I(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}return{seconds:lt(e.seconds),nanos:lt(e.nanos)}}function lt(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function ht(e){return"string"==typeof e?at.fromBase64String(e):at.fromUint8Array(e)}function dt(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function ft(e){const t=e.mapValue.fields.__previous_value__;return dt(t)?ft(t):t}function mt(e){const t=ut(e.mapValue.fields.__local_write_time__.timestampValue);return new q(t.seconds,t.nanos)}class gt{constructor(e,t,n,r,s,i,o,a,c){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.longPollingOptions=a,this.useFetchStreams=c}}class pt{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new pt("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof pt&&e.projectId===this.projectId&&e.database===this.database}}const yt={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},wt={nullValue:"NULL_VALUE"};function vt(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?dt(e)?4:Ft(e)?9007199254740991:10:v()}function It(e,t){if(e===t)return!0;const n=vt(e);if(n!==vt(t))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return mt(e).isEqual(mt(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=ut(e.timestampValue),r=ut(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return ht(e.bytesValue).isEqual(ht(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return lt(e.geoPointValue.latitude)===lt(t.geoPointValue.latitude)&&lt(e.geoPointValue.longitude)===lt(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return lt(e.integerValue)===lt(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=lt(e.doubleValue),r=lt(t.doubleValue);return n===r?we(n)===we(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return O(e.arrayValue.values||[],t.arrayValue.values||[],It);case 10:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(He(n)!==He(r))return!1;for(const s in n)if(n.hasOwnProperty(s)&&(void 0===r[s]||!It(n[s],r[s])))return!1;return!0}(e,t);default:return v()}}function bt(e,t){return void 0!==(e.values||[]).find((e=>It(e,t)))}function Et(e,t){if(e===t)return 0;const n=vt(e),r=vt(t);if(n!==r)return L(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return L(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=lt(e.integerValue||e.doubleValue),r=lt(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return Tt(e.timestampValue,t.timestampValue);case 4:return Tt(mt(e),mt(t));case 5:return L(e.stringValue,t.stringValue);case 6:return function(e,t){const n=ht(e),r=ht(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),r=t.split("/");for(let s=0;s<n.length&&s<r.length;s++){const e=L(n[s],r[s]);if(0!==e)return e}return L(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=L(lt(e.latitude),lt(t.latitude));return 0!==n?n:L(lt(e.longitude),lt(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return function(e,t){const n=e.values||[],r=t.values||[];for(let s=0;s<n.length&&s<r.length;++s){const e=Et(n[s],r[s]);if(e)return e}return L(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===yt.mapValue&&t===yt.mapValue)return 0;if(e===yt.mapValue)return 1;if(t===yt.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),s=t.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let o=0;o<r.length&&o<i.length;++o){const e=L(r[o],i[o]);if(0!==e)return e;const t=Et(n[r[o]],s[i[o]]);if(0!==t)return t}return L(r.length,i.length)}(e.mapValue,t.mapValue);default:throw v()}}function Tt(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return L(e,t);const n=ut(e),r=ut(t),s=L(n.seconds,r.seconds);return 0!==s?s:L(n.nanos,r.nanos)}function St(e){return xt(e)}function xt(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=ut(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?ht(e.bytesValue).toBase64():"referenceValue"in e?(n=e.referenceValue,$.fromName(n).toString()):"geoPointValue"in e?`geo(${(t=e.geoPointValue).latitude},${t.longitude})`:"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=xt(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const s of t)r?r=!1:n+=",",n+=`${s}:${xt(e.fields[s])}`;return n+"}"}(e.mapValue):v();var t,n}function _t(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Dt(e){return!!e&&"integerValue"in e}function Nt(e){return!!e&&"arrayValue"in e}function Ct(e){return!!e&&"nullValue"in e}function At(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function kt(e){return!!e&&"mapValue"in e}function Rt(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return Ye(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=Rt(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=Rt(e.arrayValue.values[n]);return t}return Object.assign({},e)}function Ft(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function Vt(e){return"nullValue"in e?wt:"booleanValue"in e?{booleanValue:!1}:"integerValue"in e||"doubleValue"in e?{doubleValue:NaN}:"timestampValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in e?{stringValue:""}:"bytesValue"in e?{bytesValue:""}:"referenceValue"in e?_t(pt.empty(),$.empty()):"geoPointValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in e?{arrayValue:{}}:"mapValue"in e?{mapValue:{}}:v()}function Mt(e){return"nullValue"in e?{booleanValue:!1}:"booleanValue"in e?{doubleValue:NaN}:"integerValue"in e||"doubleValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in e?{stringValue:""}:"stringValue"in e?{bytesValue:""}:"bytesValue"in e?_t(pt.empty(),$.empty()):"referenceValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in e?{arrayValue:{}}:"arrayValue"in e?{mapValue:{}}:"mapValue"in e?yt:v()}function Lt(e,t){const n=Et(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function Ot(e,t){const n=Et(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class Pt{constructor(e){this.value=e}static empty(){return new Pt({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!kt(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Rt(t)}setAll(e){let t=K.emptyPath(),n={},r=[];e.forEach(((e,s)=>{if(!t.isImmediateParentOf(s)){const e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=s.popLast()}e?n[s.lastSegment()]=Rt(e):r.push(s.lastSegment())}));const s=this.getFieldsMap(t);this.applyChanges(s,n,r)}delete(e){const t=this.field(e.popLast());kt(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return It(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];kt(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){Ye(t,((t,n)=>e[t]=n));for(const r of n)delete e[r]}clone(){return new Pt(Rt(this.value))}}function qt(e){const t=[];return Ye(e.fields,((e,n)=>{const r=new K([e]);if(kt(n)){const e=qt(n.mapValue).fields;if(0===e.length)t.push(r);else for(const n of e)t.push(r.child(n))}else t.push(r)})),new st(t)}class Ut{constructor(e,t,n,r,s,i,o){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=s,this.data=i,this.documentState=o}static newInvalidDocument(e){return new Ut(e,0,U.min(),U.min(),U.min(),Pt.empty(),0)}static newFoundDocument(e,t,n,r){return new Ut(e,1,t,U.min(),n,r,0)}static newNoDocument(e,t){return new Ut(e,2,t,U.min(),U.min(),Pt.empty(),0)}static newUnknownDocument(e,t){return new Ut(e,3,t,U.min(),U.min(),Pt.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(U.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Pt.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Pt.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=U.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Ut&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Ut(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Bt{constructor(e,t){this.position=e,this.inclusive=t}}function zt(e,t,n){let r=0;for(let s=0;s<e.position.length;s++){const i=t[s],o=e.position[s];if(r=i.field.isKeyField()?$.comparator($.fromName(o.referenceValue),n.key):Et(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function Gt(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!It(e.position[n],t.position[n]))return!1;return!0}class Kt{constructor(e,t="asc"){this.field=e,this.dir=t}}function $t(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}class jt{}class Qt extends jt{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new rn(e,t,n):"array-contains"===t?new cn(e,n):"in"===t?new un(e,n):"not-in"===t?new ln(e,n):"array-contains-any"===t?new hn(e,n):new Qt(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new sn(e,n):new on(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(Et(t,this.value)):null!==t&&vt(this.value)===vt(t)&&this.matchesComparison(Et(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return v()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}getFirstInequalityField(){return this.isInequality()?this.field:null}}class Wt extends jt{constructor(e,t){super(),this.filters=e,this.op=t,this.lt=null}static create(e,t){return new Wt(e,t)}matches(e){return Ht(this)?void 0===this.filters.find((t=>!t.matches(e))):void 0!==this.filters.find((t=>t.matches(e)))}getFlattenedFilters(){return null!==this.lt||(this.lt=this.filters.reduce(((e,t)=>e.concat(t.getFlattenedFilters())),[])),this.lt}getFilters(){return Object.assign([],this.filters)}getFirstInequalityField(){const e=this.ft((e=>e.isInequality()));return null!==e?e.field:null}ft(e){for(const t of this.getFlattenedFilters())if(e(t))return t;return null}}function Ht(e){return"and"===e.op}function Yt(e){return"or"===e.op}function Xt(e){return Jt(e)&&Ht(e)}function Jt(e){for(const t of e.filters)if(t instanceof Wt)return!1;return!0}function Zt(e){if(e instanceof Qt)return e.field.canonicalString()+e.op.toString()+St(e.value);if(Xt(e))return e.filters.map((e=>Zt(e))).join(",");{const t=e.filters.map((e=>Zt(e))).join(",");return`${e.op}(${t})`}}function en(e,t){return e instanceof Qt?function(e,t){return t instanceof Qt&&e.op===t.op&&e.field.isEqual(t.field)&&It(e.value,t.value)}(e,t):e instanceof Wt?function(e,t){return t instanceof Wt&&e.op===t.op&&e.filters.length===t.filters.length&&e.filters.reduce(((e,n,r)=>e&&en(n,t.filters[r])),!0)}(e,t):void v()}function tn(e,t){const n=e.filters.concat(t);return Wt.create(n,e.op)}function nn(e){return e instanceof Qt?function(e){return`${e.field.canonicalString()} ${e.op} ${St(e.value)}`}(e):e instanceof Wt?function(e){return e.op.toString()+" {"+e.getFilters().map(nn).join(" ,")+"}"}(e):"Filter"}class rn extends Qt{constructor(e,t,n){super(e,t,n),this.key=$.fromName(n.referenceValue)}matches(e){const t=$.comparator(e.key,this.key);return this.matchesComparison(t)}}class sn extends Qt{constructor(e,t){super(e,"in",t),this.keys=an("in",t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class on extends Qt{constructor(e,t){super(e,"not-in",t),this.keys=an("not-in",t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function an(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>$.fromName(e.referenceValue)))}class cn extends Qt{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return Nt(t)&&bt(t.arrayValue,this.value)}}class un extends Qt{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&bt(this.value.arrayValue,t)}}class ln extends Qt{constructor(e,t){super(e,"not-in",t)}matches(e){if(bt(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!bt(this.value.arrayValue,t)}}class hn extends Qt{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Nt(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>bt(this.value.arrayValue,e)))}}class dn{constructor(e,t=null,n=[],r=[],s=null,i=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.dt=null}}function fn(e,t=null,n=[],r=[],s=null,i=null,o=null){return new dn(e,t,n,r,s,i,o)}function mn(e){const t=E(e);if(null===t.dt){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>Zt(e))).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),ye(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((e=>St(e))).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((e=>St(e))).join(",")),t.dt=e}return t.dt}function gn(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let n=0;n<e.orderBy.length;n++)if(!$t(e.orderBy[n],t.orderBy[n]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!en(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Gt(e.startAt,t.startAt)&&Gt(e.endAt,t.endAt)}function pn(e){return $.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function yn(e,t){return e.filters.filter((e=>e instanceof Qt&&e.field.isEqual(t)))}function wn(e,t,n){let r=wt,s=!0;for(const i of yn(e,t)){let e=wt,t=!0;switch(i.op){case"<":case"<=":e=Vt(i.value);break;case"==":case"in":case">=":e=i.value;break;case">":e=i.value,t=!1;break;case"!=":case"not-in":e=wt}Lt({value:r,inclusive:s},{value:e,inclusive:t})<0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];Lt({value:r,inclusive:s},{value:e,inclusive:n.inclusive})<0&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}function vn(e,t,n){let r=yt,s=!0;for(const i of yn(e,t)){let e=yt,t=!0;switch(i.op){case">=":case">":e=Mt(i.value),t=!1;break;case"==":case"in":case"<=":e=i.value;break;case"<":e=i.value,t=!1;break;case"!=":case"not-in":e=yt}Ot({value:r,inclusive:s},{value:e,inclusive:t})>0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];Ot({value:r,inclusive:s},{value:e,inclusive:n.inclusive})>0&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}class In{constructor(e,t=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.wt=null,this._t=null,this.startAt,this.endAt}}function bn(e,t,n,r,s,i,o,a){return new In(e,t,n,r,s,i,o,a)}function En(e){return new In(e)}function Tn(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Sn(e){return e.explicitOrderBy.length>0?e.explicitOrderBy[0].field:null}function xn(e){for(const t of e.filters){const e=t.getFirstInequalityField();if(null!==e)return e}return null}function _n(e){return null!==e.collectionGroup}function Dn(e){const t=E(e);if(null===t.wt){t.wt=[];const e=xn(t),n=Sn(t);if(null!==e&&null===n)e.isKeyField()||t.wt.push(new Kt(e)),t.wt.push(new Kt(K.keyField(),"asc"));else{let e=!1;for(const n of t.explicitOrderBy)t.wt.push(n),n.field.isKeyField()&&(e=!0);if(!e){const e=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";t.wt.push(new Kt(K.keyField(),e))}}}return t.wt}function Nn(e){const t=E(e);if(!t._t)if("F"===t.limitType)t._t=fn(t.path,t.collectionGroup,Dn(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const s of Dn(t)){const t="desc"===s.dir?"asc":"desc";e.push(new Kt(s.field,t))}const n=t.endAt?new Bt(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new Bt(t.startAt.position,t.startAt.inclusive):null;t._t=fn(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}return t._t}function Cn(e,t){t.getFirstInequalityField(),xn(e);const n=e.filters.concat([t]);return new In(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function An(e,t,n){return new In(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function kn(e,t){return gn(Nn(e),Nn(t))&&e.limitType===t.limitType}function Rn(e){return`${mn(Nn(e))}|lt:${e.limitType}`}function Fn(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map((e=>nn(e))).join(", ")}]`),ye(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map((e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e))).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((e=>St(e))).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((e=>St(e))).join(",")),`Target(${t})`}(Nn(e))}; limitType=${e.limitType})`}function Vn(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):$.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of Dn(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){const r=zt(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,Dn(e),t))&&!(e.endAt&&!function(e,t,n){const r=zt(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,Dn(e),t))}(e,t)}function Mn(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function Ln(e){return(t,n)=>{let r=!1;for(const s of Dn(e)){const e=On(s,t,n);if(0!==e)return e;r=r||s.field.isKeyField()}return 0}}function On(e,t,n){const r=e.field.isKeyField()?$.comparator(t.key,n.key):function(e,t,n){const r=t.data.field(e),s=n.data.field(e);return null!==r&&null!==s?Et(r,s):v()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return v()}}class Pn{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[r,s]of n)if(this.equalsFn(r,e))return s}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let s=0;s<r.length;s++)if(this.equalsFn(r[s][0],e))return void(r[s]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){Ye(this.inner,((t,n)=>{for(const[r,s]of n)e(r,s)}))}isEmpty(){return Xe(this.inner)}size(){return this.innerSize}}const qn=new Je($.comparator);function Un(){return qn}const Bn=new Je($.comparator);function zn(...e){let t=Bn;for(const n of e)t=t.insert(n.key,n);return t}function Gn(e){let t=Bn;return e.forEach(((e,n)=>t=t.insert(e,n.overlayedDocument))),t}function Kn(){return jn()}function $n(){return jn()}function jn(){return new Pn((e=>e.toString()),((e,t)=>e.isEqual(t)))}const Qn=new Je($.comparator),Wn=new tt($.comparator);function Hn(...e){let t=Wn;for(const n of e)t=t.add(n);return t}const Yn=new tt(L);function Xn(){return Yn}function Jn(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:we(t)?"-0":t}}function Zn(e){return{integerValue:""+e}}function er(e,t){return ve(t)?Zn(t):Jn(e,t)}class tr{constructor(){this._=void 0}}function nr(e,t,n){return e instanceof ir?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&dt(t)&&(t=ft(t)),t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof or?ar(e,t):e instanceof cr?ur(e,t):function(e,t){const n=sr(e,t),r=hr(n)+hr(e.gt);return Dt(n)&&Dt(e.gt)?Zn(r):Jn(e.serializer,r)}(e,t)}function rr(e,t,n){return e instanceof or?ar(e,t):e instanceof cr?ur(e,t):n}function sr(e,t){return e instanceof lr?Dt(n=t)||function(e){return!!e&&"doubleValue"in e}(n)?t:{integerValue:0}:null;var n}class ir extends tr{}class or extends tr{constructor(e){super(),this.elements=e}}function ar(e,t){const n=dr(t);for(const r of e.elements)n.some((e=>It(e,r)))||n.push(r);return{arrayValue:{values:n}}}class cr extends tr{constructor(e){super(),this.elements=e}}function ur(e,t){let n=dr(t);for(const r of e.elements)n=n.filter((e=>!It(e,r)));return{arrayValue:{values:n}}}class lr extends tr{constructor(e,t){super(),this.serializer=e,this.gt=t}}function hr(e){return lt(e.integerValue||e.doubleValue)}function dr(e){return Nt(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class fr{constructor(e,t){this.field=e,this.transform=t}}class mr{constructor(e,t){this.version=e,this.transformResults=t}}class gr{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new gr}static exists(e){return new gr(void 0,e)}static updateTime(e){return new gr(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function pr(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class yr{}function wr(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new Nr(e.key,gr.none()):new Tr(e.key,e.data,gr.none());{const n=e.data,r=Pt.empty();let s=new tt(K.comparator);for(let e of t.fields)if(!s.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),s=s.add(e)}return new Sr(e.key,r,new st(s.toArray()),gr.none())}}function vr(e,t,n){e instanceof Tr?function(e,t,n){const r=e.value.clone(),s=_r(e.fieldTransforms,t,n.transformResults);r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof Sr?function(e,t,n){if(!pr(e.precondition,t))return void t.convertToUnknownDocument(n.version);const r=_r(e.fieldTransforms,t,n.transformResults),s=t.data;s.setAll(xr(e)),s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function Ir(e,t,n,r){return e instanceof Tr?function(e,t,n,r){if(!pr(e.precondition,t))return n;const s=e.value.clone(),i=Dr(e.fieldTransforms,r,t);return s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null}(e,t,n,r):e instanceof Sr?function(e,t,n,r){if(!pr(e.precondition,t))return n;const s=Dr(e.fieldTransforms,r,t),i=t.data;return i.setAll(xr(e)),i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map((e=>e.field)))}(e,t,n,r):function(e,t,n){return pr(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}(e,t,n)}function br(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=sr(r.transform,e||null);null!=s&&(null===n&&(n=Pt.empty()),n.set(r.field,s))}return n||null}function Er(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&O(e,t,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof or&&t instanceof or||e instanceof cr&&t instanceof cr?O(e.elements,t.elements,It):e instanceof lr&&t instanceof lr?It(e.gt,t.gt):e instanceof ir&&t instanceof ir}(e.transform,t.transform)}(e,t)))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class Tr extends yr{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class Sr extends yr{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function xr(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=e.data.field(n);t.set(n,r)}})),t}function _r(e,t,n){const r=new Map;I(e.length===n.length);for(let s=0;s<n.length;s++){const i=e[s],o=i.transform,a=t.data.field(i.field);r.set(i.field,rr(o,a,n[s]))}return r}function Dr(e,t,n){const r=new Map;for(const s of e){const e=s.transform,i=n.data.field(s.field);r.set(s.field,nr(e,i,t))}return r}class Nr extends yr{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Cr extends yr{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Ar{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let r=0;r<this.mutations.length;r++){const t=this.mutations[r];t.key.isEqual(e.key)&&vr(t,e,n[r])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=Ir(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=Ir(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=$n();return this.mutations.forEach((r=>{const s=e.get(r.key),i=s.overlayedDocument;let o=this.applyToLocalView(i,s.mutatedFields);o=t.has(r.key)?null:o;const a=wr(i,o);null!==a&&n.set(r.key,a),i.isValidDocument()||i.convertToNoDocument(U.min())})),n}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),Hn())}isEqual(e){return this.batchId===e.batchId&&O(this.mutations,e.mutations,((e,t)=>Er(e,t)))&&O(this.baseMutations,e.baseMutations,((e,t)=>Er(e,t)))}}class kr{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){I(e.mutations.length===n.length);let r=Qn;const s=e.mutations;for(let i=0;i<s.length;i++)r=r.insert(s[i].key,n[i].version);return new kr(e,t,n,r)}}class Rr{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Fr{constructor(e,t){this.count=e,this.unchangedNames=t}}var Vr,Mr;function Lr(e){switch(e){default:return v();case T.CANCELLED:case T.UNKNOWN:case T.DEADLINE_EXCEEDED:case T.RESOURCE_EXHAUSTED:case T.INTERNAL:case T.UNAVAILABLE:case T.UNAUTHENTICATED:return!1;case T.INVALID_ARGUMENT:case T.NOT_FOUND:case T.ALREADY_EXISTS:case T.PERMISSION_DENIED:case T.FAILED_PRECONDITION:case T.ABORTED:case T.OUT_OF_RANGE:case T.UNIMPLEMENTED:case T.DATA_LOSS:return!0}}function Or(e){if(void 0===e)return p("GRPC error has no .code"),T.UNKNOWN;switch(e){case Vr.OK:return T.OK;case Vr.CANCELLED:return T.CANCELLED;case Vr.UNKNOWN:return T.UNKNOWN;case Vr.DEADLINE_EXCEEDED:return T.DEADLINE_EXCEEDED;case Vr.RESOURCE_EXHAUSTED:return T.RESOURCE_EXHAUSTED;case Vr.INTERNAL:return T.INTERNAL;case Vr.UNAVAILABLE:return T.UNAVAILABLE;case Vr.UNAUTHENTICATED:return T.UNAUTHENTICATED;case Vr.INVALID_ARGUMENT:return T.INVALID_ARGUMENT;case Vr.NOT_FOUND:return T.NOT_FOUND;case Vr.ALREADY_EXISTS:return T.ALREADY_EXISTS;case Vr.PERMISSION_DENIED:return T.PERMISSION_DENIED;case Vr.FAILED_PRECONDITION:return T.FAILED_PRECONDITION;case Vr.ABORTED:return T.ABORTED;case Vr.OUT_OF_RANGE:return T.OUT_OF_RANGE;case Vr.UNIMPLEMENTED:return T.UNIMPLEMENTED;case Vr.DATA_LOSS:return T.DATA_LOSS;default:return v()}}(Mr=Vr||(Vr={}))[Mr.OK=0]="OK",Mr[Mr.CANCELLED=1]="CANCELLED",Mr[Mr.UNKNOWN=2]="UNKNOWN",Mr[Mr.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Mr[Mr.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Mr[Mr.NOT_FOUND=5]="NOT_FOUND",Mr[Mr.ALREADY_EXISTS=6]="ALREADY_EXISTS",Mr[Mr.PERMISSION_DENIED=7]="PERMISSION_DENIED",Mr[Mr.UNAUTHENTICATED=16]="UNAUTHENTICATED",Mr[Mr.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Mr[Mr.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Mr[Mr.ABORTED=10]="ABORTED",Mr[Mr.OUT_OF_RANGE=11]="OUT_OF_RANGE",Mr[Mr.UNIMPLEMENTED=12]="UNIMPLEMENTED",Mr[Mr.INTERNAL=13]="INTERNAL",Mr[Mr.UNAVAILABLE=14]="UNAVAILABLE",Mr[Mr.DATA_LOSS=15]="DATA_LOSS";class Pr{constructor(){this.onExistenceFilterMismatchCallbacks=new Map}static get instance(){return qr}static getOrCreateInstance(){return null===qr&&(qr=new Pr),qr}onExistenceFilterMismatch(e){const t=Symbol();return this.onExistenceFilterMismatchCallbacks.set(t,e),()=>this.onExistenceFilterMismatchCallbacks.delete(t)}notifyOnExistenceFilterMismatch(e){this.onExistenceFilterMismatchCallbacks.forEach((t=>t(e)))}}let qr=null;function Ur(){return new TextEncoder}const Br=new a.z8([4294967295,4294967295],0);function zr(e){const t=Ur().encode(e),n=new a.V8;return n.update(t),new Uint8Array(n.digest())}function Gr(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),s=t.getUint32(8,!0),i=t.getUint32(12,!0);return[new a.z8([n,r],0),new a.z8([s,i],0)]}class Kr{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new $r(`Invalid padding: ${t}`);if(n<0)throw new $r(`Invalid hash count: ${n}`);if(e.length>0&&0===this.hashCount)throw new $r(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new $r(`Invalid padding when bitmap length is 0: ${t}`);this.It=8*e.length-t,this.Tt=a.z8.fromNumber(this.It)}Et(e,t,n){let r=e.add(t.multiply(a.z8.fromNumber(n)));return 1===r.compare(Br)&&(r=new a.z8([r.getBits(0),r.getBits(1)],0)),r.modulo(this.Tt).toNumber()}At(e){return 0!=(this.bitmap[Math.floor(e/8)]&1<<e%8)}vt(e){if(0===this.It)return!1;const t=zr(e),[n,r]=Gr(t);for(let s=0;s<this.hashCount;s++){const e=this.Et(n,r,s);if(!this.At(e))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,s=new Uint8Array(Math.ceil(e/8)),i=new Kr(s,r,t);return n.forEach((e=>i.insert(e))),i}insert(e){if(0===this.It)return;const t=zr(e),[n,r]=Gr(t);for(let s=0;s<this.hashCount;s++){const e=this.Et(n,r,s);this.Rt(e)}}Rt(e){const t=Math.floor(e/8),n=e%8;this.bitmap[t]|=1<<n}}class $r extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class jr{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,Qr.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new jr(U.min(),r,new Je(L),Un(),Hn())}}class Qr{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new Qr(n,t,Hn(),Hn(),Hn())}}class Wr{constructor(e,t,n,r){this.Pt=e,this.removedTargetIds=t,this.key=n,this.bt=r}}class Hr{constructor(e,t){this.targetId=e,this.Vt=t}}class Yr{constructor(e,t,n=at.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Xr{constructor(){this.St=0,this.Dt=es(),this.Ct=at.EMPTY_BYTE_STRING,this.xt=!1,this.Nt=!0}get current(){return this.xt}get resumeToken(){return this.Ct}get kt(){return 0!==this.St}get Mt(){return this.Nt}$t(e){e.approximateByteSize()>0&&(this.Nt=!0,this.Ct=e)}Ot(){let e=Hn(),t=Hn(),n=Hn();return this.Dt.forEach(((r,s)=>{switch(s){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:v()}})),new Qr(this.Ct,this.xt,e,t,n)}Ft(){this.Nt=!1,this.Dt=es()}Bt(e,t){this.Nt=!0,this.Dt=this.Dt.insert(e,t)}Lt(e){this.Nt=!0,this.Dt=this.Dt.remove(e)}qt(){this.St+=1}Ut(){this.St-=1}Kt(){this.Nt=!0,this.xt=!0}}class Jr{constructor(e){this.Gt=e,this.Qt=new Map,this.jt=Un(),this.zt=Zr(),this.Wt=new Je(L)}Ht(e){for(const t of e.Pt)e.bt&&e.bt.isFoundDocument()?this.Jt(t,e.bt):this.Yt(t,e.key,e.bt);for(const t of e.removedTargetIds)this.Yt(t,e.key,e.bt)}Xt(e){this.forEachTarget(e,(t=>{const n=this.Zt(t);switch(e.state){case 0:this.te(t)&&n.$t(e.resumeToken);break;case 1:n.Ut(),n.kt||n.Ft(),n.$t(e.resumeToken);break;case 2:n.Ut(),n.kt||this.removeTarget(t);break;case 3:this.te(t)&&(n.Kt(),n.$t(e.resumeToken));break;case 4:this.te(t)&&(this.ee(t),n.$t(e.resumeToken));break;default:v()}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Qt.forEach(((e,n)=>{this.te(n)&&t(n)}))}ne(e){var t;const n=e.targetId,r=e.Vt.count,s=this.se(n);if(s){const i=s.target;if(pn(i))if(0===r){const e=new $(i.path);this.Yt(n,e,Ut.newNoDocument(e,U.min()))}else I(1===r);else{const s=this.ie(n);if(s!==r){const r=this.re(e,s);if(0!==r){this.ee(n);const e=2===r?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Wt=this.Wt.insert(n,e)}null===(t=Pr.instance)||void 0===t||t.notifyOnExistenceFilterMismatch(function(e,t,n){var r,s,i,o,a,c;const u={localCacheCount:t,existenceFilterCount:n.count},l=n.unchangedNames;return l&&(u.bloomFilter={applied:0===e,hashCount:null!==(r=null==l?void 0:l.hashCount)&&void 0!==r?r:0,bitmapLength:null!==(o=null===(i=null===(s=null==l?void 0:l.bits)||void 0===s?void 0:s.bitmap)||void 0===i?void 0:i.length)&&void 0!==o?o:0,padding:null!==(c=null===(a=null==l?void 0:l.bits)||void 0===a?void 0:a.padding)&&void 0!==c?c:0}),u}(r,s,e.Vt))}}}}re(e,t){const{unchangedNames:n,count:r}=e.Vt;if(!n||!n.bits)return 1;const{bits:{bitmap:s="",padding:i=0},hashCount:o=0}=n;let a,c;try{a=ht(s).toUint8Array()}catch(e){if(e instanceof it)return y("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),1;throw e}try{c=new Kr(a,i,o)}catch(e){return y(e instanceof $r?"BloomFilter error: ":"Applying bloom filter failed: ",e),1}return 0===c.It?1:r!==t-this.oe(e.targetId,c)?2:0}oe(e,t){const n=this.Gt.getRemoteKeysForTarget(e);let r=0;return n.forEach((n=>{const s=this.Gt.ue(),i=`projects/${s.projectId}/databases/${s.database}/documents/${n.path.canonicalString()}`;t.vt(i)||(this.Yt(e,n,null),r++)})),r}ce(e){const t=new Map;this.Qt.forEach(((n,r)=>{const s=this.se(r);if(s){if(n.current&&pn(s.target)){const t=new $(s.target.path);null!==this.jt.get(t)||this.ae(r,t)||this.Yt(r,t,Ut.newNoDocument(t,e))}n.Mt&&(t.set(r,n.Ot()),n.Ft())}}));let n=Hn();this.zt.forEach(((e,t)=>{let r=!0;t.forEachWhile((e=>{const t=this.se(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)})),r&&(n=n.add(e))})),this.jt.forEach(((t,n)=>n.setReadTime(e)));const r=new jr(e,t,this.Wt,this.jt,n);return this.jt=Un(),this.zt=Zr(),this.Wt=new Je(L),r}Jt(e,t){if(!this.te(e))return;const n=this.ae(e,t.key)?2:0;this.Zt(e).Bt(t.key,n),this.jt=this.jt.insert(t.key,t),this.zt=this.zt.insert(t.key,this.he(t.key).add(e))}Yt(e,t,n){if(!this.te(e))return;const r=this.Zt(e);this.ae(e,t)?r.Bt(t,1):r.Lt(t),this.zt=this.zt.insert(t,this.he(t).delete(e)),n&&(this.jt=this.jt.insert(t,n))}removeTarget(e){this.Qt.delete(e)}ie(e){const t=this.Zt(e).Ot();return this.Gt.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}qt(e){this.Zt(e).qt()}Zt(e){let t=this.Qt.get(e);return t||(t=new Xr,this.Qt.set(e,t)),t}he(e){let t=this.zt.get(e);return t||(t=new tt(L),this.zt=this.zt.insert(e,t)),t}te(e){const t=null!==this.se(e);return t||g("WatchChangeAggregator","Detected inactive target",e),t}se(e){const t=this.Qt.get(e);return t&&t.kt?null:this.Gt.le(e)}ee(e){this.Qt.set(e,new Xr),this.Gt.getRemoteKeysForTarget(e).forEach((t=>{this.Yt(e,t,null)}))}ae(e,t){return this.Gt.getRemoteKeysForTarget(e).has(t)}}function Zr(){return new Je($.comparator)}function es(){return new Je($.comparator)}const ts={asc:"ASCENDING",desc:"DESCENDING"},ns={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},rs={and:"AND",or:"OR"};class ss{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function is(e,t){return e.useProto3Json||ye(t)?t:{value:t}}function os(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function as(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function cs(e,t){return os(e,t.toTimestamp())}function us(e){return I(!!e),U.fromTimestamp(function(e){const t=ut(e);return new q(t.seconds,t.nanos)}(e))}function ls(e,t){return function(e){return new z(["projects",e.projectId,"databases",e.database])}(e).child("documents").child(t).canonicalString()}function hs(e){const t=z.fromString(e);return I(Fs(t)),t}function ds(e,t){return ls(e.databaseId,t.path)}function fs(e,t){const n=hs(t);if(n.get(1)!==e.databaseId.projectId)throw new S(T.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new S(T.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new $(ys(n))}function ms(e,t){return ls(e.databaseId,t)}function gs(e){const t=hs(e);return 4===t.length?z.emptyPath():ys(t)}function ps(e){return new z(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function ys(e){return I(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function ws(e,t,n){return{name:ds(e,t),fields:n.value.mapValue.fields}}function vs(e,t,n){const r=fs(e,t.name),s=us(t.updateTime),i=t.createTime?us(t.createTime):U.min(),o=new Pt({mapValue:{fields:t.fields}}),a=Ut.newFoundDocument(r,s,i,o);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function Is(e,t){let n;if(t instanceof Tr)n={update:ws(e,t.key,t.value)};else if(t instanceof Nr)n={delete:ds(e,t.key)};else if(t instanceof Sr)n={update:ws(e,t.key,t.data),updateMask:Rs(t.fieldMask)};else{if(!(t instanceof Cr))return v();n={verify:ds(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e,t){const n=t.transform;if(n instanceof ir)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof or)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof cr)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof lr)return{fieldPath:t.field.canonicalString(),increment:n.gt};throw v()}(0,e)))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:cs(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:v()}(e,t.precondition)),n}function bs(e,t){const n=t.currentDocument?function(e){return void 0!==e.updateTime?gr.updateTime(us(e.updateTime)):void 0!==e.exists?gr.exists(e.exists):gr.none()}(t.currentDocument):gr.none(),r=t.updateTransforms?t.updateTransforms.map((t=>function(e,t){let n=null;if("setToServerValue"in t)I("REQUEST_TIME"===t.setToServerValue),n=new ir;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new or(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new cr(e)}else"increment"in t?n=new lr(e,t.increment):v();const r=K.fromServerFormat(t.fieldPath);return new fr(r,n)}(e,t))):[];if(t.update){t.update.name;const s=fs(e,t.update.name),i=new Pt({mapValue:{fields:t.update.fields}});if(t.updateMask){const e=function(e){const t=e.fieldPaths||[];return new st(t.map((e=>K.fromServerFormat(e))))}(t.updateMask);return new Sr(s,i,e,n,r)}return new Tr(s,i,n,r)}if(t.delete){const r=fs(e,t.delete);return new Nr(r,n)}if(t.verify){const r=fs(e,t.verify);return new Cr(r,n)}return v()}function Es(e,t){return{documents:[ms(e,t.path)]}}function Ts(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=ms(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=ms(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);const s=function(e){if(0!==e.length)return ks(Wt.create(e,"and"))}(t.filters);s&&(n.structuredQuery.where=s);const i=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:Cs(e.field),direction:_s(e.dir)}}(e)))}(t.orderBy);i&&(n.structuredQuery.orderBy=i);const o=is(e,t.limit);var a;return null!==o&&(n.structuredQuery.limit=o),t.startAt&&(n.structuredQuery.startAt={before:(a=t.startAt).inclusive,values:a.position}),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),n}function Ss(e){let t=gs(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){I(1===r);const e=n.from[0];e.allDescendants?s=e.collectionId:t=t.child(e.collectionId)}let i=[];n.where&&(i=function(e){const t=xs(e);return t instanceof Wt&&Xt(t)?t.getFilters():[t]}(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((e=>function(e){return new Kt(As(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e))));let a=null;n.limit&&(a=function(e){let t;return t="object"==typeof e?e.value:e,ye(t)?null:t}(n.limit));let c=null;n.startAt&&(c=function(e){const t=!!e.before,n=e.values||[];return new Bt(n,t)}(n.startAt));let u=null;return n.endAt&&(u=function(e){const t=!e.before,n=e.values||[];return new Bt(n,t)}(n.endAt)),bn(t,s,o,i,a,"F",c,u)}function xs(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=As(e.unaryFilter.field);return Qt.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=As(e.unaryFilter.field);return Qt.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=As(e.unaryFilter.field);return Qt.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=As(e.unaryFilter.field);return Qt.create(s,"!=",{nullValue:"NULL_VALUE"});default:return v()}}(e):void 0!==e.fieldFilter?function(e){return Qt.create(As(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return v()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return Wt.create(e.compositeFilter.filters.map((e=>xs(e))),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return v()}}(e.compositeFilter.op))}(e):v()}function _s(e){return ts[e]}function Ds(e){return ns[e]}function Ns(e){return rs[e]}function Cs(e){return{fieldPath:e.canonicalString()}}function As(e){return K.fromServerFormat(e.fieldPath)}function ks(e){return e instanceof Qt?function(e){if("=="===e.op){if(At(e.value))return{unaryFilter:{field:Cs(e.field),op:"IS_NAN"}};if(Ct(e.value))return{unaryFilter:{field:Cs(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(At(e.value))return{unaryFilter:{field:Cs(e.field),op:"IS_NOT_NAN"}};if(Ct(e.value))return{unaryFilter:{field:Cs(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Cs(e.field),op:Ds(e.op),value:e.value}}}(e):e instanceof Wt?function(e){const t=e.getFilters().map((e=>ks(e)));return 1===t.length?t[0]:{compositeFilter:{op:Ns(e.op),filters:t}}}(e):v()}function Rs(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}function Fs(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class Vs{constructor(e,t,n,r,s=U.min(),i=U.min(),o=at.EMPTY_BYTE_STRING,a=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o,this.expectedCount=a}withSequenceNumber(e){return new Vs(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new Vs(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new Vs(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new Vs(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class Ms{constructor(e){this.fe=e}}function Ls(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Os(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document=function(e,t){return{name:ds(e,t.key),fields:t.data.value.mapValue.fields,updateTime:os(e,t.version.toTimestamp()),createTime:os(e,t.createTime.toTimestamp())}}(e.fe,t);else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:Ps(t.version)};else{if(!t.isUnknownDocument())return v();r.unknownDocument={path:n.path.toArray(),version:Ps(t.version)}}return r}function Os(e){const t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function Ps(e){const t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function qs(e){const t=new q(e.seconds,e.nanoseconds);return U.fromTimestamp(t)}function Us(e,t){const n=(t.baseMutations||[]).map((t=>bs(e.fe,t)));for(let i=0;i<t.mutations.length-1;++i){const e=t.mutations[i];if(i+1<t.mutations.length&&void 0!==t.mutations[i+1].transform){const n=t.mutations[i+1];e.updateTransforms=n.transform.fieldTransforms,t.mutations.splice(i+1,1),++i}}const r=t.mutations.map((t=>bs(e.fe,t))),s=q.fromMillis(t.localWriteTimeMs);return new Ar(t.batchId,s,n,r)}function Bs(e){const t=qs(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?qs(e.lastLimboFreeSnapshotVersion):U.min();let r;var s;return void 0!==e.query.documents?(I(1===(s=e.query).documents.length),r=Nn(En(gs(s.documents[0])))):r=function(e){return Nn(Ss(e))}(e.query),new Vs(r,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,t,n,at.fromBase64String(e.resumeToken))}function zs(e,t){const n=Ps(t.snapshotVersion),r=Ps(t.lastLimboFreeSnapshotVersion);let s;s=pn(t.target)?Es(e.fe,t.target):Ts(e.fe,t.target);const i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:mn(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function Gs(e){const t=Ss({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?An(t,t.limit,"L"):t}function Ks(e,t){return new Rr(t.largestBatchId,bs(e.fe,t.overlayMutation))}function $s(e,t){const n=t.path.lastSegment();return[e,Ie(t.path.popLast()),n]}function js(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:Ps(r.readTime),documentKey:Ie(r.documentKey.path),largestBatchId:r.largestBatchId}}class Qs{getBundleMetadata(e,t){return Ws(e).get(t).next((e=>{if(e)return{id:(t=e).bundleId,createTime:qs(t.createTime),version:t.version};var t}))}saveBundleMetadata(e,t){return Ws(e).put({bundleId:(n=t).id,createTime:Ps(us(n.createTime)),version:n.version});var n}getNamedQuery(e,t){return Hs(e).get(t).next((e=>{if(e)return{name:(t=e).name,query:Gs(t.bundledQuery),readTime:qs(t.readTime)};var t}))}saveNamedQuery(e,t){return Hs(e).put(function(e){return{name:e.name,readTime:Ps(us(e.readTime)),bundledQuery:e.bundledQuery}}(t))}}function Ws(e){return We(e,"bundles")}function Hs(e){return We(e,"namedQueries")}class Ys{constructor(e,t){this.serializer=e,this.userId=t}static de(e,t){const n=t.uid||"";return new Ys(e,n)}getOverlay(e,t){return Xs(e).get($s(this.userId,t)).next((e=>e?Ks(this.serializer,e):null))}getOverlays(e,t){const n=Kn();return se.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){const r=[];return n.forEach(((n,s)=>{const i=new Rr(t,s);r.push(this.we(e,i))})),se.waitFor(r)}removeOverlaysForBatchId(e,t,n){const r=new Set;t.forEach((e=>r.add(Ie(e.getCollectionPath()))));const s=[];return r.forEach((t=>{const r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);s.push(Xs(e).J("collectionPathOverlayIndex",r))})),se.waitFor(s)}getOverlaysForCollection(e,t,n){const r=Kn(),s=Ie(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Xs(e).j("collectionPathOverlayIndex",i).next((e=>{for(const t of e){const e=Ks(this.serializer,t);r.set(e.getKey(),e)}return r}))}getOverlaysForCollectionGroup(e,t,n,r){const s=Kn();let i;const o=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Xs(e).X({index:"collectionGroupOverlayIndex",range:o},((e,t,n)=>{const o=Ks(this.serializer,t);s.size()<r||o.largestBatchId===i?(s.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>s))}we(e,t){return Xs(e).put(function(e,t,n){const[r,s,i]=$s(t,n.mutation.key);return{userId:t,collectionPath:s,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Is(e.fe,n.mutation)}}(this.serializer,this.userId,t))}}function Xs(e){return We(e,"documentOverlays")}class Js{constructor(){}_e(e,t){this.me(e,t),t.ge()}me(e,t){if("nullValue"in e)this.ye(t,5);else if("booleanValue"in e)this.ye(t,10),t.pe(e.booleanValue?1:0);else if("integerValue"in e)this.ye(t,15),t.pe(lt(e.integerValue));else if("doubleValue"in e){const n=lt(e.doubleValue);isNaN(n)?this.ye(t,13):(this.ye(t,15),we(n)?t.pe(0):t.pe(n))}else if("timestampValue"in e){const n=e.timestampValue;this.ye(t,20),"string"==typeof n?t.Ie(n):(t.Ie(`${n.seconds||""}`),t.pe(n.nanos||0))}else if("stringValue"in e)this.Te(e.stringValue,t),this.Ee(t);else if("bytesValue"in e)this.ye(t,30),t.Ae(ht(e.bytesValue)),this.Ee(t);else if("referenceValue"in e)this.ve(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.ye(t,45),t.pe(n.latitude||0),t.pe(n.longitude||0)}else"mapValue"in e?Ft(e)?this.ye(t,Number.MAX_SAFE_INTEGER):(this.Re(e.mapValue,t),this.Ee(t)):"arrayValue"in e?(this.Pe(e.arrayValue,t),this.Ee(t)):v()}Te(e,t){this.ye(t,25),this.be(e,t)}be(e,t){t.Ie(e)}Re(e,t){const n=e.fields||{};this.ye(t,55);for(const r of Object.keys(n))this.Te(r,t),this.me(n[r],t)}Pe(e,t){const n=e.values||[];this.ye(t,50);for(const r of n)this.me(r,t)}ve(e,t){this.ye(t,37),$.fromName(e).path.forEach((e=>{this.ye(t,60),this.be(e,t)}))}ye(e,t){e.pe(t)}Ee(e){e.pe(2)}}function Zs(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}function ei(e){const t=64-function(e){let t=0;for(let n=0;n<8;++n){const r=Zs(255&e[n]);if(t+=r,8!==r)break}return t}(e);return Math.ceil(t/8)}Js.Ve=new Js;class ti{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Se(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.De(n.value),n=t.next();this.Ce()}xe(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ne(n.value),n=t.next();this.ke()}Me(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.De(e);else if(e<2048)this.De(960|e>>>6),this.De(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.De(480|e>>>12),this.De(128|63&e>>>6),this.De(128|63&e);else{const e=t.codePointAt(0);this.De(240|e>>>18),this.De(128|63&e>>>12),this.De(128|63&e>>>6),this.De(128|63&e)}}this.Ce()}$e(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ne(e);else if(e<2048)this.Ne(960|e>>>6),this.Ne(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ne(480|e>>>12),this.Ne(128|63&e>>>6),this.Ne(128|63&e);else{const e=t.codePointAt(0);this.Ne(240|e>>>18),this.Ne(128|63&e>>>12),this.Ne(128|63&e>>>6),this.Ne(128|63&e)}}this.ke()}Oe(e){const t=this.Fe(e),n=ei(t);this.Be(1+n),this.buffer[this.position++]=255&n;for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=255&t[r]}Le(e){const t=this.Fe(e),n=ei(t);this.Be(1+n),this.buffer[this.position++]=~(255&n);for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=~(255&t[r])}qe(){this.Ue(255),this.Ue(255)}Ke(){this.Ge(255),this.Ge(255)}reset(){this.position=0}seed(e){this.Be(e.length),this.buffer.set(e,this.position),this.position+=e.length}Qe(){return this.buffer.slice(0,this.position)}Fe(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let r=1;r<t.length;++r)t[r]^=n?255:0;return t}De(e){const t=255&e;0===t?(this.Ue(0),this.Ue(255)):255===t?(this.Ue(255),this.Ue(0)):this.Ue(t)}Ne(e){const t=255&e;0===t?(this.Ge(0),this.Ge(255)):255===t?(this.Ge(255),this.Ge(0)):this.Ge(e)}Ce(){this.Ue(0),this.Ue(1)}ke(){this.Ge(0),this.Ge(1)}Ue(e){this.Be(1),this.buffer[this.position++]=e}Ge(e){this.Be(1),this.buffer[this.position++]=~e}Be(e){const t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);const r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class ni{constructor(e){this.je=e}Ae(e){this.je.Se(e)}Ie(e){this.je.Me(e)}pe(e){this.je.Oe(e)}ge(){this.je.qe()}}class ri{constructor(e){this.je=e}Ae(e){this.je.xe(e)}Ie(e){this.je.$e(e)}pe(e){this.je.Le(e)}ge(){this.je.Ke()}}class si{constructor(){this.je=new ti,this.ze=new ni(this.je),this.We=new ri(this.je)}seed(e){this.je.seed(e)}He(e){return 0===e?this.ze:this.We}Qe(){return this.je.Qe()}reset(){this.je.reset()}}class ii{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Je(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new ii(this.indexId,this.documentKey,this.arrayValue,n)}}function oi(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=ai(e.arrayValue,t.arrayValue),0!==n?n:(n=ai(e.directionalValue,t.directionalValue),0!==n?n:$.comparator(e.documentKey,t.documentKey)))}function ai(e,t){for(let n=0;n<e.length&&n<t.length;++n){const r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}class ci{constructor(e){this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Ye=e.orderBy,this.Xe=[];for(const t of e.filters){const e=t;e.isInequality()?this.Ze=e:this.Xe.push(e)}}tn(e){I(e.collectionGroup===this.collectionId);const t=Q(e);if(void 0!==t&&!this.en(t))return!1;const n=W(e);let r=new Set,s=0,i=0;for(;s<n.length&&this.en(n[s]);++s)r=r.add(n[s].fieldPath.canonicalString());if(s===n.length)return!0;if(void 0!==this.Ze){if(!r.has(this.Ze.field.canonicalString())){const e=n[s];if(!this.nn(this.Ze,e)||!this.sn(this.Ye[i++],e))return!1}++s}for(;s<n.length;++s){const e=n[s];if(i>=this.Ye.length||!this.sn(this.Ye[i++],e))return!1}return!0}en(e){for(const t of this.Xe)if(this.nn(t,e))return!0;return!1}nn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;const n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}sn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function ui(e){var t,n;if(I(e instanceof Qt||e instanceof Wt),e instanceof Qt){if(e instanceof un){const r=(null===(n=null===(t=e.value.arrayValue)||void 0===t?void 0:t.values)||void 0===n?void 0:n.map((t=>Qt.create(e.field,"==",t))))||[];return Wt.create(r,"or")}return e}const r=e.filters.map((e=>ui(e)));return Wt.create(r,e.op)}function li(e){if(0===e.getFilters().length)return[];const t=mi(ui(e));return I(fi(t)),hi(t)||di(t)?[t]:t.getFilters()}function hi(e){return e instanceof Qt}function di(e){return e instanceof Wt&&Xt(e)}function fi(e){return hi(e)||di(e)||function(e){if(e instanceof Wt&&Yt(e)){for(const t of e.getFilters())if(!hi(t)&&!di(t))return!1;return!0}return!1}(e)}function mi(e){if(I(e instanceof Qt||e instanceof Wt),e instanceof Qt)return e;if(1===e.filters.length)return mi(e.filters[0]);const t=e.filters.map((e=>mi(e)));let n=Wt.create(t,e.op);return n=yi(n),fi(n)?n:(I(n instanceof Wt),I(Ht(n)),I(n.filters.length>1),n.filters.reduce(((e,t)=>gi(e,t))))}function gi(e,t){let n;return I(e instanceof Qt||e instanceof Wt),I(t instanceof Qt||t instanceof Wt),n=e instanceof Qt?t instanceof Qt?function(e,t){return Wt.create([e,t],"and")}(e,t):pi(e,t):t instanceof Qt?pi(t,e):function(e,t){if(I(e.filters.length>0&&t.filters.length>0),Ht(e)&&Ht(t))return tn(e,t.getFilters());const n=Yt(e)?e:t,r=Yt(e)?t:e,s=n.filters.map((e=>gi(e,r)));return Wt.create(s,"or")}(e,t),yi(n)}function pi(e,t){if(Ht(t))return tn(t,e.getFilters());{const n=t.filters.map((t=>gi(e,t)));return Wt.create(n,"or")}}function yi(e){if(I(e instanceof Qt||e instanceof Wt),e instanceof Qt)return e;const t=e.getFilters();if(1===t.length)return yi(t[0]);if(Jt(e))return e;const n=t.map((e=>yi(e))),r=[];return n.forEach((t=>{t instanceof Qt?r.push(t):t instanceof Wt&&(t.op===e.op?r.push(...t.filters):r.push(t))})),1===r.length?r[0]:Wt.create(r,e.op)}class wi{constructor(){this.rn=new vi}addToCollectionParentIndex(e,t){return this.rn.add(t),se.resolve()}getCollectionParents(e,t){return se.resolve(this.rn.getEntries(t))}addFieldIndex(e,t){return se.resolve()}deleteFieldIndex(e,t){return se.resolve()}getDocumentsMatchingTarget(e,t){return se.resolve(null)}getIndexType(e,t){return se.resolve(0)}getFieldIndexes(e,t){return se.resolve([])}getNextCollectionGroupToUpdate(e){return se.resolve(null)}getMinOffset(e,t){return se.resolve(Z.min())}getMinOffsetFromCollectionGroup(e,t){return se.resolve(Z.min())}updateCollectionGroup(e,t,n){return se.resolve()}updateIndexEntries(e,t){return se.resolve()}}class vi{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new tt(z.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new tt(z.comparator)).toArray()}}const Ii=new Uint8Array(0);class bi{constructor(e,t){this.user=e,this.databaseId=t,this.on=new vi,this.un=new Pn((e=>mn(e)),((e,t)=>gn(e,t))),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.on.has(t)){const n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener((()=>{this.on.add(t)}));const s={collectionId:n,parent:Ie(r)};return Ei(e).put(s)}return se.resolve()}getCollectionParents(e,t){const n=[],r=IDBKeyRange.bound([t,""],[P(t),""],!1,!0);return Ei(e).j(r).next((e=>{for(const r of e){if(r.collectionId!==t)break;n.push(Te(r.parent))}return n}))}addFieldIndex(e,t){const n=Si(e),r=function(e){return{indexId:e.indexId,collectionGroup:e.collectionGroup,fields:e.fields.map((e=>[e.fieldPath.canonicalString(),e.kind]))}}(t);delete r.indexId;const s=n.add(r);if(t.indexState){const n=xi(e);return s.next((e=>{n.put(js(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))}))}return s.next()}deleteFieldIndex(e,t){const n=Si(e),r=xi(e),s=Ti(e);return n.delete(t.indexId).next((()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))).next((()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))))}getDocumentsMatchingTarget(e,t){const n=Ti(e);let r=!0;const s=new Map;return se.forEach(this.cn(t),(t=>this.an(e,t).next((e=>{r&&(r=!!e),s.set(t,e)})))).next((()=>{if(r){let e=Hn();const r=[];return se.forEach(s,((s,i)=>{var o;g("IndexedDbIndexManager",`Using index ${o=s,`id=${o.indexId}|cg=${o.collectionGroup}|f=${o.fields.map((e=>`${e.fieldPath}:${e.kind}`)).join(",")}`} to execute ${mn(t)}`);const a=function(e,t){const n=Q(t);if(void 0===n)return null;for(const r of yn(e,n.fieldPath))switch(r.op){case"array-contains-any":return r.value.arrayValue.values||[];case"array-contains":return[r.value]}return null}(i,s),c=function(e,t){const n=new Map;for(const r of W(t))for(const t of yn(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(i,s),u=function(e,t){const n=[];let r=!0;for(const s of W(t)){const t=0===s.kind?wn(e,s.fieldPath,e.startAt):vn(e,s.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new Bt(n,r)}(i,s),l=function(e,t){const n=[];let r=!0;for(const s of W(t)){const t=0===s.kind?vn(e,s.fieldPath,e.endAt):wn(e,s.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new Bt(n,r)}(i,s),h=this.hn(s,i,u),d=this.hn(s,i,l),f=this.ln(s,i,c),m=this.fn(s.indexId,a,h,u.inclusive,d,l.inclusive,f);return se.forEach(m,(s=>n.H(s,t.limit).next((t=>{t.forEach((t=>{const n=$.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))}))}))))})).next((()=>r))}return se.resolve(null)}))}cn(e){let t=this.un.get(e);return t||(t=0===e.filters.length?[e]:li(Wt.create(e.filters,"and")).map((t=>fn(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt))),this.un.set(e,t),t)}fn(e,t,n,r,s,i,o){const a=(null!=t?t.length:1)*Math.max(n.length,s.length),c=a/(null!=t?t.length:1),u=[];for(let l=0;l<a;++l){const a=t?this.dn(t[l/c]):Ii,h=this.wn(e,a,n[l%c],r),d=this._n(e,a,s[l%c],i),f=o.map((t=>this.wn(e,a,t,!0)));u.push(...this.createRange(h,d,f))}return u}wn(e,t,n,r){const s=new ii(e,$.empty(),t,n);return r?s:s.Je()}_n(e,t,n,r){const s=new ii(e,$.empty(),t,n);return r?s.Je():s}an(e,t){const n=new ci(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next((e=>{let t=null;for(const r of e)n.tn(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t}))}getIndexType(e,t){let n=2;const r=this.cn(t);return se.forEach(r,(t=>this.an(e,t).next((e=>{e?0!==n&&e.fields.length<function(e){let t=new tt(K.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const r of e.orderBy)r.field.isKeyField()||(t=t.add(r.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})))).next((()=>function(e){return null!==e.limit}(t)&&r.length>1&&2===n?1:n))}mn(e,t){const n=new si;for(const r of W(e)){const e=t.data.field(r.fieldPath);if(null==e)return null;const s=n.He(r.kind);Js.Ve._e(e,s)}return n.Qe()}dn(e){const t=new si;return Js.Ve._e(e,t.He(0)),t.Qe()}gn(e,t){const n=new si;return Js.Ve._e(_t(this.databaseId,t),n.He(function(e){const t=W(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.Qe()}ln(e,t,n){if(null===n)return[];let r=[];r.push(new si);let s=0;for(const i of W(e)){const e=n[s++];for(const n of r)if(this.yn(t,i.fieldPath)&&Nt(e))r=this.pn(r,i,e);else{const t=n.He(i.kind);Js.Ve._e(e,t)}}return this.In(r)}hn(e,t,n){return this.ln(e,t,n.position)}In(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Qe();return t}pn(e,t,n){const r=[...e],s=[];for(const i of n.arrayValue.values||[])for(const e of r){const n=new si;n.seed(e.Qe()),Js.Ve._e(i,n.He(t.kind)),s.push(n)}return s}yn(e,t){return!!e.filters.find((e=>e instanceof Qt&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op)))}getFieldIndexes(e,t){const n=Si(e),r=xi(e);return(t?n.j("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.j()).next((e=>{const t=[];return se.forEach(e,(e=>r.get([e.indexId,this.uid]).next((n=>{t.push(function(e,t){const n=t?new Y(t.sequenceNumber,new Z(qs(t.readTime),new $(Te(t.documentKey)),t.largestBatchId)):Y.empty(),r=e.fields.map((([e,t])=>new H(K.fromServerFormat(e),t)));return new j(e.indexId,e.collectionGroup,r,n)}(e,n))})))).next((()=>t))}))}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next((e=>0===e.length?null:(e.sort(((e,t)=>{const n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:L(e.collectionGroup,t.collectionGroup)})),e[0].collectionGroup)))}updateCollectionGroup(e,t,n){const r=Si(e),s=xi(e);return this.Tn(e).next((e=>r.j("collectionGroupIndex",IDBKeyRange.bound(t,t)).next((t=>se.forEach(t,(t=>s.put(js(t.indexId,this.user,e,n))))))))}updateIndexEntries(e,t){const n=new Map;return se.forEach(t,((t,r)=>{const s=n.get(t.collectionGroup);return(s?se.resolve(s):this.getFieldIndexes(e,t.collectionGroup)).next((s=>(n.set(t.collectionGroup,s),se.forEach(s,(n=>this.En(e,t,n).next((t=>{const s=this.An(r,n);return t.isEqual(s)?se.resolve():this.vn(e,r,n,t,s)})))))))}))}Rn(e,t,n,r){return Ti(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.gn(n,t.key),documentKey:t.key.path.toArray()})}Pn(e,t,n,r){return Ti(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.gn(n,t.key),t.key.path.toArray()])}En(e,t,n){const r=Ti(e);let s=new tt(oi);return r.X({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.gn(n,t)])},((e,r)=>{s=s.add(new ii(n.indexId,t,r.arrayValue,r.directionalValue))})).next((()=>s))}An(e,t){let n=new tt(oi);const r=this.mn(t,e);if(null==r)return n;const s=Q(t);if(null!=s){const i=e.data.field(s.fieldPath);if(Nt(i))for(const s of i.arrayValue.values||[])n=n.add(new ii(t.indexId,e.key,this.dn(s),r))}else n=n.add(new ii(t.indexId,e.key,Ii,r));return n}vn(e,t,n,r,s){g("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);const i=[];return function(e,t,n,r,s){const i=e.getIterator(),o=t.getIterator();let a=rt(i),c=rt(o);for(;a||c;){let e=!1,t=!1;if(a&&c){const r=n(a,c);r<0?t=!0:r>0&&(e=!0)}else null!=a?t=!0:e=!0;e?(r(c),c=rt(o)):t?(s(a),a=rt(i)):(a=rt(i),c=rt(o))}}(r,s,oi,(r=>{i.push(this.Rn(e,t,n,r))}),(r=>{i.push(this.Pn(e,t,n,r))})),se.waitFor(i)}Tn(e){let t=1;return xi(e).X({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((e,n,r)=>{r.done(),t=n.sequenceNumber+1})).next((()=>t))}createRange(e,t,n){n=n.sort(((e,t)=>oi(e,t))).filter(((e,t,n)=>!t||0!==oi(e,n[t-1])));const r=[];r.push(e);for(const i of n){const n=oi(i,e),s=oi(i,t);if(0===n)r[0]=e.Je();else if(n>0&&s<0)r.push(i),r.push(i.Je());else if(s>0)break}r.push(t);const s=[];for(let i=0;i<r.length;i+=2){if(this.bn(r[i],r[i+1]))return[];const e=[r[i].indexId,this.uid,r[i].arrayValue,r[i].directionalValue,Ii,[]],t=[r[i+1].indexId,this.uid,r[i+1].arrayValue,r[i+1].directionalValue,Ii,[]];s.push(IDBKeyRange.bound(e,t))}return s}bn(e,t){return oi(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(_i)}getMinOffset(e,t){return se.mapArray(this.cn(t),(t=>this.an(e,t).next((e=>e||v())))).next(_i)}}function Ei(e){return We(e,"collectionParents")}function Ti(e){return We(e,"indexEntries")}function Si(e){return We(e,"indexConfiguration")}function xi(e){return We(e,"indexState")}function _i(e){I(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){const s=e[r].indexState.offset;ee(s,t)<0&&(t=s),n<s.largestBatchId&&(n=s.largestBatchId)}return new Z(t.readTime,t.documentKey,n)}const Di={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Ni{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new Ni(e,Ni.DEFAULT_COLLECTION_PERCENTILE,Ni.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Ci(e,t,n){const r=e.store("mutations"),s=e.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const c=r.X({range:o},((e,t,n)=>(a++,n.delete())));i.push(c.next((()=>{I(1===a)})));const u=[];for(const l of n.mutations){const e=_e(t,l.key.path,n.batchId);i.push(s.delete(e)),u.push(l.key)}return se.waitFor(i).next((()=>u))}function Ai(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw v();t=e.noDocument}return JSON.stringify(t).length}Ni.DEFAULT_COLLECTION_PERCENTILE=10,Ni.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Ni.DEFAULT=new Ni(41943040,Ni.DEFAULT_COLLECTION_PERCENTILE,Ni.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Ni.DISABLED=new Ni(-1,0,0);class ki{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Vn={}}static de(e,t,n,r){I(""!==e.uid);const s=e.isAuthenticated()?e.uid:"";return new ki(s,t,n,r)}checkEmpty(e){let t=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Fi(e).X({index:"userMutationsIndex",range:n},((e,n,r)=>{t=!1,r.done()})).next((()=>t))}addMutationBatch(e,t,n,r){const s=Vi(e),i=Fi(e);return i.add({}).next((o=>{I("number"==typeof o);const a=new Ar(o,t,n,r),c=function(e,t,n){const r=n.baseMutations.map((t=>Is(e.fe,t))),s=n.mutations.map((t=>Is(e.fe,t)));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:s}}(this.serializer,this.userId,a),u=[];let l=new tt(((e,t)=>L(e.canonicalString(),t.canonicalString())));for(const e of r){const t=_e(this.userId,e.key.path,o);l=l.add(e.key.path.popLast()),u.push(i.put(c)),u.push(s.put(t,De))}return l.forEach((t=>{u.push(this.indexManager.addToCollectionParentIndex(e,t))})),e.addOnCommittedListener((()=>{this.Vn[o]=a.keys()})),se.waitFor(u).next((()=>a))}))}lookupMutationBatch(e,t){return Fi(e).get(t).next((e=>e?(I(e.userId===this.userId),Us(this.serializer,e)):null))}Sn(e,t){return this.Vn[t]?se.resolve(this.Vn[t]):this.lookupMutationBatch(e,t).next((e=>{if(e){const n=e.keys();return this.Vn[t]=n,n}return null}))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return Fi(e).X({index:"userMutationsIndex",range:r},((e,t,r)=>{t.userId===this.userId&&(I(t.batchId>=n),s=Us(this.serializer,t)),r.done()})).next((()=>s))}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return Fi(e).X({index:"userMutationsIndex",range:t,reverse:!0},((e,t,r)=>{n=t.batchId,r.done()})).next((()=>n))}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Fi(e).j("userMutationsIndex",t).next((e=>e.map((e=>Us(this.serializer,e)))))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=xe(this.userId,t.path),r=IDBKeyRange.lowerBound(n),s=[];return Vi(e).X({range:r},((n,r,i)=>{const[o,a,c]=n,u=Te(a);if(o===this.userId&&t.path.isEqual(u))return Fi(e).get(c).next((e=>{if(!e)throw v();I(e.userId===this.userId),s.push(Us(this.serializer,e))}));i.done()})).next((()=>s))}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new tt(L);const r=[];return t.forEach((t=>{const s=xe(this.userId,t.path),i=IDBKeyRange.lowerBound(s),o=Vi(e).X({range:i},((e,r,s)=>{const[i,o,a]=e,c=Te(o);i===this.userId&&t.path.isEqual(c)?n=n.add(a):s.done()}));r.push(o)})),se.waitFor(r).next((()=>this.Dn(e,n)))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1,s=xe(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new tt(L);return Vi(e).X({range:i},((e,t,s)=>{const[i,a,c]=e,u=Te(a);i===this.userId&&n.isPrefixOf(u)?u.length===r&&(o=o.add(c)):s.done()})).next((()=>this.Dn(e,o)))}Dn(e,t){const n=[],r=[];return t.forEach((t=>{r.push(Fi(e).get(t).next((e=>{if(null===e)throw v();I(e.userId===this.userId),n.push(Us(this.serializer,e))})))})),se.waitFor(r).next((()=>n))}removeMutationBatch(e,t){return Ci(e.ht,this.userId,t).next((n=>(e.addOnCommittedListener((()=>{this.Cn(t.batchId)})),se.forEach(n,(t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))))}Cn(e){delete this.Vn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next((t=>{if(!t)return se.resolve();const n=IDBKeyRange.lowerBound([this.userId]),r=[];return Vi(e).X({range:n},((e,t,n)=>{if(e[0]===this.userId){const t=Te(e[1]);r.push(t)}else n.done()})).next((()=>{I(0===r.length)}))}))}containsKey(e,t){return Ri(e,this.userId,t)}xn(e){return Mi(e).get(this.userId).next((e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function Ri(e,t,n){const r=xe(t,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return Vi(e).X({range:i,Y:!0},((e,n,r)=>{const[i,a,c]=e;i===t&&a===s&&(o=!0),r.done()})).next((()=>o))}function Fi(e){return We(e,"mutations")}function Vi(e){return We(e,"documentMutations")}function Mi(e){return We(e,"mutationQueues")}class Li{constructor(e){this.Nn=e}next(){return this.Nn+=2,this.Nn}static kn(){return new Li(0)}static Mn(){return new Li(-1)}}class Oi{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.$n(e).next((t=>{const n=new Li(t.highestTargetId);return t.highestTargetId=n.next(),this.On(e,t).next((()=>t.highestTargetId))}))}getLastRemoteSnapshotVersion(e){return this.$n(e).next((e=>U.fromTimestamp(new q(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(e){return this.$n(e).next((e=>e.highestListenSequenceNumber))}setTargetsMetadata(e,t,n){return this.$n(e).next((r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.On(e,r))))}addTargetData(e,t){return this.Fn(e,t).next((()=>this.$n(e).next((n=>(n.targetCount+=1,this.Bn(t,n),this.On(e,n))))))}updateTargetData(e,t){return this.Fn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next((()=>Pi(e).delete(t.targetId))).next((()=>this.$n(e))).next((t=>(I(t.targetCount>0),t.targetCount-=1,this.On(e,t))))}removeTargets(e,t,n){let r=0;const s=[];return Pi(e).X(((i,o)=>{const a=Bs(o);a.sequenceNumber<=t&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(e,a)))})).next((()=>se.waitFor(s))).next((()=>r))}forEachTarget(e,t){return Pi(e).X(((e,n)=>{const r=Bs(n);t(r)}))}$n(e){return qi(e).get("targetGlobalKey").next((e=>(I(null!==e),e)))}On(e,t){return qi(e).put("targetGlobalKey",t)}Fn(e,t){return Pi(e).put(zs(this.serializer,t))}Bn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.$n(e).next((e=>e.targetCount))}getTargetData(e,t){const n=mn(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return Pi(e).X({range:r,index:"queryTargetsIndex"},((e,n,r)=>{const i=Bs(n);gn(t,i.target)&&(s=i,r.done())})).next((()=>s))}addMatchingKeys(e,t,n){const r=[],s=Ui(e);return t.forEach((t=>{const i=Ie(t.path);r.push(s.put({targetId:n,path:i})),r.push(this.referenceDelegate.addReference(e,n,t))})),se.waitFor(r)}removeMatchingKeys(e,t,n){const r=Ui(e);return se.forEach(t,(t=>{const s=Ie(t.path);return se.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(e,n,t)])}))}removeMatchingKeysForTargetId(e,t){const n=Ui(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=Ui(e);let s=Hn();return r.X({range:n,Y:!0},((e,t,n)=>{const r=Te(e[1]),i=new $(r);s=s.add(i)})).next((()=>s))}containsKey(e,t){const n=Ie(t.path),r=IDBKeyRange.bound([n],[P(n)],!1,!0);let s=0;return Ui(e).X({index:"documentTargetsIndex",Y:!0,range:r},(([e,t],n,r)=>{0!==e&&(s++,r.done())})).next((()=>s>0))}le(e,t){return Pi(e).get(t).next((e=>e?Bs(e):null))}}function Pi(e){return We(e,"targets")}function qi(e){return We(e,"targetGlobal")}function Ui(e){return We(e,"targetDocuments")}function Bi([e,t],[n,r]){const s=L(e,n);return 0===s?L(t,r):s}class zi{constructor(e){this.Ln=e,this.buffer=new tt(Bi),this.qn=0}Un(){return++this.qn}Kn(e){const t=[e,this.Un()];if(this.buffer.size<this.Ln)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Bi(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Gi{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Gn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Qn(6e4)}stop(){this.Gn&&(this.Gn.cancel(),this.Gn=null)}get started(){return null!==this.Gn}Qn(e){g("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Gn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(async()=>{this.Gn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){ue(e)?g("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await re(e)}await this.Qn(3e5)}))}}class Ki{constructor(e,t){this.jn=e,this.params=t}calculateTargetCount(e,t){return this.jn.zn(e).next((e=>Math.floor(t/100*e)))}nthSequenceNumber(e,t){if(0===t)return se.resolve(pe.ct);const n=new zi(t);return this.jn.forEachTarget(e,(e=>n.Kn(e.sequenceNumber))).next((()=>this.jn.Wn(e,(e=>n.Kn(e))))).next((()=>n.maxValue))}removeTargets(e,t,n){return this.jn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.jn.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(g("LruGarbageCollector","Garbage collection skipped; disabled"),se.resolve(Di)):this.getCacheSize(e).next((n=>n<this.params.cacheSizeCollectionThreshold?(g("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Di):this.Hn(e,t)))}getCacheSize(e){return this.jn.getCacheSize(e)}Hn(e,t){let n,r,s,o,a,c,u;const l=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next((t=>(t>this.params.maximumSequenceNumbersToCollect?(g("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,o=Date.now(),this.nthSequenceNumber(e,r)))).next((r=>(n=r,a=Date.now(),this.removeTargets(e,n,t)))).next((t=>(s=t,c=Date.now(),this.removeOrphanedDocuments(e,n)))).next((e=>(u=Date.now(),f()<=i.in.DEBUG&&g("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-l}ms\n\tDetermined least recently used ${r} in `+(a-o)+"ms\n"+`\tRemoved ${s} targets in `+(c-a)+"ms\n"+`\tRemoved ${e} documents in `+(u-c)+"ms\n"+`Total Duration: ${u-l}ms`),se.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:e}))))}}function $i(e,t){return new Ki(e,t)}class ji{constructor(e,t){this.db=e,this.garbageCollector=$i(this,t)}zn(e){const t=this.Jn(e);return this.db.getTargetCache().getTargetCount(e).next((e=>t.next((t=>e+t))))}Jn(e){let t=0;return this.Wn(e,(e=>{t++})).next((()=>t))}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Wn(e,t){return this.Yn(e,((e,n)=>t(n)))}addReference(e,t,n){return Qi(e,n)}removeReference(e,t,n){return Qi(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Qi(e,t)}Xn(e,t){return function(e,t){let n=!1;return Mi(e).Z((r=>Ri(e,r,t).next((e=>(e&&(n=!0),se.resolve(!e)))))).next((()=>n))}(e,t)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.Yn(e,((i,o)=>{if(o<=t){const t=this.Xn(e,i).next((t=>{if(!t)return s++,n.getEntry(e,i).next((()=>(n.removeEntry(i,U.min()),Ui(e).delete([0,Ie(i.path)]))))}));r.push(t)}})).next((()=>se.waitFor(r))).next((()=>n.apply(e))).next((()=>s))}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return Qi(e,t)}Yn(e,t){const n=Ui(e);let r,s=pe.ct;return n.X({index:"documentTargetsIndex"},(([e,n],{path:i,sequenceNumber:o})=>{0===e?(s!==pe.ct&&t(new $(Te(r)),s),s=o,r=i):s=pe.ct})).next((()=>{s!==pe.ct&&t(new $(Te(r)),s)}))}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Qi(e,t){return Ui(e).put(function(e,t){return{targetId:0,path:Ie(e.path),sequenceNumber:t}}(t,e.currentSequenceNumber))}class Wi{constructor(){this.changes=new Pn((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Ut.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?se.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Hi{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return Zi(e).put(n)}removeEntry(e,t,n){return Zi(e).delete(function(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],Os(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next((n=>(n.byteSize+=t,this.Zn(e,n))))}getEntry(e,t){let n=Ut.newInvalidDocument(t);return Zi(e).X({index:"documentKeyIndex",range:IDBKeyRange.only(eo(t))},((e,r)=>{n=this.ts(t,r)})).next((()=>n))}es(e,t){let n={size:0,document:Ut.newInvalidDocument(t)};return Zi(e).X({index:"documentKeyIndex",range:IDBKeyRange.only(eo(t))},((e,r)=>{n={document:this.ts(t,r),size:Ai(r)}})).next((()=>n))}getEntries(e,t){let n=Un();return this.ns(e,t,((e,t)=>{const r=this.ts(e,t);n=n.insert(e,r)})).next((()=>n))}ss(e,t){let n=Un(),r=new Je($.comparator);return this.ns(e,t,((e,t)=>{const s=this.ts(e,t);n=n.insert(e,s),r=r.insert(e,Ai(t))})).next((()=>({documents:n,rs:r})))}ns(e,t,n){if(t.isEmpty())return se.resolve();let r=new tt(no);t.forEach((e=>r=r.add(e)));const s=IDBKeyRange.bound(eo(r.first()),eo(r.last())),i=r.getIterator();let o=i.getNext();return Zi(e).X({index:"documentKeyIndex",range:s},((e,t,r)=>{const s=$.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;o&&no(o,s)<0;)n(o,null),o=i.getNext();o&&o.isEqual(s)&&(n(o,t),o=i.hasNext()?i.getNext():null),o?r.G(eo(o)):r.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getDocumentsMatchingQuery(e,t,n,r){const s=t.path,i=[s.popLast().toArray(),s.lastSegment(),Os(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Zi(e).j(IDBKeyRange.bound(i,o,!0)).next((e=>{let n=Un();for(const s of e){const e=this.ts($.fromSegments(s.prefixPath.concat(s.collectionGroup,s.documentId)),s);e.isFoundDocument()&&(Vn(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n}))}getAllFromCollectionGroup(e,t,n,r){let s=Un();const i=to(t,n),o=to(t,Z.max());return Zi(e).X({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},((e,t,n)=>{const i=this.ts($.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);s=s.insert(i.key,i),s.size===r&&n.done()})).next((()=>s))}newChangeBuffer(e){return new Xi(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next((e=>e.byteSize))}getMetadata(e){return Ji(e).get("remoteDocumentGlobalKey").next((e=>(I(!!e),e)))}Zn(e,t){return Ji(e).put("remoteDocumentGlobalKey",t)}ts(e,t){if(t){const e=function(e,t){let n;if(t.document)n=vs(e.fe,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=$.fromSegments(t.noDocument.path),r=qs(t.noDocument.readTime);n=Ut.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return v();{const e=$.fromSegments(t.unknownDocument.path),r=qs(t.unknownDocument.version);n=Ut.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function(e){const t=new q(e[0],e[1]);return U.fromTimestamp(t)}(t.readTime)),n}(this.serializer,t);if(!e.isNoDocument()||!e.version.isEqual(U.min()))return e}return Ut.newInvalidDocument(e)}}function Yi(e){return new Hi(e)}class Xi extends Wi{constructor(e,t){super(),this.os=e,this.trackRemovals=t,this.us=new Pn((e=>e.toString()),((e,t)=>e.isEqual(t)))}applyChanges(e){const t=[];let n=0,r=new tt(((e,t)=>L(e.canonicalString(),t.canonicalString())));return this.changes.forEach(((s,i)=>{const o=this.us.get(s);if(t.push(this.os.removeEntry(e,s,o.readTime)),i.isValidDocument()){const a=Ls(this.os.serializer,i);r=r.add(s.path.popLast());const c=Ai(a);n+=c-o.size,t.push(this.os.addEntry(e,s,a))}else if(n-=o.size,this.trackRemovals){const n=Ls(this.os.serializer,i.convertToNoDocument(U.min()));t.push(this.os.addEntry(e,s,n))}})),r.forEach((n=>{t.push(this.os.indexManager.addToCollectionParentIndex(e,n))})),t.push(this.os.updateMetadata(e,n)),se.waitFor(t)}getFromCache(e,t){return this.os.es(e,t).next((e=>(this.us.set(t,{size:e.size,readTime:e.document.readTime}),e.document)))}getAllFromCache(e,t){return this.os.ss(e,t).next((({documents:e,rs:t})=>(t.forEach(((t,n)=>{this.us.set(t,{size:n,readTime:e.get(t).readTime})})),e)))}}function Ji(e){return We(e,"remoteDocumentGlobal")}function Zi(e){return We(e,"remoteDocumentsV14")}function eo(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function to(e,t){const n=t.documentKey.path.toArray();return[e,Os(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function no(e,t){const n=e.path.toArray(),r=t.path.toArray();let s=0;for(let i=0;i<n.length-2&&i<r.length-2;++i)if(s=L(n[i],r[i]),s)return s;return s=L(n.length,r.length),s||(s=L(n[n.length-2],r[r.length-2]),s||L(n[n.length-1],r[r.length-1]))}class ro{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class so{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next((r=>(n=r,this.remoteDocumentCache.getEntry(e,t)))).next((e=>(null!==n&&Ir(n.mutation,e,st.empty(),q.now()),e)))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.getLocalViewOfDocuments(e,t,Hn()).next((()=>t))))}getLocalViewOfDocuments(e,t,n=Hn()){const r=Kn();return this.populateOverlays(e,r,t).next((()=>this.computeViews(e,t,r,n).next((e=>{let t=zn();return e.forEach(((e,n)=>{t=t.insert(e,n.overlayedDocument)})),t}))))}getOverlayedDocuments(e,t){const n=Kn();return this.populateOverlays(e,n,t).next((()=>this.computeViews(e,t,n,Hn())))}populateOverlays(e,t,n){const r=[];return n.forEach((e=>{t.has(e)||r.push(e)})),this.documentOverlayCache.getOverlays(e,r).next((e=>{e.forEach(((e,n)=>{t.set(e,n)}))}))}computeViews(e,t,n,r){let s=Un();const i=jn(),o=jn();return t.forEach(((e,t)=>{const o=n.get(t.key);r.has(t.key)&&(void 0===o||o.mutation instanceof Sr)?s=s.insert(t.key,t):void 0!==o?(i.set(t.key,o.mutation.getFieldMask()),Ir(o.mutation,t,o.mutation.getFieldMask(),q.now())):i.set(t.key,st.empty())})),this.recalculateAndSaveOverlays(e,s).next((e=>(e.forEach(((e,t)=>i.set(e,t))),t.forEach(((e,t)=>{var n;return o.set(e,new ro(t,null!==(n=i.get(e))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(e,t){const n=jn();let r=new Je(((e,t)=>e-t)),s=Hn();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>{for(const s of e)s.keys().forEach((e=>{const i=t.get(e);if(null===i)return;let o=n.get(e)||st.empty();o=s.applyToLocalView(i,o),n.set(e,o);const a=(r.get(s.batchId)||Hn()).add(e);r=r.insert(s.batchId,a)}))})).next((()=>{const i=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),a=r.key,c=r.value,u=$n();c.forEach((e=>{if(!s.has(e)){const r=wr(t.get(e),n.get(e));null!==r&&u.set(e,r),s=s.add(e)}})),i.push(this.documentOverlayCache.saveOverlays(e,a,u))}return se.waitFor(i)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.recalculateAndSaveOverlays(e,t)))}getDocumentsMatchingQuery(e,t,n){return function(e){return $.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):_n(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next((s=>{const i=r-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-s.size):se.resolve(Kn());let o=-1,a=s;return i.next((t=>se.forEach(t,((t,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),s.get(t)?se.resolve():this.remoteDocumentCache.getEntry(e,t).next((e=>{a=a.insert(t,e)}))))).next((()=>this.populateOverlays(e,t,s))).next((()=>this.computeViews(e,a,t,Hn()))).next((e=>({batchId:o,changes:Gn(e)})))))}))}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new $(t)).next((e=>{let t=zn();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}getDocumentsMatchingCollectionGroupQuery(e,t,n){const r=t.collectionGroup;let s=zn();return this.indexManager.getCollectionParents(e,r).next((i=>se.forEach(i,(i=>{const o=function(e,t){return new In(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,i.child(r));return this.getDocumentsMatchingCollectionQuery(e,o,n).next((e=>{e.forEach(((e,t)=>{s=s.insert(e,t)}))}))})).next((()=>s))))}getDocumentsMatchingCollectionQuery(e,t,n){let r;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next((s=>(r=s,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,r)))).next((e=>{r.forEach(((t,n)=>{const r=n.getKey();null===e.get(r)&&(e=e.insert(r,Ut.newInvalidDocument(r)))}));let n=zn();return e.forEach(((e,s)=>{const i=r.get(e);void 0!==i&&Ir(i.mutation,s,st.empty(),q.now()),Vn(t,s)&&(n=n.insert(e,s))})),n}))}}class io{constructor(e){this.serializer=e,this.cs=new Map,this.hs=new Map}getBundleMetadata(e,t){return se.resolve(this.cs.get(t))}saveBundleMetadata(e,t){var n;return this.cs.set(t.id,{id:(n=t).id,version:n.version,createTime:us(n.createTime)}),se.resolve()}getNamedQuery(e,t){return se.resolve(this.hs.get(t))}saveNamedQuery(e,t){return this.hs.set(t.name,function(e){return{name:e.name,query:Gs(e.bundledQuery),readTime:us(e.readTime)}}(t)),se.resolve()}}class oo{constructor(){this.overlays=new Je($.comparator),this.ls=new Map}getOverlay(e,t){return se.resolve(this.overlays.get(t))}getOverlays(e,t){const n=Kn();return se.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){return n.forEach(((n,r)=>{this.we(e,t,r)})),se.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.ls.get(n);return void 0!==r&&(r.forEach((e=>this.overlays=this.overlays.remove(e))),this.ls.delete(n)),se.resolve()}getOverlaysForCollection(e,t,n){const r=Kn(),s=t.length+1,i=new $(t.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const e=o.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return se.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let s=new Je(((e,t)=>e-t));const i=this.overlays.getIterator();for(;i.hasNext();){const e=i.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=s.get(e.largestBatchId);null===t&&(t=Kn(),s=s.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=Kn(),a=s.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((e,t)=>o.set(e,t))),!(o.size()>=r)););return se.resolve(o)}we(e,t,n){const r=this.overlays.get(n.key);if(null!==r){const e=this.ls.get(r.largestBatchId).delete(n.key);this.ls.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new Rr(t,n));let s=this.ls.get(t);void 0===s&&(s=Hn(),this.ls.set(t,s)),this.ls.set(t,s.add(n.key))}}class ao{constructor(){this.fs=new tt(co.ds),this.ws=new tt(co._s)}isEmpty(){return this.fs.isEmpty()}addReference(e,t){const n=new co(e,t);this.fs=this.fs.add(n),this.ws=this.ws.add(n)}gs(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.ys(new co(e,t))}ps(e,t){e.forEach((e=>this.removeReference(e,t)))}Is(e){const t=new $(new z([])),n=new co(t,e),r=new co(t,e+1),s=[];return this.ws.forEachInRange([n,r],(e=>{this.ys(e),s.push(e.key)})),s}Ts(){this.fs.forEach((e=>this.ys(e)))}ys(e){this.fs=this.fs.delete(e),this.ws=this.ws.delete(e)}Es(e){const t=new $(new z([])),n=new co(t,e),r=new co(t,e+1);let s=Hn();return this.ws.forEachInRange([n,r],(e=>{s=s.add(e.key)})),s}containsKey(e){const t=new co(e,0),n=this.fs.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class co{constructor(e,t){this.key=e,this.As=t}static ds(e,t){return $.comparator(e.key,t.key)||L(e.As,t.As)}static _s(e,t){return L(e.As,t.As)||$.comparator(e.key,t.key)}}class uo{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.vs=1,this.Rs=new tt(co.ds)}checkEmpty(e){return se.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){const s=this.vs;this.vs++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new Ar(s,t,n,r);this.mutationQueue.push(i);for(const o of r)this.Rs=this.Rs.add(new co(o.key,s)),this.indexManager.addToCollectionParentIndex(e,o.key.path.popLast());return se.resolve(i)}lookupMutationBatch(e,t){return se.resolve(this.Ps(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=this.bs(n),s=r<0?0:r;return se.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return se.resolve(0===this.mutationQueue.length?-1:this.vs-1)}getAllMutationBatches(e){return se.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new co(t,0),r=new co(t,Number.POSITIVE_INFINITY),s=[];return this.Rs.forEachInRange([n,r],(e=>{const t=this.Ps(e.As);s.push(t)})),se.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new tt(L);return t.forEach((e=>{const t=new co(e,0),r=new co(e,Number.POSITIVE_INFINITY);this.Rs.forEachInRange([t,r],(e=>{n=n.add(e.As)}))})),se.resolve(this.Vs(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;$.isDocumentKey(s)||(s=s.child(""));const i=new co(new $(s),0);let o=new tt(L);return this.Rs.forEachWhile((e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(o=o.add(e.As)),!0)}),i),se.resolve(this.Vs(o))}Vs(e){const t=[];return e.forEach((e=>{const n=this.Ps(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){I(0===this.Ss(t.batchId,"removed")),this.mutationQueue.shift();let n=this.Rs;return se.forEach(t.mutations,(r=>{const s=new co(r.key,t.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)})).next((()=>{this.Rs=n}))}Cn(e){}containsKey(e,t){const n=new co(t,0),r=this.Rs.firstAfterOrEqual(n);return se.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,se.resolve()}Ss(e,t){return this.bs(e)}bs(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Ps(e){const t=this.bs(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class lo{constructor(e){this.Ds=e,this.docs=new Je($.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.Ds(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return se.resolve(n?n.document.mutableCopy():Ut.newInvalidDocument(t))}getEntries(e,t){let n=Un();return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():Ut.newInvalidDocument(e))})),se.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let s=Un();const i=t.path,o=new $(i.child("")),a=this.docs.getIteratorFrom(o);for(;a.hasNext();){const{key:e,value:{document:o}}=a.getNext();if(!i.isPrefixOf(e.path))break;e.path.length>i.length+1||ee(J(o),n)<=0||(r.has(o.key)||Vn(t,o))&&(s=s.insert(o.key,o.mutableCopy()))}return se.resolve(s)}getAllFromCollectionGroup(e,t,n,r){v()}Cs(e,t){return se.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new ho(this)}getSize(e){return se.resolve(this.size)}}class ho extends Wi{constructor(e){super(),this.os=e}applyChanges(e){const t=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?t.push(this.os.addEntry(e,r)):this.os.removeEntry(n)})),se.waitFor(t)}getFromCache(e,t){return this.os.getEntry(e,t)}getAllFromCache(e,t){return this.os.getEntries(e,t)}}class fo{constructor(e){this.persistence=e,this.xs=new Pn((e=>mn(e)),gn),this.lastRemoteSnapshotVersion=U.min(),this.highestTargetId=0,this.Ns=0,this.ks=new ao,this.targetCount=0,this.Ms=Li.kn()}forEachTarget(e,t){return this.xs.forEach(((e,n)=>t(n))),se.resolve()}getLastRemoteSnapshotVersion(e){return se.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return se.resolve(this.Ns)}allocateTargetId(e){return this.highestTargetId=this.Ms.next(),se.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Ns&&(this.Ns=t),se.resolve()}Fn(e){this.xs.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.Ms=new Li(t),this.highestTargetId=t),e.sequenceNumber>this.Ns&&(this.Ns=e.sequenceNumber)}addTargetData(e,t){return this.Fn(t),this.targetCount+=1,se.resolve()}updateTargetData(e,t){return this.Fn(t),se.resolve()}removeTargetData(e,t){return this.xs.delete(t.target),this.ks.Is(t.targetId),this.targetCount-=1,se.resolve()}removeTargets(e,t,n){let r=0;const s=[];return this.xs.forEach(((i,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.xs.delete(i),s.push(this.removeMatchingKeysForTargetId(e,o.targetId)),r++)})),se.waitFor(s).next((()=>r))}getTargetCount(e){return se.resolve(this.targetCount)}getTargetData(e,t){const n=this.xs.get(t)||null;return se.resolve(n)}addMatchingKeys(e,t,n){return this.ks.gs(t,n),se.resolve()}removeMatchingKeys(e,t,n){this.ks.ps(t,n);const r=this.persistence.referenceDelegate,s=[];return r&&t.forEach((t=>{s.push(r.markPotentiallyOrphaned(e,t))})),se.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.ks.Is(t),se.resolve()}getMatchingKeysForTargetId(e,t){const n=this.ks.Es(t);return se.resolve(n)}containsKey(e,t){return se.resolve(this.ks.containsKey(t))}}class mo{constructor(e,t){this.$s={},this.overlays={},this.Os=new pe(0),this.Fs=!1,this.Fs=!0,this.referenceDelegate=e(this),this.Bs=new fo(this),this.indexManager=new wi,this.remoteDocumentCache=function(e){return new lo(e)}((e=>this.referenceDelegate.Ls(e))),this.serializer=new Ms(t),this.qs=new io(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Fs=!1,Promise.resolve()}get started(){return this.Fs}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new oo,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.$s[e.toKey()];return n||(n=new uo(t,this.referenceDelegate),this.$s[e.toKey()]=n),n}getTargetCache(){return this.Bs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.qs}runTransaction(e,t,n){g("MemoryPersistence","Starting transaction:",e);const r=new go(this.Os.next());return this.referenceDelegate.Us(),n(r).next((e=>this.referenceDelegate.Ks(r).next((()=>e)))).toPromise().then((e=>(r.raiseOnCommittedEvent(),e)))}Gs(e,t){return se.or(Object.values(this.$s).map((n=>()=>n.containsKey(e,t))))}}class go extends ne{constructor(e){super(),this.currentSequenceNumber=e}}class po{constructor(e){this.persistence=e,this.Qs=new ao,this.js=null}static zs(e){return new po(e)}get Ws(){if(this.js)return this.js;throw v()}addReference(e,t,n){return this.Qs.addReference(n,t),this.Ws.delete(n.toString()),se.resolve()}removeReference(e,t,n){return this.Qs.removeReference(n,t),this.Ws.add(n.toString()),se.resolve()}markPotentiallyOrphaned(e,t){return this.Ws.add(t.toString()),se.resolve()}removeTarget(e,t){this.Qs.Is(t.targetId).forEach((e=>this.Ws.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.Ws.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}Us(){this.js=new Set}Ks(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return se.forEach(this.Ws,(n=>{const r=$.fromPath(n);return this.Hs(e,r).next((e=>{e||t.removeEntry(r,U.min())}))})).next((()=>(this.js=null,t.apply(e))))}updateLimboDocument(e,t){return this.Hs(e,t).next((e=>{e?this.Ws.delete(t.toString()):this.Ws.add(t.toString())}))}Ls(e){return 0}Hs(e,t){return se.or([()=>se.resolve(this.Qs.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Gs(e,t)])}}class yo{constructor(e){this.serializer=e}O(e,t,n,r){const s=new ie("createOrUpgrade",t);n<1&&r>=1&&(function(e){e.createObjectStore("owner")}(e),function(e){e.createObjectStore("mutationQueues",{keyPath:"userId"}),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Se,{unique:!0}),e.createObjectStore("documentMutations")}(e),wo(e),function(e){e.createObjectStore("remoteDocuments")}(e));let i=se.resolve();return n<3&&r>=3&&(0!==n&&(function(e){e.deleteObjectStore("targetDocuments"),e.deleteObjectStore("targets"),e.deleteObjectStore("targetGlobal")}(e),wo(e)),i=i.next((()=>function(e){const t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:U.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)}(s)))),n<4&&r>=4&&(0!==n&&(i=i.next((()=>function(e,t){return t.store("mutations").j().next((n=>{e.deleteObjectStore("mutations"),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Se,{unique:!0});const r=t.store("mutations"),s=n.map((e=>r.put(e)));return se.waitFor(s)}))}(e,s)))),i=i.next((()=>{!function(e){e.createObjectStore("clientMetadata",{keyPath:"clientId"})}(e)}))),n<5&&r>=5&&(i=i.next((()=>this.Ys(s)))),n<6&&r>=6&&(i=i.next((()=>(function(e){e.createObjectStore("remoteDocumentGlobal")}(e),this.Xs(s))))),n<7&&r>=7&&(i=i.next((()=>this.Zs(s)))),n<8&&r>=8&&(i=i.next((()=>this.ti(e,s)))),n<9&&r>=9&&(i=i.next((()=>{!function(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e)}))),n<10&&r>=10&&(i=i.next((()=>this.ei(s)))),n<11&&r>=11&&(i=i.next((()=>{!function(e){e.createObjectStore("bundles",{keyPath:"bundleId"})}(e),function(e){e.createObjectStore("namedQueries",{keyPath:"name"})}(e)}))),n<12&&r>=12&&(i=i.next((()=>{!function(e){const t=e.createObjectStore("documentOverlays",{keyPath:qe});t.createIndex("collectionPathOverlayIndex",Ue,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",Be,{unique:!1})}(e)}))),n<13&&r>=13&&(i=i.next((()=>function(e){const t=e.createObjectStore("remoteDocumentsV14",{keyPath:Ne});t.createIndex("documentKeyIndex",Ce),t.createIndex("collectionGroupIndex",Ae)}(e))).next((()=>this.ni(e,s))).next((()=>e.deleteObjectStore("remoteDocuments")))),n<14&&r>=14&&(i=i.next((()=>this.si(e,s)))),n<15&&r>=15&&(i=i.next((()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Me}).createIndex("sequenceNumberIndex",Le,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Oe}).createIndex("documentKeyIndex",Pe,{unique:!1})}(e)))),i}Xs(e){let t=0;return e.store("remoteDocuments").X(((e,n)=>{t+=Ai(n)})).next((()=>{const n={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}Ys(e){const t=e.store("mutationQueues"),n=e.store("mutations");return t.j().next((t=>se.forEach(t,(t=>{const r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.j("userMutationsIndex",r).next((n=>se.forEach(n,(n=>{I(n.userId===t.userId);const r=Us(this.serializer,n);return Ci(e,t.userId,r).next((()=>{}))}))))}))))}Zs(e){const t=e.store("targetDocuments"),n=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next((e=>{const r=[];return n.X(((n,s)=>{const i=new z(n),o=function(e){return[0,Ie(e)]}(i);r.push(t.get(o).next((n=>n?se.resolve():(n=>t.put({targetId:0,path:Ie(n),sequenceNumber:e.highestListenSequenceNumber}))(i))))})).next((()=>se.waitFor(r)))}))}ti(e,t){e.createObjectStore("collectionParents",{keyPath:Ve});const n=t.store("collectionParents"),r=new vi,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:Ie(r)})}};return t.store("remoteDocuments").X({Y:!0},((e,t)=>{const n=new z(e);return s(n.popLast())})).next((()=>t.store("documentMutations").X({Y:!0},(([e,t,n],r)=>{const i=Te(t);return s(i.popLast())}))))}ei(e){const t=e.store("targets");return t.X(((e,n)=>{const r=Bs(n),s=zs(this.serializer,r);return t.put(s)}))}ni(e,t){const n=t.store("remoteDocuments"),r=[];return n.X(((e,n)=>{const s=t.store("remoteDocumentsV14"),i=(o=n,o.document?new $(z.fromString(o.document.name).popFirst(5)):o.noDocument?$.fromSegments(o.noDocument.path):o.unknownDocument?$.fromSegments(o.unknownDocument.path):v()).path.toArray();var o;const a={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(s.put(a))})).next((()=>se.waitFor(r)))}si(e,t){const n=t.store("mutations"),r=Yi(this.serializer),s=new mo(po.zs,this.serializer.fe);return n.j().next((e=>{const n=new Map;return e.forEach((e=>{var t;let r=null!==(t=n.get(e.userId))&&void 0!==t?t:Hn();Us(this.serializer,e).keys().forEach((e=>r=r.add(e))),n.set(e.userId,r)})),se.forEach(n,((e,n)=>{const i=new l(n),o=Ys.de(this.serializer,i),a=s.getIndexManager(i),c=ki.de(i,this.serializer,a,s.referenceDelegate);return new so(r,c,o,a).recalculateAndSaveOverlaysForDocumentKeys(new Qe(t,pe.ct),e).next()}))}))}}function wo(e){e.createObjectStore("targetDocuments",{keyPath:Re}).createIndex("documentTargetsIndex",Fe,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",ke,{unique:!0}),e.createObjectStore("targetGlobal")}const vo="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Io{constructor(e,t,n,r,s,i,o,a,c,u,l=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.ii=s,this.window=i,this.document=o,this.ri=c,this.oi=u,this.ui=l,this.Os=null,this.Fs=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ci=null,this.inForeground=!1,this.ai=null,this.hi=null,this.li=Number.NEGATIVE_INFINITY,this.fi=e=>Promise.resolve(),!Io.D())throw new S(T.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new ji(this,r),this.di=t+"main",this.serializer=new Ms(a),this.wi=new oe(this.di,this.ui,new yo(this.serializer)),this.Bs=new Oi(this.referenceDelegate,this.serializer),this.remoteDocumentCache=Yi(this.serializer),this.qs=new Qs,this.window&&this.window.localStorage?this._i=this.window.localStorage:(this._i=null,!1===u&&p("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.mi().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new S(T.FAILED_PRECONDITION,vo);return this.gi(),this.yi(),this.pi(),this.runTransaction("getHighestListenSequenceNumber","readonly",(e=>this.Bs.getHighestSequenceNumber(e)))})).then((e=>{this.Os=new pe(e,this.ri)})).then((()=>{this.Fs=!0})).catch((e=>(this.wi&&this.wi.close(),Promise.reject(e))))}Ii(e){return this.fi=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.wi.B((async t=>{null===t.newVersion&&await e()}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.ii.enqueueAndForget((async()=>{this.started&&await this.mi()})))}mi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(e=>Eo(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.Ti(e).next((e=>{e||(this.isPrimary=!1,this.ii.enqueueRetryable((()=>this.fi(!1))))}))})).next((()=>this.Ei(e))).next((t=>this.isPrimary&&!t?this.Ai(e).next((()=>!1)):!!t&&this.vi(e).next((()=>!0)))))).catch((e=>{if(ue(e))return g("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return g("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1})).then((e=>{this.isPrimary!==e&&this.ii.enqueueRetryable((()=>this.fi(e))),this.isPrimary=e}))}Ti(e){return bo(e).get("owner").next((e=>se.resolve(this.Ri(e))))}Pi(e){return Eo(e).delete(this.clientId)}async bi(){if(this.isPrimary&&!this.Vi(this.li,18e5)){this.li=Date.now();const e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(e=>{const t=We(e,"clientMetadata");return t.j().next((e=>{const n=this.Si(e,18e5),r=e.filter((e=>-1===n.indexOf(e)));return se.forEach(r,(e=>t.delete(e.clientId))).next((()=>r))}))})).catch((()=>[]));if(this._i)for(const t of e)this._i.removeItem(this.Di(t.clientId))}}pi(){this.hi=this.ii.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.mi().then((()=>this.bi())).then((()=>this.pi()))))}Ri(e){return!!e&&e.ownerId===this.clientId}Ei(e){return this.oi?se.resolve(!0):bo(e).get("owner").next((t=>{if(null!==t&&this.Vi(t.leaseTimestampMs,5e3)&&!this.Ci(t.ownerId)){if(this.Ri(t)&&this.networkEnabled)return!0;if(!this.Ri(t)){if(!t.allowTabSynchronization)throw new S(T.FAILED_PRECONDITION,vo);return!1}}return!(!this.networkEnabled||!this.inForeground)||Eo(e).j().next((e=>void 0===this.Si(e,5e3).find((e=>{if(this.clientId!==e.clientId){const t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))))})).next((e=>(this.isPrimary!==e&&g("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e)))}async shutdown(){this.Fs=!1,this.xi(),this.hi&&(this.hi.cancel(),this.hi=null),this.Ni(),this.ki(),await this.wi.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(e=>{const t=new Qe(e,pe.ct);return this.Ai(t).next((()=>this.Pi(t)))})),this.wi.close(),this.Mi()}Si(e,t){return e.filter((e=>this.Vi(e.updateTimeMs,t)&&!this.Ci(e.clientId)))}$i(){return this.runTransaction("getActiveClients","readonly",(e=>Eo(e).j().next((e=>this.Si(e,18e5).map((e=>e.clientId))))))}get started(){return this.Fs}getMutationQueue(e,t){return ki.de(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Bs}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new bi(e,this.serializer.fe.databaseId)}getDocumentOverlayCache(e){return Ys.de(this.serializer,e)}getBundleCache(){return this.qs}runTransaction(e,t,n){g("IndexedDbPersistence","Starting transaction:",e);const r="readonly"===t?"readonly":"readwrite",s=15===(i=this.ui)?je:14===i?$e:13===i?Ke:12===i?Ge:11===i?ze:void v();var i;let o;return this.wi.runTransaction(e,r,s,(r=>(o=new Qe(r,this.Os?this.Os.next():pe.ct),"readwrite-primary"===t?this.Ti(o).next((e=>!!e||this.Ei(o))).next((t=>{if(!t)throw p(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.ii.enqueueRetryable((()=>this.fi(!1))),new S(T.FAILED_PRECONDITION,te);return n(o)})).next((e=>this.vi(o).next((()=>e)))):this.Oi(o).next((()=>n(o)))))).then((e=>(o.raiseOnCommittedEvent(),e)))}Oi(e){return bo(e).get("owner").next((e=>{if(null!==e&&this.Vi(e.leaseTimestampMs,5e3)&&!this.Ci(e.ownerId)&&!this.Ri(e)&&!(this.oi||this.allowTabSynchronization&&e.allowTabSynchronization))throw new S(T.FAILED_PRECONDITION,vo)}))}vi(e){const t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return bo(e).put("owner",t)}static D(){return oe.D()}Ai(e){const t=bo(e);return t.get("owner").next((e=>this.Ri(e)?(g("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):se.resolve()))}Vi(e,t){const n=Date.now();return!(e<n-t)&&(!(e>n)||(p(`Detected an update time that is in the future: ${e} > ${n}`),!1))}gi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ai=()=>{this.ii.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.mi())))},this.document.addEventListener("visibilitychange",this.ai),this.inForeground="visible"===this.document.visibilityState)}Ni(){this.ai&&(this.document.removeEventListener("visibilitychange",this.ai),this.ai=null)}yi(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.ci=()=>{this.xi();const e=/(?:Version|Mobile)\/1[456]/;(0,o.G6)()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.ii.enterRestrictedMode(!0),this.ii.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.ci))}ki(){this.ci&&(this.window.removeEventListener("pagehide",this.ci),this.ci=null)}Ci(e){var t;try{const n=null!==(null===(t=this._i)||void 0===t?void 0:t.getItem(this.Di(e)));return g("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return p("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}xi(){if(this._i)try{this._i.setItem(this.Di(this.clientId),String(Date.now()))}catch(e){p("Failed to set zombie client id.",e)}}Mi(){if(this._i)try{this._i.removeItem(this.Di(this.clientId))}catch(e){}}Di(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function bo(e){return We(e,"owner")}function Eo(e){return We(e,"clientMetadata")}function To(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class So{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Fi=n,this.Bi=r}static Li(e,t){let n=Hn(),r=Hn();for(const s of t.docChanges)switch(s.type){case 0:n=n.add(s.doc.key);break;case 1:r=r.add(s.doc.key)}return new So(e,t.fromCache,n,r)}}class xo{constructor(){this.qi=!1}initialize(e,t){this.Ui=e,this.indexManager=t,this.qi=!0}getDocumentsMatchingQuery(e,t,n,r){return this.Ki(e,t).next((s=>s||this.Gi(e,t,r,n))).next((n=>n||this.Qi(e,t)))}Ki(e,t){if(Tn(t))return se.resolve(null);let n=Nn(t);return this.indexManager.getIndexType(e,n).next((r=>0===r?null:(null!==t.limit&&1===r&&(t=An(t,null,"F"),n=Nn(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next((r=>{const s=Hn(...r);return this.Ui.getDocuments(e,s).next((r=>this.indexManager.getMinOffset(e,n).next((n=>{const i=this.ji(t,r);return this.zi(t,i,s,n.readTime)?this.Ki(e,An(t,null,"F")):this.Wi(e,i,t,n)}))))})))))}Gi(e,t,n,r){return Tn(t)||r.isEqual(U.min())?this.Qi(e,t):this.Ui.getDocuments(e,n).next((s=>{const o=this.ji(t,s);return this.zi(t,o,n,r)?this.Qi(e,t):(f()<=i.in.DEBUG&&g("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),Fn(t)),this.Wi(e,o,t,X(r,-1)))}))}ji(e,t){let n=new tt(Ln(e));return t.forEach(((t,r)=>{Vn(e,r)&&(n=n.add(r))})),n}zi(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}Qi(e,t){return f()<=i.in.DEBUG&&g("QueryEngine","Using full collection scan to execute query:",Fn(t)),this.Ui.getDocumentsMatchingQuery(e,t,Z.min())}Wi(e,t,n,r){return this.Ui.getDocumentsMatchingQuery(e,n,r).next((e=>(t.forEach((t=>{e=e.insert(t.key,t)})),e)))}}class _o{constructor(e,t,n,r){this.persistence=e,this.Hi=t,this.serializer=r,this.Ji=new Je(L),this.Yi=new Pn((e=>mn(e)),gn),this.Xi=new Map,this.Zi=e.getRemoteDocumentCache(),this.Bs=e.getTargetCache(),this.qs=e.getBundleCache(),this.tr(n)}tr(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new so(this.Zi,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Zi.setIndexManager(this.indexManager),this.Hi.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.Ji)))}}function Do(e,t,n,r){return new _o(e,t,n,r)}async function No(e,t){const n=E(e);return await n.persistence.runTransaction("Handle user change","readonly",(e=>{let r;return n.mutationQueue.getAllMutationBatches(e).next((s=>(r=s,n.tr(t),n.mutationQueue.getAllMutationBatches(e)))).next((t=>{const s=[],i=[];let o=Hn();for(const e of r){s.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){i.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return n.localDocuments.getDocuments(e,o).next((e=>({er:e,removedBatchIds:s,addedBatchIds:i})))}))}))}function Co(e){const t=E(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.Bs.getLastRemoteSnapshotVersion(e)))}function Ao(e,t,n){let r=Hn(),s=Hn();return n.forEach((e=>r=r.add(e))),t.getEntries(e,r).next((e=>{let r=Un();return n.forEach(((n,i)=>{const o=e.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(s=s.add(n)),i.isNoDocument()&&i.version.isEqual(U.min())?(t.removeEntry(n,i.readTime),r=r.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(t.addEntry(i),r=r.insert(n,i)):g("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)})),{nr:r,sr:s}}))}function ko(e,t){const n=E(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t))))}function Ro(e,t){const n=E(e);return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let r;return n.Bs.getTargetData(e,t).next((s=>s?(r=s,se.resolve(r)):n.Bs.allocateTargetId(e).next((s=>(r=new Vs(t,s,"TargetPurposeListen",e.currentSequenceNumber),n.Bs.addTargetData(e,r).next((()=>r)))))))})).then((e=>{const r=n.Ji.get(e.targetId);return(null===r||e.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.Ji=n.Ji.insert(e.targetId,e),n.Yi.set(t,e.targetId)),e}))}async function Fo(e,t,n){const r=E(e),s=r.Ji.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,(e=>r.persistence.referenceDelegate.removeTarget(e,s)))}catch(e){if(!ue(e))throw e;g("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.Ji=r.Ji.remove(t),r.Yi.delete(s.target)}function Vo(e,t,n){const r=E(e);let s=U.min(),i=Hn();return r.persistence.runTransaction("Execute query","readonly",(e=>function(e,t,n){const r=E(e),s=r.Yi.get(n);return void 0!==s?se.resolve(r.Ji.get(s)):r.Bs.getTargetData(t,n)}(r,e,Nn(t)).next((t=>{if(t)return s=t.lastLimboFreeSnapshotVersion,r.Bs.getMatchingKeysForTargetId(e,t.targetId).next((e=>{i=e}))})).next((()=>r.Hi.getDocumentsMatchingQuery(e,t,n?s:U.min(),n?i:Hn()))).next((e=>(Oo(r,Mn(t),e),{documents:e,ir:i})))))}function Mo(e,t){const n=E(e),r=E(n.Bs),s=n.Ji.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",(e=>r.le(e,t).next((e=>e?e.target:null))))}function Lo(e,t){const n=E(e),r=n.Xi.get(t)||U.min();return n.persistence.runTransaction("Get new document changes","readonly",(e=>n.Zi.getAllFromCollectionGroup(e,t,X(r,-1),Number.MAX_SAFE_INTEGER))).then((e=>(Oo(n,t,e),e)))}function Oo(e,t,n){let r=e.Xi.get(t)||U.min();n.forEach(((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)})),e.Xi.set(t,r)}async function Po(e,t,n=Hn()){const r=await Ro(e,Nn(Gs(t.bundledQuery))),s=E(e);return s.persistence.runTransaction("Save named query","readwrite",(e=>{const i=us(t.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.qs.saveNamedQuery(e,t);const o=r.withResumeToken(at.EMPTY_BYTE_STRING,i);return s.Ji=s.Ji.insert(o.targetId,o),s.Bs.updateTargetData(e,o).next((()=>s.Bs.removeMatchingKeysForTargetId(e,r.targetId))).next((()=>s.Bs.addMatchingKeys(e,n,r.targetId))).next((()=>s.qs.saveNamedQuery(e,t)))}))}function qo(e,t){return`firestore_clients_${e}_${t}`}function Uo(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function Bo(e,t){return`firestore_targets_${e}_${t}`}class zo{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static ar(e,t,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new S(r.error.code,r.error.message))),i?new zo(e,t,r.state,s):(p("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}hr(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Go{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static ar(e,t){const n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new S(n.error.code,n.error.message))),s?new Go(e,n.state,r):(p("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}hr(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Ko{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static ar(e,t){const n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=Xn();for(let i=0;r&&i<n.activeTargetIds.length;++i)r=ve(n.activeTargetIds[i]),s=s.add(n.activeTargetIds[i]);return r?new Ko(e,s):(p("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class $o{constructor(e,t){this.clientId=e,this.onlineState=t}static ar(e){const t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new $o(t.clientId,t.onlineState):(p("SharedClientState",`Failed to parse online state: ${e}`),null)}}class jo{constructor(){this.activeTargetIds=Xn()}lr(e){this.activeTargetIds=this.activeTargetIds.add(e)}dr(e){this.activeTargetIds=this.activeTargetIds.delete(e)}hr(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class Qo{constructor(e,t,n,r,s){this.window=e,this.ii=t,this.persistenceKey=n,this.wr=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this._r=this.mr.bind(this),this.gr=new Je(L),this.started=!1,this.yr=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.pr=qo(this.persistenceKey,this.wr),this.Ir=function(e){return`firestore_sequence_number_${e}`}(this.persistenceKey),this.gr=this.gr.insert(this.wr,new jo),this.Tr=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.Er=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.Ar=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.vr=function(e){return`firestore_online_state_${e}`}(this.persistenceKey),this.Rr=function(e){return`firestore_bundle_loaded_v2_${e}`}(this.persistenceKey),this.window.addEventListener("storage",this._r)}static D(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.$i();for(const n of e){if(n===this.wr)continue;const e=this.getItem(qo(this.persistenceKey,n));if(e){const t=Ko.ar(n,e);t&&(this.gr=this.gr.insert(t.clientId,t))}}this.Pr();const t=this.storage.getItem(this.vr);if(t){const e=this.br(t);e&&this.Vr(e)}for(const n of this.yr)this.mr(n);this.yr=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(e){this.setItem(this.Ir,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Sr(this.gr)}isActiveQueryTarget(e){let t=!1;return this.gr.forEach(((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)})),t}addPendingMutation(e){this.Dr(e,"pending")}updateMutationState(e,t,n){this.Dr(e,t,n),this.Cr(e)}addLocalQueryTarget(e){let t="not-current";if(this.isActiveQueryTarget(e)){const n=this.storage.getItem(Bo(this.persistenceKey,e));if(n){const r=Go.ar(e,n);r&&(t=r.state)}}return this.Nr.lr(e),this.Pr(),t}removeLocalQueryTarget(e){this.Nr.dr(e),this.Pr()}isLocalQueryTarget(e){return this.Nr.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(Bo(this.persistenceKey,e))}updateQueryState(e,t,n){this.kr(e,t,n)}handleUserChange(e,t,n){t.forEach((e=>{this.Cr(e)})),this.currentUser=e,n.forEach((e=>{this.addPendingMutation(e)}))}setOnlineState(e){this.Mr(e)}notifyBundleLoaded(e){this.$r(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this._r),this.removeItem(this.pr),this.started=!1)}getItem(e){const t=this.storage.getItem(e);return g("SharedClientState","READ",e,t),t}setItem(e,t){g("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){g("SharedClientState","REMOVE",e),this.storage.removeItem(e)}mr(e){const t=e;if(t.storageArea===this.storage){if(g("SharedClientState","EVENT",t.key,t.newValue),t.key===this.pr)return void p("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.ii.enqueueRetryable((async()=>{if(this.started){if(null!==t.key)if(this.Tr.test(t.key)){if(null==t.newValue){const e=this.Or(t.key);return this.Fr(e,null)}{const e=this.Br(t.key,t.newValue);if(e)return this.Fr(e.clientId,e)}}else if(this.Er.test(t.key)){if(null!==t.newValue){const e=this.Lr(t.key,t.newValue);if(e)return this.qr(e)}}else if(this.Ar.test(t.key)){if(null!==t.newValue){const e=this.Ur(t.key,t.newValue);if(e)return this.Kr(e)}}else if(t.key===this.vr){if(null!==t.newValue){const e=this.br(t.newValue);if(e)return this.Vr(e)}}else if(t.key===this.Ir){const e=function(e){let t=pe.ct;if(null!=e)try{const n=JSON.parse(e);I("number"==typeof n),t=n}catch(e){p("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(t.newValue);e!==pe.ct&&this.sequenceNumberHandler(e)}else if(t.key===this.Rr){const e=this.Gr(t.newValue);await Promise.all(e.map((e=>this.syncEngine.Qr(e))))}}else this.yr.push(t)}))}}get Nr(){return this.gr.get(this.wr)}Pr(){this.setItem(this.pr,this.Nr.hr())}Dr(e,t,n){const r=new zo(this.currentUser,e,t,n),s=Uo(this.persistenceKey,this.currentUser,e);this.setItem(s,r.hr())}Cr(e){const t=Uo(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Mr(e){const t={clientId:this.wr,onlineState:e};this.storage.setItem(this.vr,JSON.stringify(t))}kr(e,t,n){const r=Bo(this.persistenceKey,e),s=new Go(e,t,n);this.setItem(r,s.hr())}$r(e){const t=JSON.stringify(Array.from(e));this.setItem(this.Rr,t)}Or(e){const t=this.Tr.exec(e);return t?t[1]:null}Br(e,t){const n=this.Or(e);return Ko.ar(n,t)}Lr(e,t){const n=this.Er.exec(e),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return zo.ar(new l(s),r,t)}Ur(e,t){const n=this.Ar.exec(e),r=Number(n[1]);return Go.ar(r,t)}br(e){return $o.ar(e)}Gr(e){return JSON.parse(e)}async qr(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.jr(e.batchId,e.state,e.error);g("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}Kr(e){return this.syncEngine.zr(e.targetId,e.state,e.error)}Fr(e,t){const n=t?this.gr.insert(e,t):this.gr.remove(e),r=this.Sr(this.gr),s=this.Sr(n),i=[],o=[];return s.forEach((e=>{r.has(e)||i.push(e)})),r.forEach((e=>{s.has(e)||o.push(e)})),this.syncEngine.Wr(i,o).then((()=>{this.gr=n}))}Vr(e){this.gr.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Sr(e){let t=Xn();return e.forEach(((e,n)=>{t=t.unionWith(n.activeTargetIds)})),t}}class Wo{constructor(){this.Hr=new jo,this.Jr={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.Hr.lr(e),this.Jr[e]||"not-current"}updateQueryState(e,t,n){this.Jr[e]=t}removeLocalQueryTarget(e){this.Hr.dr(e)}isLocalQueryTarget(e){return this.Hr.activeTargetIds.has(e)}clearQueryState(e){delete this.Jr[e]}getAllActiveQueryTargets(){return this.Hr.activeTargetIds}isActiveQueryTarget(e){return this.Hr.activeTargetIds.has(e)}start(){return this.Hr=new jo,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class Ho{Yr(e){}shutdown(){}}class Yo{constructor(){this.Xr=()=>this.Zr(),this.eo=()=>this.no(),this.so=[],this.io()}Yr(e){this.so.push(e)}shutdown(){window.removeEventListener("online",this.Xr),window.removeEventListener("offline",this.eo)}io(){window.addEventListener("online",this.Xr),window.addEventListener("offline",this.eo)}Zr(){g("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.so)e(0)}no(){g("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.so)e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let Xo=null;function Jo(){return null===Xo?Xo=268435456+Math.round(2147483648*Math.random()):Xo++,"0x"+Xo.toString(16)}const Zo={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class ea{constructor(e){this.ro=e.ro,this.oo=e.oo}uo(e){this.co=e}ao(e){this.ho=e}onMessage(e){this.lo=e}close(){this.oo()}send(e){this.ro(e)}fo(){this.co()}wo(e){this.ho(e)}_o(e){this.lo(e)}}const ta="WebChannelConnection";class na extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http";this.mo=t+"://"+e.host,this.yo="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}get po(){return!1}Io(e,t,n,r,s){const i=Jo(),o=this.To(e,t);g("RestConnection",`Sending RPC '${e}' ${i}:`,o,n);const a={};return this.Eo(a,r,s),this.Ao(e,o,a,n).then((t=>(g("RestConnection",`Received RPC '${e}' ${i}: `,t),t)),(t=>{throw y("RestConnection",`RPC '${e}' ${i} failed with error: `,t,"url: ",o,"request:",n),t}))}vo(e,t,n,r,s,i){return this.Io(e,t,n,r,s)}Eo(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+h,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}To(e,t){const n=Zo[e];return`${this.mo}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Ao(e,t,n,r){const s=Jo();return new Promise(((i,o)=>{const c=new a.JJ;c.setWithCredentials(!0),c.listenOnce(a.tw.COMPLETE,(()=>{try{switch(c.getLastErrorCode()){case a.jK.NO_ERROR:const t=c.getResponseJson();g(ta,`XHR for RPC '${e}' ${s} received:`,JSON.stringify(t)),i(t);break;case a.jK.TIMEOUT:g(ta,`RPC '${e}' ${s} timed out`),o(new S(T.DEADLINE_EXCEEDED,"Request time out"));break;case a.jK.HTTP_ERROR:const n=c.getStatus();if(g(ta,`RPC '${e}' ${s} failed with status:`,n,"response text:",c.getResponseText()),n>0){let e=c.getResponseJson();Array.isArray(e)&&(e=e[0]);const t=null==e?void 0:e.error;if(t&&t.status&&t.message){const e=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(T).indexOf(t)>=0?t:T.UNKNOWN}(t.status);o(new S(e,t.message))}else o(new S(T.UNKNOWN,"Server responded with status "+c.getStatus()))}else o(new S(T.UNAVAILABLE,"Connection failed."));break;default:v()}}finally{g(ta,`RPC '${e}' ${s} completed.`)}}));const u=JSON.stringify(r);g(ta,`RPC '${e}' ${s} sending request:`,r),c.send(t,"POST",u,n,15)}))}Ro(e,t,n){const r=Jo(),s=[this.mo,"/","google.firestore.v1.Firestore","/",e,"/channel"],i=(0,a.UE)(),o=(0,a.FJ)(),c={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(c.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(c.xmlHttpFactory=new a.zI({})),this.Eo(c.initMessageHeaders,t,n),c.encodeInitMessageHeaders=!0;const l=s.join("");g(ta,`Creating RPC '${e}' stream ${r}: ${l}`,c);const h=i.createWebChannel(l,c);let d=!1,f=!1;const m=new ea({ro:t=>{f?g(ta,`Not sending because RPC '${e}' stream ${r} is closed:`,t):(d||(g(ta,`Opening RPC '${e}' stream ${r} transport.`),h.open(),d=!0),g(ta,`RPC '${e}' stream ${r} sending:`,t),h.send(t))},oo:()=>h.close()}),p=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return p(h,a.ii.EventType.OPEN,(()=>{f||g(ta,`RPC '${e}' stream ${r} transport opened.`)})),p(h,a.ii.EventType.CLOSE,(()=>{f||(f=!0,g(ta,`RPC '${e}' stream ${r} transport closed`),m.wo())})),p(h,a.ii.EventType.ERROR,(t=>{f||(f=!0,y(ta,`RPC '${e}' stream ${r} transport errored:`,t),m.wo(new S(T.UNAVAILABLE,"The operation could not be completed")))})),p(h,a.ii.EventType.MESSAGE,(t=>{var n;if(!f){const s=t.data[0];I(!!s);const i=s,o=i.error||(null===(n=i[0])||void 0===n?void 0:n.error);if(o){g(ta,`RPC '${e}' stream ${r} received error:`,o);const t=o.status;let n=function(e){const t=Vr[e];if(void 0!==t)return Or(t)}(t),s=o.message;void 0===n&&(n=T.INTERNAL,s="Unknown error status: "+t+" with message "+o.message),f=!0,m.wo(new S(n,s)),h.close()}else g(ta,`RPC '${e}' stream ${r} received:`,s),m._o(s)}})),p(o,a.ju.STAT_EVENT,(t=>{t.stat===a.kN.PROXY?g(ta,`RPC '${e}' stream ${r} detected buffering proxy`):t.stat===a.kN.NOPROXY&&g(ta,`RPC '${e}' stream ${r} detected no buffering proxy`)})),setTimeout((()=>{m.fo()}),0),m}}function ra(){return"undefined"!=typeof window?window:null}function sa(){return"undefined"!=typeof document?document:null}function ia(e){return new ss(e,!0)}class oa{constructor(e,t,n=1e3,r=1.5,s=6e4){this.ii=e,this.timerId=t,this.Po=n,this.bo=r,this.Vo=s,this.So=0,this.Do=null,this.Co=Date.now(),this.reset()}reset(){this.So=0}xo(){this.So=this.Vo}No(e){this.cancel();const t=Math.floor(this.So+this.ko()),n=Math.max(0,Date.now()-this.Co),r=Math.max(0,t-n);r>0&&g("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.So} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.Do=this.ii.enqueueAfterDelay(this.timerId,r,(()=>(this.Co=Date.now(),e()))),this.So*=this.bo,this.So<this.Po&&(this.So=this.Po),this.So>this.Vo&&(this.So=this.Vo)}Mo(){null!==this.Do&&(this.Do.skipDelay(),this.Do=null)}cancel(){null!==this.Do&&(this.Do.cancel(),this.Do=null)}ko(){return(Math.random()-.5)*this.So}}class aa{constructor(e,t,n,r,s,i,o,a){this.ii=e,this.$o=n,this.Oo=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.Fo=0,this.Bo=null,this.Lo=null,this.stream=null,this.qo=new oa(e,t)}Uo(){return 1===this.state||5===this.state||this.Ko()}Ko(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Go()}async stop(){this.Uo()&&await this.close(0)}Qo(){this.state=0,this.qo.reset()}jo(){this.Ko()&&null===this.Bo&&(this.Bo=this.ii.enqueueAfterDelay(this.$o,6e4,(()=>this.zo())))}Wo(e){this.Ho(),this.stream.send(e)}async zo(){if(this.Ko())return this.close(0)}Ho(){this.Bo&&(this.Bo.cancel(),this.Bo=null)}Jo(){this.Lo&&(this.Lo.cancel(),this.Lo=null)}async close(e,t){this.Ho(),this.Jo(),this.qo.cancel(),this.Fo++,4!==e?this.qo.reset():t&&t.code===T.RESOURCE_EXHAUSTED?(p(t.toString()),p("Using maximum backoff delay to prevent overloading the backend."),this.qo.xo()):t&&t.code===T.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Yo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.ao(t)}Yo(){}auth(){this.state=1;const e=this.Xo(this.Fo),t=this.Fo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([e,n])=>{this.Fo===t&&this.Zo(e,n)}),(t=>{e((()=>{const e=new S(T.UNKNOWN,"Fetching auth token failed: "+t.message);return this.tu(e)}))}))}Zo(e,t){const n=this.Xo(this.Fo);this.stream=this.eu(e,t),this.stream.uo((()=>{n((()=>(this.state=2,this.Lo=this.ii.enqueueAfterDelay(this.Oo,1e4,(()=>(this.Ko()&&(this.state=3),Promise.resolve()))),this.listener.uo())))})),this.stream.ao((e=>{n((()=>this.tu(e)))})),this.stream.onMessage((e=>{n((()=>this.onMessage(e)))}))}Go(){this.state=5,this.qo.No((async()=>{this.state=0,this.start()}))}tu(e){return g("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}Xo(e){return t=>{this.ii.enqueueAndForget((()=>this.Fo===e?t():(g("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class ca extends aa{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s}eu(e,t){return this.connection.Ro("Listen",e,t)}onMessage(e){this.qo.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const r=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:v()}(t.targetChange.targetChangeType||"NO_CHANGE"),s=t.targetChange.targetIds||[],i=function(e,t){return e.useProto3Json?(I(void 0===t||"string"==typeof t),at.fromBase64String(t||"")):(I(void 0===t||t instanceof Uint8Array),at.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(e){const t=void 0===e.code?T.UNKNOWN:Or(e.code);return new S(t,e.message||"")}(o);n=new Yr(r,s,i,a||null)}else if("documentChange"in t){t.documentChange;const r=t.documentChange;r.document,r.document.name,r.document.updateTime;const s=fs(e,r.document.name),i=us(r.document.updateTime),o=r.document.createTime?us(r.document.createTime):U.min(),a=new Pt({mapValue:{fields:r.document.fields}}),c=Ut.newFoundDocument(s,i,o,a),u=r.targetIds||[],l=r.removedTargetIds||[];n=new Wr(u,l,c.key,c)}else if("documentDelete"in t){t.documentDelete;const r=t.documentDelete;r.document;const s=fs(e,r.document),i=r.readTime?us(r.readTime):U.min(),o=Ut.newNoDocument(s,i),a=r.removedTargetIds||[];n=new Wr([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const r=t.documentRemove;r.document;const s=fs(e,r.document),i=r.removedTargetIds||[];n=new Wr([],i,s,null)}else{if(!("filter"in t))return v();{t.filter;const e=t.filter;e.targetId;const{count:r=0,unchangedNames:s}=e,i=new Fr(r,s),o=e.targetId;n=new Hr(o,i)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return U.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?U.min():t.readTime?us(t.readTime):U.min()}(e);return this.listener.nu(t,n)}su(e){const t={};t.database=ps(this.serializer),t.addTarget=function(e,t){let n;const r=t.target;if(n=pn(r)?{documents:Es(e,r)}:{query:Ts(e,r)},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=as(e,t.resumeToken);const r=is(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo(U.min())>0){n.readTime=os(e,t.snapshotVersion.toTimestamp());const r=is(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);const n=function(e,t){const n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return v()}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.Wo(t)}iu(e){const t={};t.database=ps(this.serializer),t.removeTarget=e,this.Wo(t)}}class ua extends aa{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s,this.ru=!1}get ou(){return this.ru}start(){this.ru=!1,this.lastStreamToken=void 0,super.start()}Yo(){this.ru&&this.uu([])}eu(e,t){return this.connection.Ro("Write",e,t)}onMessage(e){if(I(!!e.streamToken),this.lastStreamToken=e.streamToken,this.ru){this.qo.reset();const t=function(e,t){return e&&e.length>0?(I(void 0!==t),e.map((e=>function(e,t){let n=e.updateTime?us(e.updateTime):us(t);return n.isEqual(U.min())&&(n=us(t)),new mr(n,e.transformResults||[])}(e,t)))):[]}(e.writeResults,e.commitTime),n=us(e.commitTime);return this.listener.cu(n,t)}return I(!e.writeResults||0===e.writeResults.length),this.ru=!0,this.listener.au()}hu(){const e={};e.database=ps(this.serializer),this.Wo(e)}uu(e){const t={streamToken:this.lastStreamToken,writes:e.map((e=>Is(this.serializer,e)))};this.Wo(t)}}class la extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.lu=!1}fu(){if(this.lu)throw new S(T.FAILED_PRECONDITION,"The client has already been terminated.")}Io(e,t,n){return this.fu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,s])=>this.connection.Io(e,t,n,r,s))).catch((e=>{throw"FirebaseError"===e.name?(e.code===T.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new S(T.UNKNOWN,e.toString())}))}vo(e,t,n,r){return this.fu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,i])=>this.connection.vo(e,t,n,s,i,r))).catch((e=>{throw"FirebaseError"===e.name?(e.code===T.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new S(T.UNKNOWN,e.toString())}))}terminate(){this.lu=!0}}class ha{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.wu=0,this._u=null,this.mu=!0}gu(){0===this.wu&&(this.yu("Unknown"),this._u=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this._u=null,this.pu("Backend didn't respond within 10 seconds."),this.yu("Offline"),Promise.resolve()))))}Iu(e){"Online"===this.state?this.yu("Unknown"):(this.wu++,this.wu>=1&&(this.Tu(),this.pu(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.yu("Offline")))}set(e){this.Tu(),this.wu=0,"Online"===e&&(this.mu=!1),this.yu(e)}yu(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}pu(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.mu?(p(t),this.mu=!1):g("OnlineStateTracker",t)}Tu(){null!==this._u&&(this._u.cancel(),this._u=null)}}class da{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.Eu=[],this.Au=new Map,this.vu=new Set,this.Ru=[],this.Pu=s,this.Pu.Yr((e=>{n.enqueueAndForget((async()=>{ba(this)&&(g("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=E(e);t.vu.add(4),await ma(t),t.bu.set("Unknown"),t.vu.delete(4),await fa(t)}(this))}))})),this.bu=new ha(n,r)}}async function fa(e){if(ba(e))for(const t of e.Ru)await t(!0)}async function ma(e){for(const t of e.Ru)await t(!1)}function ga(e,t){const n=E(e);n.Au.has(t.targetId)||(n.Au.set(t.targetId,t),Ia(n)?va(n):qa(n).Ko()&&ya(n,t))}function pa(e,t){const n=E(e),r=qa(n);n.Au.delete(t),r.Ko()&&wa(n,t),0===n.Au.size&&(r.Ko()?r.jo():ba(n)&&n.bu.set("Unknown"))}function ya(e,t){if(e.Vu.qt(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(U.min())>0){const n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}qa(e).su(t)}function wa(e,t){e.Vu.qt(t),qa(e).iu(t)}function va(e){e.Vu=new Jr({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),le:t=>e.Au.get(t)||null,ue:()=>e.datastore.serializer.databaseId}),qa(e).start(),e.bu.gu()}function Ia(e){return ba(e)&&!qa(e).Uo()&&e.Au.size>0}function ba(e){return 0===E(e).vu.size}function Ea(e){e.Vu=void 0}async function Ta(e){e.Au.forEach(((t,n)=>{ya(e,t)}))}async function Sa(e,t){Ea(e),Ia(e)?(e.bu.Iu(t),va(e)):e.bu.set("Unknown")}async function xa(e,t,n){if(e.bu.set("Online"),t instanceof Yr&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const r of t.targetIds)e.Au.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.Au.delete(r),e.Vu.removeTarget(r))}(e,t)}catch(n){g("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await _a(e,n)}else if(t instanceof Wr?e.Vu.Ht(t):t instanceof Hr?e.Vu.ne(t):e.Vu.Xt(t),!n.isEqual(U.min()))try{const t=await Co(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.Vu.ce(t);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=e.Au.get(r);s&&e.Au.set(r,s.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach(((t,n)=>{const r=e.Au.get(t);if(!r)return;e.Au.set(t,r.withResumeToken(at.EMPTY_BYTE_STRING,r.snapshotVersion)),wa(e,t);const s=new Vs(r.target,t,n,r.sequenceNumber);ya(e,s)})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){g("RemoteStore","Failed to raise snapshot:",t),await _a(e,t)}}async function _a(e,t,n){if(!ue(t))throw t;e.vu.add(1),await ma(e),e.bu.set("Offline"),n||(n=()=>Co(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{g("RemoteStore","Retrying IndexedDB access"),await n(),e.vu.delete(1),await fa(e)}))}function Da(e,t){return t().catch((n=>_a(e,n,t)))}async function Na(e){const t=E(e),n=Ua(t);let r=t.Eu.length>0?t.Eu[t.Eu.length-1].batchId:-1;for(;Ca(t);)try{const e=await ko(t.localStore,r);if(null===e){0===t.Eu.length&&n.jo();break}r=e.batchId,Aa(t,e)}catch(e){await _a(t,e)}ka(t)&&Ra(t)}function Ca(e){return ba(e)&&e.Eu.length<10}function Aa(e,t){e.Eu.push(t);const n=Ua(e);n.Ko()&&n.ou&&n.uu(t.mutations)}function ka(e){return ba(e)&&!Ua(e).Uo()&&e.Eu.length>0}function Ra(e){Ua(e).start()}async function Fa(e){Ua(e).hu()}async function Va(e){const t=Ua(e);for(const n of e.Eu)t.uu(n.mutations)}async function Ma(e,t,n){const r=e.Eu.shift(),s=kr.from(r,t,n);await Da(e,(()=>e.remoteSyncer.applySuccessfulWrite(s))),await Na(e)}async function La(e,t){t&&Ua(e).ou&&await async function(e,t){if(Lr(n=t.code)&&n!==T.ABORTED){const n=e.Eu.shift();Ua(e).Qo(),await Da(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await Na(e)}var n}(e,t),ka(e)&&Ra(e)}async function Oa(e,t){const n=E(e);n.asyncQueue.verifyOperationInProgress(),g("RemoteStore","RemoteStore received new credentials");const r=ba(n);n.vu.add(3),await ma(n),r&&n.bu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.vu.delete(3),await fa(n)}async function Pa(e,t){const n=E(e);t?(n.vu.delete(2),await fa(n)):t||(n.vu.add(2),await ma(n),n.bu.set("Unknown"))}function qa(e){return e.Su||(e.Su=function(e,t,n){const r=E(e);return r.fu(),new ca(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{uo:Ta.bind(null,e),ao:Sa.bind(null,e),nu:xa.bind(null,e)}),e.Ru.push((async t=>{t?(e.Su.Qo(),Ia(e)?va(e):e.bu.set("Unknown")):(await e.Su.stop(),Ea(e))}))),e.Su}function Ua(e){return e.Du||(e.Du=function(e,t,n){const r=E(e);return r.fu(),new ua(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{uo:Fa.bind(null,e),ao:La.bind(null,e),au:Va.bind(null,e),cu:Ma.bind(null,e)}),e.Ru.push((async t=>{t?(e.Du.Qo(),await Na(e)):(await e.Du.stop(),e.Eu.length>0&&(g("RemoteStore",`Stopping write stream with ${e.Eu.length} pending writes`),e.Eu=[]))}))),e.Du}class Ba{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new x,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,o=new Ba(e,t,i,r,s);return o.start(n),o}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new S(T.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function za(e,t){if(p("AsyncQueue",`${t}: ${e}`),ue(e))return new S(T.UNAVAILABLE,`${t}: ${e}`);throw e}class Ga{constructor(e){this.comparator=e?(t,n)=>e(t,n)||$.comparator(t.key,n.key):(e,t)=>$.comparator(e.key,t.key),this.keyedMap=zn(),this.sortedSet=new Je(this.comparator)}static emptySet(e){return new Ga(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof Ga))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new Ga;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class Ka{constructor(){this.Cu=new Je($.comparator)}track(e){const t=e.doc.key,n=this.Cu.get(t);n?0!==e.type&&3===n.type?this.Cu=this.Cu.insert(t,e):3===e.type&&1!==n.type?this.Cu=this.Cu.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Cu=this.Cu.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Cu=this.Cu.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Cu=this.Cu.remove(t):1===e.type&&2===n.type?this.Cu=this.Cu.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Cu=this.Cu.insert(t,{type:2,doc:e.doc}):v():this.Cu=this.Cu.insert(t,e)}xu(){const e=[];return this.Cu.inorderTraversal(((t,n)=>{e.push(n)})),e}}class $a{constructor(e,t,n,r,s,i,o,a,c){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=c}static fromInitialDocuments(e,t,n,r,s){const i=[];return t.forEach((e=>{i.push({type:0,doc:e})})),new $a(e,t,Ga.emptySet(t),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&kn(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0}}class ja{constructor(){this.Nu=void 0,this.listeners=[]}}class Qa{constructor(){this.queries=new Pn((e=>Rn(e)),kn),this.onlineState="Unknown",this.ku=new Set}}async function Wa(e,t){const n=E(e),r=t.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new ja),s)try{i.Nu=await n.onListen(r)}catch(e){const n=za(e,`Initialization of query '${Fn(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,i),i.listeners.push(t),t.Mu(n.onlineState),i.Nu&&t.$u(i.Nu)&&Ja(n)}async function Ha(e,t){const n=E(e),r=t.query;let s=!1;const i=n.queries.get(r);if(i){const e=i.listeners.indexOf(t);e>=0&&(i.listeners.splice(e,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function Ya(e,t){const n=E(e);let r=!1;for(const s of t){const e=s.query,t=n.queries.get(e);if(t){for(const e of t.listeners)e.$u(s)&&(r=!0);t.Nu=s}}r&&Ja(n)}function Xa(e,t,n){const r=E(e),s=r.queries.get(t);if(s)for(const i of s.listeners)i.onError(n);r.queries.delete(t)}function Ja(e){e.ku.forEach((e=>{e.next()}))}class Za{constructor(e,t,n){this.query=e,this.Ou=t,this.Fu=!1,this.Bu=null,this.onlineState="Unknown",this.options=n||{}}$u(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new $a(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Fu?this.Lu(e)&&(this.Ou.next(e),t=!0):this.qu(e,this.onlineState)&&(this.Uu(e),t=!0),this.Bu=e,t}onError(e){this.Ou.error(e)}Mu(e){this.onlineState=e;let t=!1;return this.Bu&&!this.Fu&&this.qu(this.Bu,e)&&(this.Uu(this.Bu),t=!0),t}qu(e,t){if(!e.fromCache)return!0;const n="Offline"!==t;return(!this.options.Ku||!n)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Lu(e){if(e.docChanges.length>0)return!0;const t=this.Bu&&this.Bu.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}Uu(e){e=$a.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Fu=!0,this.Ou.next(e)}}class ec{constructor(e,t){this.Gu=e,this.byteLength=t}Qu(){return"metadata"in this.Gu}}class tc{constructor(e){this.serializer=e}rr(e){return fs(this.serializer,e)}ur(e){return e.metadata.exists?vs(this.serializer,e.document,!1):Ut.newNoDocument(this.rr(e.metadata.name),this.cr(e.metadata.readTime))}cr(e){return us(e)}}class nc{constructor(e,t,n){this.ju=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=rc(e)}zu(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.Gu.namedQuery)this.queries.push(e.Gu.namedQuery);else if(e.Gu.documentMetadata){this.documents.push({metadata:e.Gu.documentMetadata}),e.Gu.documentMetadata.exists||++t;const n=z.fromString(e.Gu.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.Gu.document&&(this.documents[this.documents.length-1].document=e.Gu.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}Wu(e){const t=new Map,n=new tc(this.serializer);for(const r of e)if(r.metadata.queries){const e=n.rr(r.metadata.name);for(const n of r.metadata.queries){const r=(t.get(n)||Hn()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=E(e);let i=Hn(),o=Un();for(const u of n){const e=t.rr(u.metadata.name);u.document&&(i=i.add(e));const n=t.ur(u);n.setReadTime(t.cr(u.metadata.readTime)),o=o.insert(e,n)}const a=s.Zi.newChangeBuffer({trackRemovals:!0}),c=await Ro(s,function(e){return Nn(En(z.fromString(`__bundle__/docs/${e}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",(e=>Ao(e,a,o).next((t=>(a.apply(e),t))).next((t=>s.Bs.removeMatchingKeysForTargetId(e,c.targetId).next((()=>s.Bs.addMatchingKeys(e,i,c.targetId))).next((()=>s.localDocuments.getLocalViewOfDocuments(e,t.nr,t.sr))).next((()=>t.nr))))))}(this.localStore,new tc(this.serializer),this.documents,this.ju.id),t=this.Wu(this.documents);for(const n of this.queries)await Po(this.localStore,n,t.get(n.name));return this.progress.taskState="Success",{progress:this.progress,Hu:this.collectionGroups,Ju:e}}}function rc(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class sc{constructor(e){this.key=e}}class ic{constructor(e){this.key=e}}class oc{constructor(e,t){this.query=e,this.Yu=t,this.Xu=null,this.hasCachedResults=!1,this.current=!1,this.Zu=Hn(),this.mutatedKeys=Hn(),this.tc=Ln(e),this.ec=new Ga(this.tc)}get nc(){return this.Yu}sc(e,t){const n=t?t.ic:new Ka,r=t?t.ec:this.ec;let s=t?t.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,c="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal(((e,t)=>{const u=r.get(e),l=Vn(this.query,t)?t:null,h=!!u&&this.mutatedKeys.has(u.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;u&&l?u.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.rc(u,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.tc(l,a)>0||c&&this.tc(l,c)<0)&&(o=!0)):!u&&l?(n.track({type:0,doc:l}),f=!0):u&&!l&&(n.track({type:1,doc:u}),f=!0,(a||c)&&(o=!0)),f&&(l?(i=i.add(l),s=d?s.add(e):s.delete(e)):(i=i.delete(e),s=s.delete(e)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const e="F"===this.query.limitType?i.last():i.first();i=i.delete(e.key),s=s.delete(e.key),n.track({type:1,doc:e})}return{ec:i,ic:n,zi:o,mutatedKeys:s}}rc(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){const r=this.ec;this.ec=e.ec,this.mutatedKeys=e.mutatedKeys;const s=e.ic.xu();s.sort(((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return v()}};return n(e)-n(t)}(e.type,t.type)||this.tc(e.doc,t.doc))),this.oc(n);const i=t?this.uc():[],o=0===this.Zu.size&&this.current?1:0,a=o!==this.Xu;return this.Xu=o,0!==s.length||a?{snapshot:new $a(this.query,e.ec,r,s,e.mutatedKeys,0===o,a,!1,!!n&&n.resumeToken.approximateByteSize()>0),cc:i}:{cc:i}}Mu(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({ec:this.ec,ic:new Ka,mutatedKeys:this.mutatedKeys,zi:!1},!1)):{cc:[]}}ac(e){return!this.Yu.has(e)&&!!this.ec.has(e)&&!this.ec.get(e).hasLocalMutations}oc(e){e&&(e.addedDocuments.forEach((e=>this.Yu=this.Yu.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.Yu=this.Yu.delete(e))),this.current=e.current)}uc(){if(!this.current)return[];const e=this.Zu;this.Zu=Hn(),this.ec.forEach((e=>{this.ac(e.key)&&(this.Zu=this.Zu.add(e.key))}));const t=[];return e.forEach((e=>{this.Zu.has(e)||t.push(new ic(e))})),this.Zu.forEach((n=>{e.has(n)||t.push(new sc(n))})),t}hc(e){this.Yu=e.ir,this.Zu=Hn();const t=this.sc(e.documents);return this.applyChanges(t,!0)}lc(){return $a.fromInitialDocuments(this.query,this.ec,this.mutatedKeys,0===this.Xu,this.hasCachedResults)}}class ac{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class cc{constructor(e){this.key=e,this.fc=!1}}class uc{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.dc={},this.wc=new Pn((e=>Rn(e)),kn),this._c=new Map,this.mc=new Set,this.gc=new Je($.comparator),this.yc=new Map,this.Ic=new ao,this.Tc={},this.Ec=new Map,this.Ac=Li.Mn(),this.onlineState="Unknown",this.vc=void 0}get isPrimaryClient(){return!0===this.vc}}async function lc(e,t){const n=Lc(e);let r,s;const i=n.wc.get(t);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.lc();else{const e=await Ro(n.localStore,Nn(t)),i=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,s=await hc(n,t,r,"current"===i,e.resumeToken),n.isPrimaryClient&&ga(n.remoteStore,e)}return s}async function hc(e,t,n,r,s){e.Rc=(t,n,r)=>async function(e,t,n,r){let s=t.view.sc(n);s.zi&&(s=await Vo(e.localStore,t.query,!1).then((({documents:e})=>t.view.sc(e,s))));const i=r&&r.targetChanges.get(t.targetId),o=t.view.applyChanges(s,e.isPrimaryClient,i);return Ec(e,t.targetId,o.cc),o.snapshot}(e,t,n,r);const i=await Vo(e.localStore,t,!0),o=new oc(t,i.ir),a=o.sc(i.documents),c=Qr.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,s),u=o.applyChanges(a,e.isPrimaryClient,c);Ec(e,n,u.cc);const l=new ac(t,n,o);return e.wc.set(t,l),e._c.has(n)?e._c.get(n).push(t):e._c.set(n,[t]),u.snapshot}async function dc(e,t){const n=E(e),r=n.wc.get(t),s=n._c.get(r.targetId);if(s.length>1)return n._c.set(r.targetId,s.filter((e=>!kn(e,t)))),void n.wc.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await Fo(n.localStore,r.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(r.targetId),pa(n.remoteStore,r.targetId),Ic(n,r.targetId)})).catch(re)):(Ic(n,r.targetId),await Fo(n.localStore,r.targetId,!0))}async function fc(e,t){const n=E(e);try{const e=await function(e,t){const n=E(e),r=t.snapshotVersion;let s=n.Ji;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const i=n.Zi.newChangeBuffer({trackRemovals:!0});s=n.Ji;const o=[];t.targetChanges.forEach(((i,a)=>{const c=s.get(a);if(!c)return;o.push(n.Bs.removeMatchingKeys(e,i.removedDocuments,a).next((()=>n.Bs.addMatchingKeys(e,i.addedDocuments,a))));let u=c.withSequenceNumber(e.currentSequenceNumber);null!==t.targetMismatches.get(a)?u=u.withResumeToken(at.EMPTY_BYTE_STRING,U.min()).withLastLimboFreeSnapshotVersion(U.min()):i.resumeToken.approximateByteSize()>0&&(u=u.withResumeToken(i.resumeToken,r)),s=s.insert(a,u),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(c,u,i)&&o.push(n.Bs.updateTargetData(e,u))}));let a=Un(),c=Hn();if(t.documentUpdates.forEach((r=>{t.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))})),o.push(Ao(e,i,t.documentUpdates).next((e=>{a=e.nr,c=e.sr}))),!r.isEqual(U.min())){const t=n.Bs.getLastRemoteSnapshotVersion(e).next((t=>n.Bs.setTargetsMetadata(e,e.currentSequenceNumber,r)));o.push(t)}return se.waitFor(o).next((()=>i.apply(e))).next((()=>n.localDocuments.getLocalViewOfDocuments(e,a,c))).next((()=>a))})).then((e=>(n.Ji=s,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const r=n.yc.get(t);r&&(I(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?r.fc=!0:e.modifiedDocuments.size>0?I(r.fc):e.removedDocuments.size>0&&(I(r.fc),r.fc=!1))})),await xc(n,e,t)}catch(e){await re(e)}}function mc(e,t,n){const r=E(e);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const e=[];r.wc.forEach(((n,r)=>{const s=r.view.Mu(t);s.snapshot&&e.push(s.snapshot)})),function(e,t){const n=E(e);n.onlineState=t;let r=!1;n.queries.forEach(((e,n)=>{for(const s of n.listeners)s.Mu(t)&&(r=!0)})),r&&Ja(n)}(r.eventManager,t),e.length&&r.dc.nu(e),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}async function gc(e,t,n){const r=E(e);r.sharedClientState.updateQueryState(t,"rejected",n);const s=r.yc.get(t),i=s&&s.key;if(i){let e=new Je($.comparator);e=e.insert(i,Ut.newNoDocument(i,U.min()));const n=Hn().add(i),s=new jr(U.min(),new Map,new Je(L),e,n);await fc(r,s),r.gc=r.gc.remove(i),r.yc.delete(t),Sc(r)}else await Fo(r.localStore,t,!1).then((()=>Ic(r,t,n))).catch(re)}async function pc(e,t){const n=E(e),r=t.batch.batchId;try{const e=await function(e,t){const n=E(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const r=t.batch.keys(),s=n.Zi.newChangeBuffer({trackRemovals:!0});return function(e,t,n,r){const s=n.batch,i=s.keys();let o=se.resolve();return i.forEach((e=>{o=o.next((()=>r.getEntry(t,e))).next((t=>{const i=n.docVersions.get(e);I(null!==i),t.version.compareTo(i)<0&&(s.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))}))})),o.next((()=>e.mutationQueue.removeMutationBatch(t,s)))}(n,e,t,s).next((()=>s.apply(e))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=Hn();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t)))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(n.localStore,t);vc(n,r,null),wc(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await xc(n,e)}catch(e){await re(e)}}async function yc(e,t,n){const r=E(e);try{const e=await function(e,t){const n=E(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next((t=>(I(null!==t),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t)))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(r.localStore,t);vc(r,t,n),wc(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await xc(r,e)}catch(n){await re(n)}}function wc(e,t){(e.Ec.get(t)||[]).forEach((e=>{e.resolve()})),e.Ec.delete(t)}function vc(e,t,n){const r=E(e);let s=r.Tc[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.Tc[r.currentUser.toKey()]=s}}function Ic(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e._c.get(t))e.wc.delete(r),n&&e.dc.Pc(r,n);e._c.delete(t),e.isPrimaryClient&&e.Ic.Is(t).forEach((t=>{e.Ic.containsKey(t)||bc(e,t)}))}function bc(e,t){e.mc.delete(t.path.canonicalString());const n=e.gc.get(t);null!==n&&(pa(e.remoteStore,n),e.gc=e.gc.remove(t),e.yc.delete(n),Sc(e))}function Ec(e,t,n){for(const r of n)r instanceof sc?(e.Ic.addReference(r.key,t),Tc(e,r)):r instanceof ic?(g("SyncEngine","Document no longer in limbo: "+r.key),e.Ic.removeReference(r.key,t),e.Ic.containsKey(r.key)||bc(e,r.key)):v()}function Tc(e,t){const n=t.key,r=n.path.canonicalString();e.gc.get(n)||e.mc.has(r)||(g("SyncEngine","New document in limbo: "+n),e.mc.add(r),Sc(e))}function Sc(e){for(;e.mc.size>0&&e.gc.size<e.maxConcurrentLimboResolutions;){const t=e.mc.values().next().value;e.mc.delete(t);const n=new $(z.fromString(t)),r=e.Ac.next();e.yc.set(r,new cc(n)),e.gc=e.gc.insert(n,r),ga(e.remoteStore,new Vs(Nn(En(n.path)),r,"TargetPurposeLimboResolution",pe.ct))}}async function xc(e,t,n){const r=E(e),s=[],i=[],o=[];r.wc.isEmpty()||(r.wc.forEach(((e,a)=>{o.push(r.Rc(a,t,n).then((e=>{if((e||n)&&r.isPrimaryClient&&r.sharedClientState.updateQueryState(a.targetId,(null==e?void 0:e.fromCache)?"not-current":"current"),e){s.push(e);const t=So.Li(a.targetId,e);i.push(t)}})))})),await Promise.all(o),r.dc.nu(s),await async function(e,t){const n=E(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>se.forEach(t,(t=>se.forEach(t.Fi,(r=>n.persistence.referenceDelegate.addReference(e,t.targetId,r))).next((()=>se.forEach(t.Bi,(r=>n.persistence.referenceDelegate.removeReference(e,t.targetId,r)))))))))}catch(e){if(!ue(e))throw e;g("LocalStore","Failed to update sequence numbers: "+e)}for(const r of t){const e=r.targetId;if(!r.fromCache){const t=n.Ji.get(e),r=t.snapshotVersion,s=t.withLastLimboFreeSnapshotVersion(r);n.Ji=n.Ji.insert(e,s)}}}(r.localStore,i))}async function _c(e,t){const n=E(e);if(!n.currentUser.isEqual(t)){g("SyncEngine","User change. New user:",t.toKey());const e=await No(n.localStore,t);n.currentUser=t,function(e,t){e.Ec.forEach((e=>{e.forEach((e=>{e.reject(new S(T.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),e.Ec.clear()}(n),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await xc(n,e.er)}}function Dc(e,t){const n=E(e),r=n.yc.get(t);if(r&&r.fc)return Hn().add(r.key);{let e=Hn();const r=n._c.get(t);if(!r)return e;for(const t of r){const r=n.wc.get(t);e=e.unionWith(r.view.nc)}return e}}async function Nc(e,t){const n=E(e),r=await Vo(n.localStore,t.query,!0),s=t.view.hc(r);return n.isPrimaryClient&&Ec(n,t.targetId,s.cc),s}async function Cc(e,t){const n=E(e);return Lo(n.localStore,t).then((e=>xc(n,e)))}async function Ac(e,t,n,r){const s=E(e),i=await function(e,t){const n=E(e),r=E(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(e=>r.Sn(e,t).next((t=>t?n.localDocuments.getDocuments(e,t):se.resolve(null)))))}(s.localStore,t);null!==i?("pending"===n?await Na(s.remoteStore):"acknowledged"===n||"rejected"===n?(vc(s,t,r||null),wc(s,t),function(e,t){E(E(e).mutationQueue).Cn(t)}(s.localStore,t)):v(),await xc(s,i)):g("SyncEngine","Cannot apply mutation batch with id: "+t)}async function kc(e,t,n){const r=E(e),s=[],i=[];for(const o of t){let e;const t=r._c.get(o);if(t&&0!==t.length){e=await Ro(r.localStore,Nn(t[0]));for(const e of t){const t=r.wc.get(e),n=await Nc(r,t);n.snapshot&&i.push(n.snapshot)}}else{const t=await Mo(r.localStore,o);e=await Ro(r.localStore,t),await hc(r,Rc(t),o,!1,e.resumeToken)}s.push(e)}return r.dc.nu(i),s}function Rc(e){return bn(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Fc(e){const t=E(e);return E(E(t.localStore).persistence).$i()}async function Vc(e,t,n,r){const s=E(e);if(s.vc)return void g("SyncEngine","Ignoring unexpected query state notification.");const i=s._c.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{const e=await Lo(s.localStore,Mn(i[0])),r=jr.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,at.EMPTY_BYTE_STRING);await xc(s,e,r);break}case"rejected":await Fo(s.localStore,t,!0),Ic(s,t,r);break;default:v()}}async function Mc(e,t,n){const r=Lc(e);if(r.vc){for(const e of t){if(r._c.has(e)){g("SyncEngine","Adding an already active target "+e);continue}const t=await Mo(r.localStore,e),n=await Ro(r.localStore,t);await hc(r,Rc(t),n.targetId,!1,n.resumeToken),ga(r.remoteStore,n)}for(const e of n)r._c.has(e)&&await Fo(r.localStore,e,!1).then((()=>{pa(r.remoteStore,e),Ic(r,e)})).catch(re)}}function Lc(e){const t=E(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=fc.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=Dc.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=gc.bind(null,t),t.dc.nu=Ya.bind(null,t.eventManager),t.dc.Pc=Xa.bind(null,t.eventManager),t}function Oc(e){const t=E(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=pc.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=yc.bind(null,t),t}class Pc{constructor(){this.synchronizeTabs=!1}async initialize(e){this.serializer=ia(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),await this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return Do(this.persistence,new xo,e.initialUser,this.serializer)}createPersistence(e){return new mo(po.zs,this.serializer)}createSharedClientState(e){return new Wo}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class qc extends Pc{constructor(e,t,n){super(),this.Vc=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Vc.initialize(this,e),await Oc(this.Vc.syncEngine),await Na(this.Vc.remoteStore),await this.persistence.Ii((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}createLocalStore(e){return Do(this.persistence,new xo,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){const n=this.persistence.referenceDelegate.garbageCollector;return new Gi(n,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){const n=new ge(t,this.persistence);return new me(e.asyncQueue,n)}createPersistence(e){const t=To(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Ni.withCacheSize(this.cacheSizeBytes):Ni.DEFAULT;return new Io(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,ra(),sa(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new Wo}}class Uc extends qc{constructor(e,t){super(e,t,!1),this.Vc=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);const t=this.Vc.syncEngine;this.sharedClientState instanceof Qo&&(this.sharedClientState.syncEngine={jr:Ac.bind(null,t),zr:Vc.bind(null,t),Wr:Mc.bind(null,t),$i:Fc.bind(null,t),Qr:Cc.bind(null,t)},await this.sharedClientState.start()),await this.persistence.Ii((async e=>{await async function(e,t){const n=E(e);if(Lc(n),Oc(n),!0===t&&!0!==n.vc){const e=n.sharedClientState.getAllActiveQueryTargets(),t=await kc(n,e.toArray());n.vc=!0,await Pa(n.remoteStore,!0);for(const r of t)ga(n.remoteStore,r)}else if(!1===t&&!1!==n.vc){const e=[];let t=Promise.resolve();n._c.forEach(((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?e.push(s):t=t.then((()=>(Ic(n,s),Fo(n.localStore,s,!0)))),pa(n.remoteStore,s)})),await t,await kc(n,e),function(e){const t=E(e);t.yc.forEach(((e,n)=>{pa(t.remoteStore,n)})),t.Ic.Ts(),t.yc=new Map,t.gc=new Je($.comparator)}(n),n.vc=!1,await Pa(n.remoteStore,!1)}}(this.Vc.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())}))}createSharedClientState(e){const t=ra();if(!Qo.D(t))throw new S(T.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=To(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new Qo(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class Bc{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>mc(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=_c.bind(null,this.syncEngine),await Pa(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new Qa}createDatastore(e){const t=ia(e.databaseInfo.databaseId),n=(r=e.databaseInfo,new na(r));var r;return function(e,t,n,r){return new la(e,t,n,r)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,s=e=>mc(this.syncEngine,e,0),i=Yo.D()?new Yo:new Ho,new da(t,n,r,s,i);var t,n,r,s,i}createSyncEngine(e,t){return function(e,t,n,r,s,i,o){const a=new uc(e,t,n,r,s,i);return o&&(a.vc=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=E(e);g("RemoteStore","RemoteStore shutting down."),t.vu.add(5),await ma(t),t.Pu.shutdown(),t.bu.set("Unknown")}(this.remoteStore)}}function zc(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){const r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class Gc{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Sc(this.observer.next,e)}error(e){this.observer.error?this.Sc(this.observer.error,e):p("Uncaught Error in snapshot listener:",e.toString())}Dc(){this.muted=!0}Sc(e,t){this.muted||setTimeout((()=>{this.muted||e(t)}),0)}}class Kc{constructor(e,t){this.Cc=e,this.serializer=t,this.metadata=new x,this.buffer=new Uint8Array,this.xc=new TextDecoder("utf-8"),this.Nc().then((e=>{e&&e.Qu()?this.metadata.resolve(e.Gu.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.Gu)}`))}),(e=>this.metadata.reject(e)))}close(){return this.Cc.cancel()}async getMetadata(){return this.metadata.promise}async bc(){return await this.getMetadata(),this.Nc()}async Nc(){const e=await this.kc();if(null===e)return null;const t=this.xc.decode(e),n=Number(t);isNaN(n)&&this.Mc(`length string (${t}) is not valid number`);const r=await this.$c(n);return new ec(JSON.parse(r),e.length+n)}Oc(){return this.buffer.findIndex((e=>e==="{".charCodeAt(0)))}async kc(){for(;this.Oc()<0&&!(await this.Fc()););if(0===this.buffer.length)return null;const e=this.Oc();e<0&&this.Mc("Reached the end of bundle when a length string is expected.");const t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async $c(e){for(;this.buffer.length<e;)await this.Fc()&&this.Mc("Reached the end of bundle when more is expected.");const t=this.xc.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Mc(e){throw this.Cc.cancel(),new Error(`Invalid bundle format: ${e}`)}async Fc(){const e=await this.Cc.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class $c{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new S(T.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const n=E(e),r=ps(n.serializer)+"/documents",s={documents:t.map((e=>ds(n.serializer,e)))},i=await n.vo("BatchGetDocuments",r,s,t.length),o=new Map;i.forEach((e=>{const t=function(e,t){return"found"in t?function(e,t){I(!!t.found),t.found.name,t.found.updateTime;const n=fs(e,t.found.name),r=us(t.found.updateTime),s=t.found.createTime?us(t.found.createTime):U.min(),i=new Pt({mapValue:{fields:t.found.fields}});return Ut.newFoundDocument(n,r,s,i)}(e,t):"missing"in t?function(e,t){I(!!t.missing),I(!!t.readTime);const n=fs(e,t.missing),r=us(t.readTime);return Ut.newNoDocument(n,r)}(e,t):v()}(n.serializer,e);o.set(t.key.toString(),t)}));const a=[];return t.forEach((e=>{const t=o.get(e.toString());I(!!t),a.push(t)})),a}(this.datastore,e);return t.forEach((e=>this.recordVersion(e))),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new Nr(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const e=this.readVersions;this.mutations.forEach((t=>{e.delete(t.key.toString())})),e.forEach(((e,t)=>{const n=$.fromPath(t);this.mutations.push(new Cr(n,this.precondition(n)))})),await async function(e,t){const n=E(e),r=ps(n.serializer)+"/documents",s={writes:t.map((e=>Is(n.serializer,e)))};await n.Io("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw v();t=U.min()}const n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new S(T.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(U.min())?gr.exists(!1):gr.updateTime(t):gr.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(U.min()))throw new S(T.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return gr.updateTime(t)}return gr.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class jc{constructor(e,t,n,r,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=s,this.Bc=n.maxAttempts,this.qo=new oa(this.asyncQueue,"transaction_retry")}run(){this.Bc-=1,this.Lc()}Lc(){this.qo.No((async()=>{const e=new $c(this.datastore),t=this.qc(e);t&&t.then((t=>{this.asyncQueue.enqueueAndForget((()=>e.commit().then((()=>{this.deferred.resolve(t)})).catch((e=>{this.Uc(e)}))))})).catch((e=>{this.Uc(e)}))}))}qc(e){try{const t=this.updateFunction(e);return!ye(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Uc(e){this.Bc>0&&this.Kc(e)?(this.Bc-=1,this.asyncQueue.enqueueAndForget((()=>(this.Lc(),Promise.resolve())))):this.deferred.reject(e)}Kc(e){if("FirebaseError"===e.name){const t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!Lr(t)}return!1}}class Qc{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=l.UNAUTHENTICATED,this.clientId=M.A(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async e=>{g("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>(g("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new S(T.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const e=new x;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=za(t,"Failed to shutdown persistence");e.reject(n)}})),e.promise}}async function Wc(e,t){e.asyncQueue.verifyOperationInProgress(),g("FirestoreClient","Initializing OfflineComponentProvider");const n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener((async e=>{r.isEqual(e)||(await No(t.localStore,e),r=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e._offlineComponents=t}async function Hc(e,t){e.asyncQueue.verifyOperationInProgress();const n=await Xc(e);g("FirestoreClient","Initializing OnlineComponentProvider");const r=await e.getConfiguration();await t.initialize(n,r),e.setCredentialChangeListener((e=>Oa(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>Oa(t.remoteStore,n))),e._onlineComponents=t}function Yc(e){return"FirebaseError"===e.name?e.code===T.FAILED_PRECONDITION||e.code===T.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}async function Xc(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){g("FirestoreClient","Using user provided OfflineComponentProvider");try{await Wc(e,e._uninitializedComponentsProvider._offline)}catch(t){const n=t;if(!Yc(n))throw n;y("Error using user provided cache. Falling back to memory cache: "+n),await Wc(e,new Pc)}}else g("FirestoreClient","Using default OfflineComponentProvider"),await Wc(e,new Pc);return e._offlineComponents}async function Jc(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(g("FirestoreClient","Using user provided OnlineComponentProvider"),await Hc(e,e._uninitializedComponentsProvider._online)):(g("FirestoreClient","Using default OnlineComponentProvider"),await Hc(e,new Bc))),e._onlineComponents}function Zc(e){return Xc(e).then((e=>e.persistence))}function eu(e){return Xc(e).then((e=>e.localStore))}function tu(e){return Jc(e).then((e=>e.remoteStore))}function nu(e){return Jc(e).then((e=>e.syncEngine))}function ru(e){return Jc(e).then((e=>e.datastore))}async function su(e){const t=await Jc(e),n=t.eventManager;return n.onListen=lc.bind(null,t.syncEngine),n.onUnlisten=dc.bind(null,t.syncEngine),n}function iu(e,t,n={}){const r=new x;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new Gc({next:i=>{t.enqueueAndForget((()=>Ha(e,o)));const a=i.docs.has(n);!a&&i.fromCache?s.reject(new S(T.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&r&&"server"===r.source?s.reject(new S(T.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(i)},error:e=>s.reject(e)}),o=new Za(En(n.path),i,{includeMetadataChanges:!0,Ku:!0});return Wa(e,o)}(await su(e),e.asyncQueue,t,n,r))),r.promise}function ou(e,t,n={}){const r=new x;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new Gc({next:n=>{t.enqueueAndForget((()=>Ha(e,o))),n.fromCache&&"server"===r.source?s.reject(new S(T.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:e=>s.reject(e)}),o=new Za(n,i,{includeMetadataChanges:!0,Ku:!0});return Wa(e,o)}(await su(e),e.asyncQueue,t,n,r))),r.promise}function au(e,t,n,r){const s=function(e,t){let n;return n="string"==typeof e?Ur().encode(e):e,function(e,t){return new Kc(e,t)}(function(e,t){if(e instanceof Uint8Array)return zc(e,t);if(e instanceof ArrayBuffer)return zc(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),t)}(n,ia(t));e.asyncQueue.enqueueAndForget((async()=>{!function(e,t,n){const r=E(e);(async function(e,t,n){try{const r=await t.getMetadata();if(await function(e,t){const n=E(e),r=us(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(e=>n.qs.getBundleMetadata(e,t.id))).then((e=>!!e&&e.createTime.compareTo(r)>=0))}(e.localStore,r))return await t.close(),n._completeWith(function(e){return{taskState:"Success",documentsLoaded:e.totalDocuments,bytesLoaded:e.totalBytes,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}(r)),Promise.resolve(new Set);n._updateProgress(rc(r));const s=new nc(r,e.localStore,t.serializer);let i=await t.bc();for(;i;){const e=await s.zu(i);e&&n._updateProgress(e),i=await t.bc()}const o=await s.complete();return await xc(e,o.Ju,void 0),await function(e,t){const n=E(e);return n.persistence.runTransaction("Save bundle","readwrite",(e=>n.qs.saveBundleMetadata(e,t)))}(e.localStore,r),n._completeWith(o.progress),Promise.resolve(o.Hu)}catch(e){return y("SyncEngine",`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(r,t,n).then((e=>{r.sharedClientState.notifyBundleLoaded(e)}))}(await nu(e),s,r)}))}function cu(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const uu=new Map;function lu(e,t,n){if(!n)throw new S(T.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function hu(e,t,n,r){if(!0===t&&!0===r)throw new S(T.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function du(e){if(!$.isDocumentKey(e))throw new S(T.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function fu(e){if($.isDocumentKey(e))throw new S(T.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function mu(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":v()}function gu(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new S(T.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=mu(e);throw new S(T.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function pu(e,t){if(t<=0)throw new S(T.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class yu{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new S(T.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.cache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new S(T.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}hu("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=cu(null!==(n=e.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new S(T.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new S(T.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new S(T.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams;var t,n}}class wu{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new yu({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new S(T.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new S(T.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new yu(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new D;switch(e.type){case"firstParty":return new k(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new S(T.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=uu.get(e);t&&(g("ComponentProvider","Removing Datastore"),uu.delete(e),t.terminate())}(this),Promise.resolve()}}function vu(e,t,n,r={}){var s;const i=(e=gu(e,wu))._getSettings(),a=`${t}:${n}`;if("firestore.googleapis.com"!==i.host&&i.host!==a&&y("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),e._setSettings(Object.assign(Object.assign({},i),{host:a,ssl:!1})),r.mockUserToken){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=l.MOCK_USER;else{t=(0,o.Sg)(r.mockUserToken,null===(s=e._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new S(T.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new l(i)}e._authCredentials=new N(new _(t,n))}}class Iu{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Eu(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Iu(this.firestore,e,this._key)}}class bu{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new bu(this.firestore,e,this._query)}}class Eu extends bu{constructor(e,t,n){super(e,t,En(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Iu(this.firestore,null,new $(e))}withConverter(e){return new Eu(this.firestore,e,this._path)}}function Tu(e,t,...n){if(e=(0,o.m9)(e),lu("collection","path",t),e instanceof wu){const r=z.fromString(t,...n);return fu(r),new Eu(e,null,r)}{if(!(e instanceof Iu||e instanceof Eu))throw new S(T.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(z.fromString(t,...n));return fu(r),new Eu(e.firestore,null,r)}}function Su(e,t){if(e=gu(e,wu),lu("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new S(T.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new bu(e,null,function(e){return new In(z.emptyPath(),e)}(t))}function xu(e,t,...n){if(e=(0,o.m9)(e),1===arguments.length&&(t=M.A()),lu("doc","path",t),e instanceof wu){const r=z.fromString(t,...n);return du(r),new Iu(e,null,new $(r))}{if(!(e instanceof Iu||e instanceof Eu))throw new S(T.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(z.fromString(t,...n));return du(r),new Iu(e.firestore,e instanceof Eu?e.converter:null,new $(r))}}function _u(e,t){return e=(0,o.m9)(e),t=(0,o.m9)(t),(e instanceof Iu||e instanceof Eu)&&(t instanceof Iu||t instanceof Eu)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function Du(e,t){return e=(0,o.m9)(e),t=(0,o.m9)(t),e instanceof bu&&t instanceof bu&&e.firestore===t.firestore&&kn(e._query,t._query)&&e.converter===t.converter}class Nu{constructor(){this.Gc=Promise.resolve(),this.Qc=[],this.jc=!1,this.zc=[],this.Wc=null,this.Hc=!1,this.Jc=!1,this.Yc=[],this.qo=new oa(this,"async_queue_retry"),this.Xc=()=>{const e=sa();e&&g("AsyncQueue","Visibility state changed to "+e.visibilityState),this.qo.Mo()};const e=sa();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Xc)}get isShuttingDown(){return this.jc}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Zc(),this.ta(e)}enterRestrictedMode(e){if(!this.jc){this.jc=!0,this.Jc=e||!1;const t=sa();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Xc)}}enqueue(e){if(this.Zc(),this.jc)return new Promise((()=>{}));const t=new x;return this.ta((()=>this.jc&&this.Jc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.Qc.push(e),this.ea())))}async ea(){if(0!==this.Qc.length){try{await this.Qc[0](),this.Qc.shift(),this.qo.reset()}catch(e){if(!ue(e))throw e;g("AsyncQueue","Operation failed with retryable error: "+e)}this.Qc.length>0&&this.qo.No((()=>this.ea()))}}ta(e){const t=this.Gc.then((()=>(this.Hc=!0,e().catch((e=>{this.Wc=e,this.Hc=!1;const t=function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e);throw p("INTERNAL UNHANDLED ERROR: ",t),e})).then((e=>(this.Hc=!1,e))))));return this.Gc=t,t}enqueueAfterDelay(e,t,n){this.Zc(),this.Yc.indexOf(e)>-1&&(t=0);const r=Ba.createAndSchedule(this,e,t,n,(e=>this.na(e)));return this.zc.push(r),r}Zc(){this.Wc&&v()}verifyOperationInProgress(){}async sa(){let e;do{e=this.Gc,await e}while(e!==this.Gc)}ia(e){for(const t of this.zc)if(t.timerId===e)return!0;return!1}ra(e){return this.sa().then((()=>{this.zc.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this.zc)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.sa()}))}oa(e){this.Yc.push(e)}na(e){const t=this.zc.indexOf(e);this.zc.splice(t,1)}}function Cu(e){return function(e,t){if("object"!=typeof e||null===e)return!1;const n=e;for(const r of["next","error","complete"])if(r in n&&"function"==typeof n[r])return!0;return!1}(e)}class Au{constructor(){this._progressObserver={},this._taskCompletionResolver=new x,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}const ku=-1;class Ru extends wu{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new Nu,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||Vu(this),this._firestoreClient.terminate()}}function Fu(e){return e._firestoreClient||Vu(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Vu(e){var t,n,r;const s=e._freezeSettings(),i=function(e,t,n,r){return new gt(e,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,cu(r.experimentalLongPollingOptions),r.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,s);e._firestoreClient=new Qc(e._authCredentials,e._appCheckCredentials,e._queue,i),(null===(n=s.cache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(r=s.cache)||void 0===r?void 0:r._onlineComponentProvider)&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:s.cache.kind,_offline:s.cache._offlineComponentProvider,_online:s.cache._onlineComponentProvider})}function Mu(e,t){Ku(e=gu(e,Ru));const n=Fu(e);if(n._uninitializedComponentsProvider)throw new S(T.FAILED_PRECONDITION,"SDK cache is already specified.");y("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const r=e._freezeSettings(),s=new Bc;return Ou(n,s,new qc(s,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}function Lu(e){Ku(e=gu(e,Ru));const t=Fu(e);if(t._uninitializedComponentsProvider)throw new S(T.FAILED_PRECONDITION,"SDK cache is already specified.");y("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const n=e._freezeSettings(),r=new Bc;return Ou(t,r,new Uc(r,n.cacheSizeBytes))}function Ou(e,t,n){const r=new x;return e.asyncQueue.enqueue((async()=>{try{await Wc(e,n),await Hc(e,t),r.resolve()}catch(e){const n=e;if(!Yc(n))throw n;y("Error enabling indexeddb cache. Falling back to memory cache: "+n),r.reject(n)}})).then((()=>r.promise))}function Pu(e){if(e._initialized&&!e._terminated)throw new S(T.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new x;return e._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(e){if(!oe.D())return Promise.resolve();const t=e+"main";await oe.delete(t)}(To(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}})),t.promise}function qu(e){return function(e){const t=new x;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t){const n=E(e);ba(n.remoteStore)||g("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(e){const t=E(e);return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e)))}(n.localStore);if(-1===e)return void t.resolve();const r=n.Ec.get(e)||[];r.push(t),n.Ec.set(e,r)}catch(e){const n=za(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await nu(e),t))),t.promise}(Fu(e=gu(e,Ru)))}function Uu(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await Zc(e),n=await tu(e);return t.setNetworkEnabled(!0),function(e){const t=E(e);return t.vu.delete(0),fa(t)}(n)}))}(Fu(e=gu(e,Ru)))}function Bu(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await Zc(e),n=await tu(e);return t.setNetworkEnabled(!1),async function(e){const t=E(e);t.vu.add(0),await ma(t),t.bu.set("Offline")}(n)}))}(Fu(e=gu(e,Ru)))}function zu(e,t){const n=Fu(e=gu(e,Ru)),r=new Au;return au(n,e._databaseId,t,r),r}function Gu(e,t){return function(e,t){return e.asyncQueue.enqueue((async()=>function(e,t){const n=E(e);return n.persistence.runTransaction("Get named query","readonly",(e=>n.qs.getNamedQuery(e,t)))}(await eu(e),t)))}(Fu(e=gu(e,Ru)),t).then((t=>t?new bu(e,null,t.query):null))}function Ku(e){if(e._initialized||e._terminated)throw new S(T.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class $u{constructor(e){this._byteString=e}static fromBase64String(e){try{return new $u(at.fromBase64String(e))}catch(e){throw new S(T.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new $u(at.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class ju{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new S(T.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new K(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class Qu{constructor(e){this._methodName=e}}class Wu{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new S(T.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new S(T.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return L(this._lat,e._lat)||L(this._long,e._long)}}const Hu=/^__.*__$/;class Yu{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new Sr(e,this.data,this.fieldMask,t,this.fieldTransforms):new Tr(e,this.data,t,this.fieldTransforms)}}class Xu{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new Sr(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function Ju(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw v()}}class Zu{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===s&&this.ua(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get ca(){return this.settings.ca}aa(e){return new Zu(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ha(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.aa({path:n,la:!1});return r.fa(e),r}da(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.aa({path:n,la:!1});return r.ua(),r}wa(e){return this.aa({path:void 0,la:!0})}_a(e){return vl(e,this.settings.methodName,this.settings.ma||!1,this.path,this.settings.ga)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}ua(){if(this.path)for(let e=0;e<this.path.length;e++)this.fa(this.path.get(e))}fa(e){if(0===e.length)throw this._a("Document fields must not be empty");if(Ju(this.ca)&&Hu.test(e))throw this._a('Document fields cannot begin and end with "__"')}}class el{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||ia(e)}ya(e,t,n,r=!1){return new Zu({ca:e,methodName:t,ga:n,path:K.emptyPath(),la:!1,ma:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function tl(e){const t=e._freezeSettings(),n=ia(e._databaseId);return new el(e._databaseId,!!t.ignoreUndefinedProperties,n)}function nl(e,t,n,r,s,i={}){const o=e.ya(i.merge||i.mergeFields?2:0,t,n,s);gl("Data must be an object, but it was:",o,r);const a=fl(r,o);let c,u;if(i.merge)c=new st(o.fieldMask),u=o.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=pl(t,r,n);if(!o.contains(s))throw new S(T.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);Il(e,s)||e.push(s)}c=new st(e),u=o.fieldTransforms.filter((e=>c.covers(e.field)))}else c=null,u=o.fieldTransforms;return new Yu(new Pt(a),c,u)}class rl extends Qu{_toFieldTransform(e){if(2!==e.ca)throw 1===e.ca?e._a(`${this._methodName}() can only appear at the top level of your update data`):e._a(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof rl}}function sl(e,t,n){return new Zu({ca:3,ga:t.settings.ga,methodName:e._methodName,la:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class il extends Qu{_toFieldTransform(e){return new fr(e.path,new ir)}isEqual(e){return e instanceof il}}class ol extends Qu{constructor(e,t){super(e),this.pa=t}_toFieldTransform(e){const t=sl(this,e,!0),n=this.pa.map((e=>dl(e,t))),r=new or(n);return new fr(e.path,r)}isEqual(e){return this===e}}class al extends Qu{constructor(e,t){super(e),this.pa=t}_toFieldTransform(e){const t=sl(this,e,!0),n=this.pa.map((e=>dl(e,t))),r=new cr(n);return new fr(e.path,r)}isEqual(e){return this===e}}class cl extends Qu{constructor(e,t){super(e),this.Ia=t}_toFieldTransform(e){const t=new lr(e.serializer,er(e.serializer,this.Ia));return new fr(e.path,t)}isEqual(e){return this===e}}function ul(e,t,n,r){const s=e.ya(1,t,n);gl("Data must be an object, but it was:",s,r);const i=[],a=Pt.empty();Ye(r,((e,r)=>{const c=wl(t,e,n);r=(0,o.m9)(r);const u=s.da(c);if(r instanceof rl)i.push(c);else{const e=dl(r,u);null!=e&&(i.push(c),a.set(c,e))}}));const c=new st(i);return new Xu(a,c,s.fieldTransforms)}function ll(e,t,n,r,s,i){const a=e.ya(1,t,n),c=[pl(t,r,n)],u=[s];if(i.length%2!=0)throw new S(T.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let o=0;o<i.length;o+=2)c.push(pl(t,i[o])),u.push(i[o+1]);const l=[],h=Pt.empty();for(let f=c.length-1;f>=0;--f)if(!Il(l,c[f])){const e=c[f];let t=u[f];t=(0,o.m9)(t);const n=a.da(e);if(t instanceof rl)l.push(e);else{const r=dl(t,n);null!=r&&(l.push(e),h.set(e,r))}}const d=new st(l);return new Xu(h,d,a.fieldTransforms)}function hl(e,t,n,r=!1){return dl(n,e.ya(r?4:3,t))}function dl(e,t){if(ml(e=(0,o.m9)(e)))return gl("Unsupported field value:",t,e),fl(e,t);if(e instanceof Qu)return function(e,t){if(!Ju(t.ca))throw t._a(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t._a(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.la&&4!==t.ca)throw t._a("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const s of e){let e=dl(s,t.wa(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=(0,o.m9)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return er(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=q.fromDate(e);return{timestampValue:os(t.serializer,n)}}if(e instanceof q){const n=new q(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:os(t.serializer,n)}}if(e instanceof Wu)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof $u)return{bytesValue:as(t.serializer,e._byteString)};if(e instanceof Iu){const n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t._a(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:ls(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t._a(`Unsupported field value: ${mu(e)}`)}(e,t)}function fl(e,t){const n={};return Xe(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):Ye(e,((e,r)=>{const s=dl(r,t.ha(e));null!=s&&(n[e]=s)})),{mapValue:{fields:n}}}function ml(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof q||e instanceof Wu||e instanceof $u||e instanceof Iu||e instanceof Qu)}function gl(e,t,n){if(!ml(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const r=mu(n);throw"an object"===r?t._a(e+" a custom object"):t._a(e+" "+r)}}function pl(e,t,n){if((t=(0,o.m9)(t))instanceof ju)return t._internalPath;if("string"==typeof t)return wl(e,t);throw vl("Field path arguments must be of type string or ",e,!1,void 0,n)}const yl=new RegExp("[~\\*/\\[\\]]");function wl(e,t,n){if(t.search(yl)>=0)throw vl(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new ju(...t.split("."))._internalPath}catch(r){throw vl(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function vl(e,t,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(i||o)&&(c+=" (found",i&&(c+=` in field ${r}`),o&&(c+=` in document ${s}`),c+=")"),new S(T.INVALID_ARGUMENT,a+e+c)}function Il(e,t){return e.some((e=>e.isEqual(t)))}class bl{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Iu(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new El(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(Tl("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class El extends bl{data(){return super.data()}}function Tl(e,t){return"string"==typeof t?wl(e,t):t instanceof ju?t._internalPath:t._delegate._internalPath}function Sl(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new S(T.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class xl{}class _l extends xl{}function Dl(e,t,...n){let r=[];t instanceof xl&&r.push(t),r=r.concat(n),function(e){const t=e.filter((e=>e instanceof Al)).length,n=e.filter((e=>e instanceof Nl)).length;if(t>1||t>0&&n>0)throw new S(T.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const s of r)e=s._apply(e);return e}class Nl extends _l{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new Nl(e,t,n)}_apply(e){const t=this._parse(e);return $l(e._query,t),new bu(e.firestore,e.converter,Cn(e._query,t))}_parse(e){const t=tl(e.firestore),n=function(e,t,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new S(T.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){Kl(o,i);const t=[];for(const n of o)t.push(Gl(r,e,n));a={arrayValue:{values:t}}}else a=Gl(r,e,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||Kl(o,i),a=hl(n,"where",o,"in"===i||"not-in"===i);return Qt.create(s,i,a)}(e._query,0,t,e.firestore._databaseId,this._field,this._op,this._value);return n}}function Cl(e,t,n){const r=t,s=Tl("where",e);return Nl._create(s,r,n)}class Al extends xl{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new Al(e,t)}_parse(e){const t=this._queryConstraints.map((t=>t._parse(e))).filter((e=>e.getFilters().length>0));return 1===t.length?t[0]:Wt.create(t,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;const r=t.getFlattenedFilters();for(const s of r)$l(n,s),n=Cn(n,s)}(e._query,t),new bu(e.firestore,e.converter,Cn(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class kl extends _l{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new kl(e,t)}_apply(e){const t=function(e,t,n){if(null!==e.startAt)throw new S(T.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new S(T.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const r=new Kt(t,n);return function(e,t){if(null===Sn(e)){const n=xn(e);null!==n&&jl(e,n,t.field)}}(e,r),r}(e._query,this._field,this._direction);return new bu(e.firestore,e.converter,function(e,t){const n=e.explicitOrderBy.concat([t]);return new In(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}function Rl(e,t="asc"){const n=t,r=Tl("orderBy",e);return kl._create(r,n)}class Fl extends _l{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new Fl(e,t,n)}_apply(e){return new bu(e.firestore,e.converter,An(e._query,this._limit,this._limitType))}}function Vl(e){return pu("limit",e),Fl._create("limit",e,"F")}function Ml(e){return pu("limitToLast",e),Fl._create("limitToLast",e,"L")}class Ll extends _l{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Ll(e,t,n)}_apply(e){const t=zl(e,this.type,this._docOrFields,this._inclusive);return new bu(e.firestore,e.converter,function(e,t){return new In(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)}(e._query,t))}}function Ol(...e){return Ll._create("startAt",e,!0)}function Pl(...e){return Ll._create("startAfter",e,!1)}class ql extends _l{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new ql(e,t,n)}_apply(e){const t=zl(e,this.type,this._docOrFields,this._inclusive);return new bu(e.firestore,e.converter,function(e,t){return new In(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)}(e._query,t))}}function Ul(...e){return ql._create("endBefore",e,!1)}function Bl(...e){return ql._create("endAt",e,!0)}function zl(e,t,n,r){if(n[0]=(0,o.m9)(n[0]),n[0]instanceof bl)return function(e,t,n,r,s){if(!r)throw new S(T.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const o of Dn(e))if(o.field.isKeyField())i.push(_t(t,r.key));else{const e=r.data.field(o.field);if(dt(e))throw new S(T.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+o.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=o.field.canonicalString();throw new S(T.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new Bt(i,s)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{const s=tl(e.firestore);return function(e,t,n,r,s,i){const o=e.explicitOrderBy;if(s.length>o.length)throw new S(T.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let c=0;c<s.length;c++){const i=s[c];if(o[c].field.isKeyField()){if("string"!=typeof i)throw new S(T.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof i}`);if(!_n(e)&&-1!==i.indexOf("/"))throw new S(T.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${i}' contains a slash.`);const n=e.path.child(z.fromString(i));if(!$.isDocumentKey(n))throw new S(T.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new $(n);a.push(_t(t,s))}else{const e=hl(n,r,i);a.push(e)}}return new Bt(a,i)}(e._query,e.firestore._databaseId,s,t,n,r)}}function Gl(e,t,n){if("string"==typeof(n=(0,o.m9)(n))){if(""===n)throw new S(T.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!_n(t)&&-1!==n.indexOf("/"))throw new S(T.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=t.path.child(z.fromString(n));if(!$.isDocumentKey(r))throw new S(T.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return _t(e,new $(r))}if(n instanceof Iu)return _t(e,n._key);throw new S(T.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${mu(n)}.`)}function Kl(e,t){if(!Array.isArray(e)||0===e.length)throw new S(T.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function $l(e,t){if(t.isInequality()){const n=xn(e),r=t.field;if(null!==n&&!n.isEqual(r))throw new S(T.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${r.toString()}'`);const s=Sn(e);null!==s&&jl(e,r,s)}const n=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new S(T.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new S(T.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}function jl(e,t,n){if(!n.isEqual(t))throw new S(T.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class Ql{convertValue(e,t="none"){switch(vt(e)){case 0:return null;case 1:return e.booleanValue;case 2:return lt(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(ht(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw v()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){const n={};return Ye(e,((e,r)=>{n[e]=this.convertValue(r,t)})),n}convertGeoPoint(e){return new Wu(lt(e.latitude),lt(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const n=ft(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(mt(e));default:return null}}convertTimestamp(e){const t=ut(e);return new q(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=z.fromString(e);I(Fs(n));const r=new pt(n.get(1),n.get(3)),s=new $(n.popFirst(5));return r.isEqual(t)||p(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function Wl(e,t,n){let r;return r=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,r}class Hl extends Ql{constructor(e){super(),this.firestore=e}convertBytes(e){return new $u(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Iu(this.firestore,null,t)}}class Yl{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Xl extends bl{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new Jl(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(Tl("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class Jl extends Xl{data(e={}){return super.data(e)}}class Zl{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Yl(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach((t=>e.push(t))),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach((n=>{e.call(t,new Jl(this._firestore,this._userDataWriter,n.key,n,new Yl(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new S(T.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map((n=>{const r=new Jl(e._firestore,e._userDataWriter,n.doc.key,n.doc,new Yl(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}}))}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((e=>t||3!==e.type)).map((t=>{const r=new Jl(e._firestore,e._userDataWriter,t.doc.key,t.doc,new Yl(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let s=-1,i=-1;return 0!==t.type&&(s=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),i=n.indexOf(t.doc.key)),{type:eh(t.type),doc:r,oldIndex:s,newIndex:i}}))}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function eh(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return v()}}function th(e,t){return e instanceof Xl&&t instanceof Xl?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof Zl&&t instanceof Zl&&e._firestore===t._firestore&&Du(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function nh(e){e=gu(e,Iu);const t=gu(e.firestore,Ru);return iu(Fu(t),e._key).then((n=>ph(t,e,n)))}class rh extends Ql{constructor(e){super(),this.firestore=e}convertBytes(e){return new $u(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Iu(this.firestore,null,t)}}function sh(e){e=gu(e,Iu);const t=gu(e.firestore,Ru),n=Fu(t),r=new rh(t);return function(e,t){const n=new x;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await function(e,t){const n=E(e);return n.persistence.runTransaction("read document","readonly",(e=>n.localDocuments.getDocument(e,t)))}(e,t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new S(T.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){const r=za(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await eu(e),t,n))),n.promise}(n,e._key).then((n=>new Xl(t,r,e._key,n,new Yl(null!==n&&n.hasLocalMutations,!0),e.converter)))}function ih(e){e=gu(e,Iu);const t=gu(e.firestore,Ru);return iu(Fu(t),e._key,{source:"server"}).then((n=>ph(t,e,n)))}function oh(e){e=gu(e,bu);const t=gu(e.firestore,Ru),n=Fu(t),r=new rh(t);return Sl(e._query),ou(n,e._query).then((n=>new Zl(t,r,e,n)))}function ah(e){e=gu(e,bu);const t=gu(e.firestore,Ru),n=Fu(t),r=new rh(t);return function(e,t){const n=new x;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await Vo(e,t,!0),s=new oc(t,r.ir),i=s.sc(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(e){const r=za(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await eu(e),t,n))),n.promise}(n,e._query).then((n=>new Zl(t,r,e,n)))}function ch(e){e=gu(e,bu);const t=gu(e.firestore,Ru),n=Fu(t),r=new rh(t);return ou(n,e._query,{source:"server"}).then((n=>new Zl(t,r,e,n)))}function uh(e,t,n){e=gu(e,Iu);const r=gu(e.firestore,Ru),s=Wl(e.converter,t,n);return gh(r,[nl(tl(r),"setDoc",e._key,s,null!==e.converter,n).toMutation(e._key,gr.none())])}function lh(e,t,n,...r){e=gu(e,Iu);const s=gu(e.firestore,Ru),i=tl(s);let a;return a="string"==typeof(t=(0,o.m9)(t))||t instanceof ju?ll(i,"updateDoc",e._key,t,n,r):ul(i,"updateDoc",e._key,t),gh(s,[a.toMutation(e._key,gr.exists(!0))])}function hh(e){return gh(gu(e.firestore,Ru),[new Nr(e._key,gr.none())])}function dh(e,t){const n=gu(e.firestore,Ru),r=xu(e),s=Wl(e.converter,t);return gh(n,[nl(tl(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,gr.exists(!1))]).then((()=>r))}function fh(e,...t){var n,r,s;e=(0,o.m9)(e);let i={includeMetadataChanges:!1},a=0;"object"!=typeof t[a]||Cu(t[a])||(i=t[a],a++);const c={includeMetadataChanges:i.includeMetadataChanges};if(Cu(t[a])){const e=t[a];t[a]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[a+1]=null===(r=e.error)||void 0===r?void 0:r.bind(e),t[a+2]=null===(s=e.complete)||void 0===s?void 0:s.bind(e)}let u,l,h;if(e instanceof Iu)l=gu(e.firestore,Ru),h=En(e._key.path),u={next:n=>{t[a]&&t[a](ph(l,e,n))},error:t[a+1],complete:t[a+2]};else{const n=gu(e,bu);l=gu(n.firestore,Ru),h=n._query;const r=new rh(l);u={next:e=>{t[a]&&t[a](new Zl(l,r,n,e))},error:t[a+1],complete:t[a+2]},Sl(e._query)}return function(e,t,n,r){const s=new Gc(r),i=new Za(t,s,n);return e.asyncQueue.enqueueAndForget((async()=>Wa(await su(e),i))),()=>{s.Dc(),e.asyncQueue.enqueueAndForget((async()=>Ha(await su(e),i)))}}(Fu(l),h,c,u)}function mh(e,t){return function(e,t){const n=new Gc(t);return e.asyncQueue.enqueueAndForget((async()=>function(e,t){E(e).ku.add(t),t.next()}(await su(e),n))),()=>{n.Dc(),e.asyncQueue.enqueueAndForget((async()=>function(e,t){E(e).ku.delete(t)}(await su(e),n)))}}(Fu(e=gu(e,Ru)),Cu(t)?t:{next:t})}function gh(e,t){return function(e,t){const n=new x;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const r=Oc(e);try{const e=await function(e,t){const n=E(e),r=q.now(),s=t.reduce(((e,t)=>e.add(t.key)),Hn());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>{let a=Un(),c=Hn();return n.Zi.getEntries(e,s).next((e=>{a=e,a.forEach(((e,t)=>{t.isValidDocument()||(c=c.add(e))}))})).next((()=>n.localDocuments.getOverlayedDocuments(e,a))).next((s=>{i=s;const o=[];for(const e of t){const t=br(e,i.get(e.key).overlayedDocument);null!=t&&o.push(new Sr(e.key,t,qt(t.value.mapValue),gr.exists(!0)))}return n.mutationQueue.addMutationBatch(e,r,o,t)})).next((t=>{o=t;const r=t.applyToLocalDocumentSet(i,c);return n.documentOverlayCache.saveOverlays(e,t.batchId,r)}))})).then((()=>({batchId:o.batchId,changes:Gn(i)})))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.Tc[e.currentUser.toKey()];r||(r=new Je(L)),r=r.insert(t,n),e.Tc[e.currentUser.toKey()]=r}(r,e.batchId,n),await xc(r,e.changes),await Na(r.remoteStore)}catch(e){const t=za(e,"Failed to persist write");n.reject(t)}}(await nu(e),t,n))),n.promise}(Fu(e),t)}function ph(e,t,n){const r=n.docs.get(t._key),s=new rh(e);return new Xl(e,s,t._key,r,new Yl(n.hasPendingWrites,n.fromCache),t.converter)}const yh={maxAttempts:5};class wh{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=tl(e)}set(e,t,n){this._verifyNotCommitted();const r=vh(e,this._firestore),s=Wl(r.converter,t,n),i=nl(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,gr.none())),this}update(e,t,n,...r){this._verifyNotCommitted();const s=vh(e,this._firestore);let i;return i="string"==typeof(t=(0,o.m9)(t))||t instanceof ju?ll(this._dataReader,"WriteBatch.update",s._key,t,n,r):ul(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,gr.exists(!0))),this}delete(e){this._verifyNotCommitted();const t=vh(e,this._firestore);return this._mutations=this._mutations.concat(new Nr(t._key,gr.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new S(T.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function vh(e,t){if((e=(0,o.m9)(e)).firestore!==t)throw new S(T.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class Ih extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=tl(e)}get(e){const t=vh(e,this._firestore),n=new Hl(this._firestore);return this._transaction.lookup([t._key]).then((e=>{if(!e||1!==e.length)return v();const r=e[0];if(r.isFoundDocument())return new bl(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new bl(this._firestore,n,t._key,null,t.converter);throw v()}))}set(e,t,n){const r=vh(e,this._firestore),s=Wl(r.converter,t,n),i=nl(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(e,t,n,...r){const s=vh(e,this._firestore);let i;return i="string"==typeof(t=(0,o.m9)(t))||t instanceof ju?ll(this._dataReader,"Transaction.update",s._key,t,n,r):ul(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){const t=vh(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=vh(e,this._firestore),n=new rh(this._firestore);return super.get(e).then((e=>new Xl(this._firestore,n,t._key,e._document,new Yl(!1,!1),t.converter)))}}function bh(e,t,n){e=gu(e,Ru);const r=Object.assign(Object.assign({},yh),n);return function(e){if(e.maxAttempts<1)throw new S(T.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(e,t,n){const r=new x;return e.asyncQueue.enqueueAndForget((async()=>{const s=await ru(e);new jc(e.asyncQueue,s,n,t,r).run()})),r.promise}(Fu(e),(n=>t(new Ih(e,n))),r)}function Eh(){return new rl("deleteField")}function Th(){return new il("serverTimestamp")}function Sh(...e){return new ol("arrayUnion",e)}function xh(...e){return new al("arrayRemove",e)}function _h(e){return new cl("increment",e)}!function(e,t=!0){!function(e){h=e}(r.SDK_VERSION),(0,r._registerComponent)(new s.wA("firestore",((e,{instanceIdentifier:n,options:r})=>{const s=e.getProvider("app").getImmediate(),i=new Ru(new C(e.getProvider("auth-internal")),new F(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new S(T.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new pt(e.options.projectId,t)}(s,n),s);return r=Object.assign({useFetchStreams:t},r),i._setSettings(r),i}),"PUBLIC").setMultipleInstances(!0)),(0,r.registerVersion)(u,"3.13.0",e),(0,r.registerVersion)(u,"3.13.0","esm2017")}()}}]);